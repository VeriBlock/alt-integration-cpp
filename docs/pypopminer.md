# pypopminer {#pypopminer}

`pypopminer` is a Python3 package, generated by `boost-python`, which contains MockMiner - data structure, which can mock out VeriBlock + Bitcoin + APM (Altchain POP Miner) completely. 

Use it to generate endorsements of VBK in BTC, and ALT in VBK; generate VBK/BTC blocks with or without endorsements.

### 0. Install dependencies

`pypopminer` depends on [`boost-python`](https://www.boost.org/doc/libs/1_74_0/libs/python/doc/html/building.html), `python3-dev`.

### 1. Install pypopminer and `alt-cpp` library

```bash
git clone https://github.com/VeriBlock/alt-integration-cpp
cd alt-integration-cpp
mkdir build
cd build
cmake .. -DWITH_PYPOPMINER=ON -DCMAKE_BUILD_TYPE=Release -DTESTING=OFF
make -j
sudo make install
```

You should see these lines (or similar):
```
-- Installing: /root/.local/lib/python3.6/site-packages/pypopminer/pypopminer.so
-- Installing: /root/.local/lib/python3.6/site-packages/pypopminer/__init__.py
```

### 2. Build Altchain

We build [vBTC](https://github.com/VeriBlock/vbk-ri-btc/) for example:

```bash
git clone https://github.com/VeriBlock/vbk-ri-btc
cd vbk-ri-btc
./autogen.sh
./configure --without-gui --disable-bench --disable-tests
make -j
# no need to make install
```

### 3. Run functional tests

```sh
cd test/functional
# run all tests
./test_runner.py

# run specific test
./feature_pop_fork_resolution.py

# enable debug logger, enable RPC tracing
./feature_pop_fork_resolution.py --tracerpc -l DEBUG

# wanna see node's logs after test crashed?
# run test with flag --nocleanup
# after test run, look at test run id, it looks like this --vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
2020-07-22T20:15:38.725000Z ... Initializing test directory /tmp/bitcoin_func_test_uqgiab8_
# it is random, for every run
$ cd /tmp/bitcoin_func_test_uqgiab8_
/tmp/bitcoin_func_test_qbjor7qu Â» ls -la
total 8
drwx------  6 user user  140 jul 22 23:17 .
drwxrwxrwt 24 root root 1040 jul 22 23:17 ..
drwxr-xr-x  5 user user  120 jul 22 23:17 node0
drwxr-xr-x  5 user user  120 jul 22 23:17 node1
drwxr-xr-x  5 user user  120 jul 22 23:17 node2
drwxr-xr-x  5 user user  120 jul 22 23:17 node3
-rw-r--r--  1 user user 4298 jul 22 23:18 test_framework.log
# then, you can see all datadirs of each node from the test, including its debug.log and vbitcoin.conf
```

### 4. Write functional tests

1. Create new file, name it `feature_pop_<TESTNAME>.py`
2. Copy content of one of `feature_pop_*.py` files 
3. Rename test, modify it for your specific case

A few tips:
- Use `endorse_block` function to endorse alt block. 
- Use `node.getblock(node.getbestblockhash())` to get all info about best block
- Use `node.generate(nblocks=100)` to generate 100 blocks after current tip.
- Use `self.sync_blocks(self.nodes, timeout=20)` to wait 20 sec until all nodes sync their blocks. Same with `self.sync_pop_mempools` and `self.sync_mempools`
- To call **any** rpc, just specify its name as python function: `node.<rpc>()`. Example: `node.getbtcbestblockhash()`
- See [pypopminer docs for examples with pypopminer](https://github.com/VeriBlock/alt-integration-cpp/tree/master/pypopminer).
- To see **all** docs for pypopminer, see [source code](https://github.com/VeriBlock/alt-integration-cpp/blob/master/pypopminer/src/miner.cpp#L230)
- To increase alt-cpp verbosity, use arg `-poplogverbosity=debug`

### List of useful rpc calls:
```
- get{btc,vbk}bestblockhash -> hex hash of best block
- get{btc,vbk}block <hash> -> block data
- get{btc,vbk}blockhash <height> -> hash
- getblock <hash> -> altchain block
- getbestblockhash -> altchain's best block hash
- getraw{atv,vtb,vbkblock} <id:hex> <verbosity:int> <containing block hash:hex> -> {atv,vtb,vbkblock} data - containing block is optional, if entity is in mempool
- getrawpopmempool -> list of IDs of entities stored in pop mempool
- generate <num> -> mine num blocks on top of current tip
- getpopdata <height:int> -> get input data for APM
- submitpop <vbkblocks:hexlist> <vtbs:hexlist> <atvs:hexlist> -> submit pop data 
```
