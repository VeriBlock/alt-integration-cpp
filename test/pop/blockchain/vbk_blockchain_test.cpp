// Copyright (c) 2019-2022 Xenios SEZC
// https://www.veriblock.org
// Distributed under the MIT software license, see the accompanying
// file LICENSE or http://www.opensource.org/licenses/mit-license.php.

#include <gtest/gtest.h>

#include <memory>
#include <veriblock/pop/blockchain/blocktree.hpp>
#include <veriblock/pop/blockchain/pop/vbk_block_tree.hpp>
#include <veriblock/pop/literals.hpp>
#include <veriblock/pop/storage/adaptors/block_provider_impl.hpp>
#include <veriblock/pop/storage/adaptors/inmem_storage_impl.hpp>
#include <veriblock/pop/storage/adaptors/payloads_provider_impl.hpp>

#include "block_headers.hpp"

using namespace altintegration;

struct BtcInvalidationTest {
  using block_t = VbkBlock;
  using param_t = VbkChainParams;
  using index_t = typename BlockTree<block_t, param_t>::index_t;
  using height_t = typename BlockTree<block_t, param_t>::height_t;
  using hash_t = typename BlockTree<block_t, param_t>::hash_t;

  ValidationState state;

  AltChainParamsRegTest altparam;
  BtcChainParamsRegTest btcparam;
  VbkChainParamsRegTest vbkparam;
  adaptors::InmemStorageImpl storage{};
  adaptors::PayloadsStorageImpl payloadsProvider{storage};
  adaptors::BlockReaderImpl blockProvider{storage, altparam};
  PayloadsIndex payloadsIndex;
};

TEST(VbkBlocksTest, basic_test1) {
  std::vector<VbkBlock> blocks;

  std::vector<std::string> hex_blocks = {
      "001571450002DC17D1D9F25F68F4BF21CDF9DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "E2B4A340ACBA424435528917531CAE4B605EB533040AE824000421F0C8",
      "00157146000211F6E67E45AE4FF021589FD0DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "EF48AAF32834B3F982128A9F8370BD49605EB53D040AE4E1000281AC0E",
      "001571470002BE6115861F377A57506D8EF3DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "C23A850D093870F4CEFD51629B8DE1E6605EB558040B0B1A00051E4DAC",
      "0015714800022E219EBDC38578031CE64483DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "1DFF9B041C7BFF2FF9801280C487F4E9605EB565040B11270007269B9A",
      "00157149000289224E307E5078187BB4A551DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "F82FD917C566C6B302D17111AE72849D605EB58C040B314300051213B4",
      "0015714A00027098B83105CE3EC64142C3C5DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "9E5B695D90B84C29E2A14BCDBAF40909605EB5AF040B1FAF00075E910A",
      "0015714B0002A086D4226F2E89FC9A26B928DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "045725EE79BD06A777D2005F56946F87605EB5C3040B16B500035FF311",
      "0015714C00027E41DF3E4F4C6BA0784AAFA7DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "C90C38F9746BA9AA35AEB7FFD596C294605EB5CB040B2B440002141988",
      "0015714D0002C87FB8E4FA0C53C7E98006F7DDBABD593C5513A5BFB51A7106DA6BE0F5B6"
      "6678F3CC2EC874CB63F3E042570B414E605EB608040B57560008A01D26",
      "0015714E00021F41534032BD3C13F289DDF8E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "997B4067CC4A1A3FD221830D71F9C3E9605EB61C040B19030000103042",
      "0015714F0002B7393A38B5E34DF67BB457E5E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "7C29249B6A6111CC1E2A8D3A09E99953605EB631040B2D0A0006F7E2D9",
      "0015715000020F6EB77CCE538D49A43284B7E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "2AEC171FBABE35F5C35204F6F1DECB24605EB642040B3FC80001D0971F",
      "001571510002173BE43F63449EF3CAF86A86E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "089822409EB31AB9C145BA91BE0808D6605EB65E040B5AA20000985B12",
      "0015715200027C9211FC66404BEF9A42BBD2E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "3BDEAB0DA8D8A313BFCF9F2E3E5BCBB1605EB65F040B5EF500061305A6",
      "00157153000235CFE6F2B091D01F6BB35F16E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "F93AD00B29014B56108D0568402C6955605EB66E040B9B1F00019C98B6",
      "00157154000281E284365895E2E6C0D6F7DDE4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "0C300F710BEA8820D20F65E4F24987BA605EB679040BBBE9000627A5F3",
      "00157155000210BE2973FD4AD34CE25F44CCE4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "D7608786C78CDAE4869D4AA9A15E1CE0605EB69C040BE5900002A8A261",
      "00157156000290780F148903B2225CB9ACCEE4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "80C130E1CCFF34B7F12CD1191316CB78605EB6FB040BDB1100077BE199",
      "001571570002870AA5D81C9770EC70709D37E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "17FB9FF2EAE6FDEE06813CF06C8FE9C7605EB70F040B51930007EF751B",
      "001571580002B51082786B3F3011D49DA0D2E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "45F804BA2A28EF65E8957711BE115B88605EB725040B678B0000EDBCF4",
      "001571590002A92986BD31A2FCBE14A2B3BDE4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "7A1F258D76AE22A918452000F9FAD1FA605EB727040B782B00047B5C82",
      "0015715A0002D9AD27DFCE74D84191D6EFA7E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "E0D4CE9E2FFD638F1E747A092459013A605EB733040BB43600064459A5",
      "0015715B000280DFAB6F528998C5B27D56BFE4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "4BDDAC01EB6E6DE0CACD94189FAE1D14605EB75B040BDBCE000661EBD3",
      "0015715C000242E9C864B91470470F563C3FE4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "3F6A13D5FAF9290875968BAA0D7D4AFB605EB7A2040BC3B4000780CCA2",
      "0015715D0002FCB87BBFD9AFFAEB240BC777E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "70B63157CBE28AA8F1D3FD59B58816D4605EB7ED040B6C280001C65E10",
      "0015715E000285456BED431BA6EA550090A9E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "18C4A5290D78772CB3917522E78D5B37605EB809040B11C30000B6812C",
      "0015715F00026A9DF19645CE1070CA17CCEBE4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "882FD183F3715CC2F00666E9B96BB1C6605EB821040B165C00030EB793",
      "001571600002C3E0FCC048F87E8C32A6EA33E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "C3EF427A6F57017025989C3A0FEC148B605EB82A040B21490001D1A512",
      "0015716100023614DAAF476F4A42482D70A5E4FA0C53C7E98006F7DDBABD593C5513A5BF"
      "F90CF848DD9460EFD05D013CFDA0B089605EB82F040B4A930002D35BA4",
      "001571620002C2C0233E0D348A2F706EF813AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "843690A2AC894165E6B65CE0001160BE605EB84C040B7CF20001E9C724",
      "00157163000285D667EEA3CD42F9947D829EAF476F4A42482D70A5E4FA0C53C7E98006F7"
      "96CAB45EDDB7AE93F766B8812D3FB3BE605EB851040B7EA3000107DF34",
      "001571640002082D6176D04BA15AF5922F96AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "2D7530D81422132AD95EC5342DCEC278605EB854040BB2470002C73ABE",
      "001571650002D942BF5033103AC87F683919AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "EBBDCCCBC30A13D5AEC7075255C2BF7C605EB85B040BECB30002320FA4",
      "001571660002D65D0E5D7A533E673447F324AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "BADAD2D2A11FE495F7197F292B481986605EB861040C1FCA00028F10E5",
      "0015716700027B29FECCF8D1FD924A1E70B6AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "02A5C28FEEE137B555FEC192A32CE0E5605EB86F040C5750000058EF3D",
      "001571680002018525A212E8131906590D33AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "ECAECE6F21EF75954335FF3C8988E47D605EB879040C7D0600026D2F03",
      "001571690002212D4C17838C6AD13E0FCB9DAF476F4A42482D70A5E4FA0C53C7E98006F7"
      "2C7149590BA0E421E0DF650E07F56DB0605EB896040CAE4C0001C90A16",
      "0015716A00024EC8312387A6D2DFD63E1EC5AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "5DFC5F76F50740E215C67E0991A7041C605EB8B0040CB0B1000191435F",
      "0015716B0002487C96E92D401EE11738BF71AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "E8A056225182A3D59D5FFFFFF3D81B6A605EB8B5040CBA2B000578E25F",
      "0015716C000204A9C6AA9050F1661BD388D6AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "2F7F7EEE5980B2D286BEA73BB0A3FFE3605EB8C2040CF94600012FBE09",
      "0015716D0002A0B43A4E8B4CFD8B52427150AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "EFAC133207F7BDE3972AEB579210208A605EB8CD040D2301000B8F1F77",
      "0015716E0002D7C1CCD223AEAEEB3773F508AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "A4E4AC7D23FF9A0A1C230A0B47DFE0EA605EB921040D55280006FDE49D",
      "0015716F00025430F5BA2311AE3644512CB6AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "8673F25416255148579C11348B4B1568605EB933040CC6F60001198E90",
      "00157170000223AF5067A72ECAE070015FF0AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "D700C221DABA70E46C95A8BB118E16B5605EB975040CE6640007BCB9A3",
      "001571710002AFE48123342F2232DF7DD92EAF476F4A42482D70A5E4FA0C53C7E98006F7"
      "0238E8375CC4D3746BF8BF411C69BA50605EB989040C8CF600002E2C4B",
      "00157172000220B886F6EBFAA2764A6C8785AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "74CB4D831481BCB4847D6AA8A7EBE3E6605EB98B040CA6770005AFAC82",
      "00157173000244F50804B67536D06AE036FEAF476F4A42482D70A5E4FA0C53C7E98006F7"
      "DCFDE02F4DE37E19268283B88FA74110605EB99A040CEC5000029E358D",
      "001571740002D069C57E420986B65C17EB56AF476F4A42482D70A5E4FA0C53C7E98006F7"
      "ECBF0D4727D7F122BDEE7A98AFAFE899605EB9B5040D129B000201E9F3",
      "001571750002CB7F13D9597C052D05AE24FFAF476F4A42482D70A5E4FA0C53C7E98006F7"
      "673BA431BF14898AEF8272C2A582FE12605EB9BB040D19EA00024DA524",
      "00157176000232113C54D837BB6A1EE780E5D9597C052D05AE24FFAF476F4A42482D70A5"
      "89BE1092F3FE3713B918B7184ACB694D605EB9C1040D59E70000590738",
      "001571770002C8103F59DCFF9953C6C9A921D9597C052D05AE24FFAF476F4A42482D70A5"
      "3453FF4903C039C37892FA85A0808553605EB9FA040D9BD100035D2C39",
      "0015717800023169627D02A36AB885962BB0D9597C052D05AE24FFAF476F4A42482D70A5"
      "61F0D10F27B6B25EA21C454C6B595182605EBA3B040D52380001EE1E8F",
      "0015717900024C5685017B387C1E16C68317D9597C052D05AE24FFAF476F4A42482D70A5"
      "F7B101F280838FBB56680F589D1EBE81605EBA56040CF895000667260A",
      "0015717A000290ADF3C4280C28C390C5BA8CD9597C052D05AE24FFAF476F4A42482D70A5"
      "4E336C6E809EBB78C11C19E9CB19D8DA605EBA7C040D01D70003322C37",
      "0015717B000238109F1ABB000208FE072A43D9597C052D05AE24FFAF476F4A42482D70A5"
      "F4802F61C7CF0B3AE625D0C4C33F305A605EBA84040CED7700000D20A0",
      "0015717C00021DE24C56CEFC3FAA5554E66ED9597C052D05AE24FFAF476F4A42482D70A5"
      "84B886E993E21494D41A65579C4E13DA605EBABC040D26CA00037ABEB4",
      "0015717D000239DD5A01CB486B612D8CACAFD9597C052D05AE24FFAF476F4A42482D70A5"
      "4010A82532D44A740441933616CDB7A7605EBAC5040CE53B000422A854",
      "0015717E00028A309904401F279E82F1BDECD9597C052D05AE24FFAF476F4A42482D70A5"
      "DFCEFCB5B2142036D402CC2026B662C9605EBAD0040D1A000004430345",
      "0015717F00028B556D807F5B315CDD9DC5ECD9597C052D05AE24FFAF476F4A42482D70A5"
      "6EE8A1A3B88C8E16C695AF36652005C9605EBAF0040D4B7E00016A9078",
      "001571800002E7CB4485E5A2875ECD291F65D9597C052D05AE24FFAF476F4A42482D70A5"
      "654DEF3D9EBCEE0EC8007556B07A378E605EBB09040D46040004919A45",
      "001571810002EF88D032A6061F44A2AFC3B6D9597C052D05AE24FFAF476F4A42482D70A5"
      "9E24A3BB9591AF4BF23E062CD48B8CE9605EBB6D040D541A0006E48DEB",
      "001571820002804B9F00153594B46E1254A1D9597C052D05AE24FFAF476F4A42482D70A5"
      "A06EAB77674708C385D19E3AF1CE66D4605EBB80040CA56A000A8C562B",
      "0015718300024CEF8A93A802A4B641B59893D9597C052D05AE24FFAF476F4A42482D70A5"
      "C91947ADCB67975133DF0327DACA679D605EBBAF040CC25D0005A49BA8",
      "001571840002C4FC6B0E2102C86290A8E2F0D9597C052D05AE24FFAF476F4A42482D70A5"
      "40B9DD64E727DCA257E2C10C057D2248605EBBBF040C98A9000740E73F",
      "00157185000258175DB063E46FB15079D5DFD9597C052D05AE24FFAF476F4A42482D70A5"
      "C56881C4E16ECC96CC5F522341BE0647605EBC0A040CB6F5000B60344B",
      "001571860002D01D30028A1733569AD102FED9597C052D05AE24FFAF476F4A42482D70A5"
      "77910416BB09485E590F83CBD584DB66605EBC5D040C4DDF0008E4F097",
      "0015718700029D9A1BABF8ED44864D240DD8D9597C052D05AE24FFAF476F4A42482D70A5"
      "F7CB11EDBFEC25ADB12449D7E0C672AF605EBCAB040BDCD40001C51B8D",
      "001571880002F9739746395112EBD1F7AF2CD9597C052D05AE24FFAF476F4A42482D70A5"
      "487C9B6E83CCB4C17B47CA936A12F3EA605EBD09040B7D4B000695959E",
      "0015718900020858C82196C6B30A3A5CD3E0D9597C052D05AE24FFAF476F4A42482D70A5"
      "E88AC9FB916DD546480752D036D58A22605EBD30040B075F000179AD17",
      "0015718A0002F7AD860A3921094B3BA93A062196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "89200FFEBC9689D7A01FC3F1AD9F9364605EBD34040AF8BB000116DD5C",
      "0015718B000216A4D179E95E743D06099CD92196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "EA432EC57C96B3BFB1D5556CB64FD7AC605EBD4D040B27C60002718D72",
      "0015718C0002AD82E749FF5B7C2D598166B22196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "2C7086E0CE592398157827C5378CC2D6605EBD53040B30BE0005CC08B1",
      "0015718D0002E82771DD22C887C79A7A95132196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "1715976A8E96BC0F07EEEC02DE0AB0C7605EBD62040B5DC30009641386",
      "0015718E0002171CC478EE47D20CF66E1D702196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "0FA85957D0CF7139E2901C4EC10A260E605EBD8F040B7959000583DF24",
      "0015718F0002E0EB09DBE34ADD3C0A4240DF2196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "D89281F9F7D37DA3D2B61278E92E5614605EBDB4040B5CBB00071699DA",
      "001571900002EB874BF01D7BBA0BE37E0A612196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "72049C7A0F446E00A8D5AB3026CF67B4605EBDC6040B4F96000639EF1C",
      "00157191000265974F09B5F7D2356A64A8AF2196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "B7A0752C2FEDEC33F96AA31C8CAD7F1B605EBE0D040B666400036AD7EF",
      "001571920002D7275B05D85F2BE8F0BE53AB2196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "09667FB6948B41A4E5622C2EB4DF4249605EBE2C040B1A870002CD53A9",
      "001571930002CFFA7C28339E44651038AF072196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "28288377D96F93F16D1E433640F31B1F605EBE49040B199100018389AD",
      "001571940002DF86A18C36CA2E0D530EC5AF2196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "62541CEEDC642B0006803712F9708767605EBE4D040B1BE40003949BFC",
      "001571950002F66FDFC4CC007C36A03D13FD2196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "A7E69A0C1DA0860D8388DE309664F321605EBE56040B4B14000A111452",
      "001571960002EB7352C509ED849625DC31C72196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "60D65ED02E4BA1AAA84150E849C68BD5605EBE86040B7207000455F038",
      "0015719700028403ACEFEC373AFCE2A44D3C2196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "A6184BCF733CAE46C724E2A454701C95605EBEA4040B50370003A5E0F9",
      "001571980002DA39794267DC4B70E18788262196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "2BF811774DE9C38E3034C96F9F0166B5605EBEC2040B506E0008D8A3FF",
      "0015719900024603629703D38E116DB424B92196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "2726ED897EC9555221D478FAD937623B605EBEED040B5085000CAD1DA5",
      "0015719A0002BA992F3EB8DA2DE11E70C1E42196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "DBFC39410B18604EA2F161AF1ED706B5605EBF20040B394500012A3D3B",
      "0015719B0002D8B5B2F49EB5B3688138F7E32196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "BFB229B6C77A2E4F1D152DDD77E94FDE605EBF39040B148700096434CF",
      "0015719C0002A7BB07E319AB77AA527C024F2196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "428585E80B87548DC43DE6087991810A605EBF4F040B1E4F0007ADBF27",
      "0015719D0002DD6F50FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0D9597C052D05AE24FF"
      "FE2F12247433EAE8234050F575532F57605EBF63040B2D5B0001285EFB",
      "0015719E0002761A9197AE48B20F0F8B3F9EFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "781F29F83627BCD95897E4322D2C622C605EBF68040B400600084FE50F",
      "0015719F00021BF6E911998C7BC5B2E26F7CFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "05AA4423846797D65D7BCAD130224811605EBFF7040B6D95000673423F",
      "001571A00002190EC3E82D36CAA8E2030A8CFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "E38B2FE83BCA9E6497A3B5FC6A5E044F605EC01D040AA7860001639658",
      "001571A10002903C7BD3B908928DDCD316E2FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "5283234969FD5A12BDC3971A90101084605EC021040A9D10000BAF00DD",
      "001571A2000244BA070CEB3DA47CC1136A3CFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "4AEA6B9E0927B9C7EE1D5A73A5F69DBB605EC056040AC8D800098A8421",
      "001571A30002E2732E1CC59D96C1456345A6FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "4CC37B65FE6DF8A5D9C9646D5AFE4F35605EC084040AA30C000078804C",
      "001571A40002A6D6711F5F6CB0475A33F82CFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "02A810B527B76DC42FED4C85FB49C2AC605EC085040A8A540006A7D1F2",
      "001571A500026C0FBB992A8BACCBFEA800BAFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "E2FA437ABB0A61F143A16E1488B1E718605EC0CF040ABA72000323643C",
      "001571A6000288D7A0ABFB20F839CCD52545FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "BF8687311D29CF8976145011BA00551C605EC110040A732B00020C66F5",
      "001571A70002CB5A1B7657A672CC87AD1F86FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "8AC340D09E985A498C6876D2EC82CCA6605EC12B040A3E4D0008261E34",
      "001571A800025AD020FBBBBD8A29C7FF2CE2FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "734A7B8C481D997C3C631B0FC30B42E1605EC13F040A41A800077D64F8",
      "001571A9000200678627C00C4E8F41D5275FFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "9E383CE767F55CCEF9DF901FA8C8DF65605EC151040A515A000071F881",
      "001571AA0002D8E6EFEE4438A2082822D4D0FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "D052E5FAED1CAEC78C4A42BD0525519A605EC152040A64490003D06E12",
      "001571AB0002B00DA23EC5A1759876FF4E76FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "6613ABDD2AF572A4FEF571519CAC93C6605EC15C040A93130001716810",
      "001571AC0002F100BC908C3A403978700D9AFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "6E276F89AA55FCD0C16078B37F343410605EC160040AB3F20001B0E87C",
      "001571AD0002B545A25DD304EDF7BD2C715AFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "8CD7FB96D5A87BFBB2406FE97CFDBAE7605EC16D040AE03D000ACEE3B6",
      "001571AE0002C69838727BC640C653F042CBFC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "BC3229107EC36510D458EAD53404C4F3605EC19B040AFD8D00056212AA",
      "001571AF0002AC2789B02355A7DA930CE8F2FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "8ABDDA26C090C83AAD62E16B7AFC4B8F605EC1BF040AE1D30001BFA643",
      "001571B0000271A78346F2AFDA53E71B5B11FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "292B1DCDC01EAF419F444ED072DD9A45605EC1C3040AD863000D7C8316",
      "001571B100023071C52062B503F19BF40723FC2CF7C15A0A68B4B32196C6B30A3A5CD3E0"
      "D7ABC4B2D01E11AF2EB9EBAA8057EDD1605EC21C040B0664000732A212",
      "001571B200024DFBC2770D70E876740B69F02062B503F19BF40723FC2CF7C15A0A68B4B3"
      "4A784163AA2AA4E503F412FE4B6B8CAA605EC263040AA164000756B406",
      "001571B30002F70C7FB3CD156832257FF5AB2062B503F19BF40723FC2CF7C15A0A68B4B3"
      "64394470425C21021CB5AC208BA69CA6605EC275040A612D00021DEC64",
      "001571B40002F671D700177734B719E4EE462062B503F19BF40723FC2CF7C15A0A68B4B3"
      "689CAD553FFF650248750A709BD9690D605EC27E040A75450000C310A0",
      "001571B5000233AE57D5EF7F48309B99F27A2062B503F19BF40723FC2CF7C15A0A68B4B3"
      "BA26D8E2C3FB69B9C923963A57D8230A605EC280040A978D000223B67B",
      "001571B60002EE0E813F6E10614A3CF3EE562062B503F19BF40723FC2CF7C15A0A68B4B3"
      "7C541F8EA6A7F8B68EAF4DF34C4EEB25605EC285040AC62A00003515D1",
      "001571B7000296C917C1986EC4D218D9FEBF2062B503F19BF40723FC2CF7C15A0A68B4B3"
      "A75319440CDA4927A9FF6ED412C97C3E605EC28C040AF18B000C7E8430",
      "001571B8000292B8D5BE287C1415316552112062B503F19BF40723FC2CF7C15A0A68B4B3"
      "02E89F42CDEF2F2C6BA118326D92D4FA605EC2C0040B1A77000098B992",
      "001571B900026682AC879F7B0347F5C8CBB22062B503F19BF40723FC2CF7C15A0A68B4B3"
      "79E6DEB3384242E112D1E7106E01754A605EC2D7040AF3B60003D1FFEB",
      "001571BA0002121D7EB2C5A84ED90ACC26D22062B503F19BF40723FC2CF7C15A0A68B4B3"
      "F777FB2C68D431C360273EC1EE634D24605EC2F6040B008A000117563A",
      "001571BB00023BE71225B07555AF9CB341CE2062B503F19BF40723FC2CF7C15A0A68B4B3"
      "6CFFC980632C3F3F7A5DD1702665DAC3605EC30F040AFDC0000B270C28",
      "001571BC00024E754DA4C27D32AE01D85A752062B503F19BF40723FC2CF7C15A0A68B4B3"
      "17637CCFEAB239C950BE95E376529536605EC33F040B07350007B9B31E",
      "001571BD0002FDA682CC33BFF7026259818A2062B503F19BF40723FC2CF7C15A0A68B4B3"
      "EAC5BC308EAB8A8402FF14C25C1931F8605EC38A040AE7FF0007B6AF51",
      "001571BE0002B8512404039DE5373EB43D442062B503F19BF40723FC2CF7C15A0A68B4B3"
      "1124287CF2F8B5A43D61ADFE6C5AEB6C605EC39D040A9CFA00008408B1",
      "001571BF0002F485FF584145BB8591EA4C592062B503F19BF40723FC2CF7C15A0A68B4B3"
      "62842BA8C45278F19788C69598190D23605EC39F040AB0820000F939E7",
      "001571C0000231D1FA64F023366031950E662062B503F19BF40723FC2CF7C15A0A68B4B3"
      "009E586097FB03E90379F380C55C43F3605EC3A2040AE00E0001584422",
      "001571C10002E8E9A07AE8D704FB85F2D3BB2062B503F19BF40723FC2CF7C15A0A68B4B3"
      "46A7B62BCD741400426FFB5CEA2BB7C6605EC3A5040B0EC40000BA0835",
      "001571C200027D36188C69AD4FB9FE7408042062B503F19BF40723FC2CF7C15A0A68B4B3"
      "94798089B6C1C5C38F7EB9C059537DBC605EC3BD040B3F220000468719",
      "001571C30002B1D8B2534F6A5922A8BA22962062B503F19BF40723FC2CF7C15A0A68B4B3"
      "2185E2FA107B13B8F613BC000C25C6A0605EC3BE040B4A500004702D3A",
      "001571C4000202AC68C71E5A8A3B1D5D8A682062B503F19BF40723FC2CF7C15A0A68B4B3"
      "EE07DE6BA00E4B997F9E203354A8B381605EC3C9040B8201000284E289",
      "001571C500026761734AEDA24536EA8316782062B503F19BF40723FC2CF7C15A0A68B4B3"
      "D34BA3C071859095B132ADD36E75E8D6605EC3D0040BA7A80002365BDD",
      "001571C6000276927A414A474AC4098992284AEDA24536EA8316782062B503F19BF40723"
      "40B82DB946F43A262DCF298D27E57066605EC3D9040BD6BE0000B42E34",
      "001571C70002F26309920CF422149E24C9614AEDA24536EA8316782062B503F19BF40723"
      "43389FFE105D6BCC222B92ACBE729178605EC434040C027A00071CF398",
      "001571C8000223DD21A1ACDD7A8FEACF977B4AEDA24536EA8316782062B503F19BF40723"
      "1FE3101229DDB5B9662CBF03F007AAE5605EC447040B874200059E4F54",
      "001571C9000255EF568B55549CF44DB1AAFD4AEDA24536EA8316782062B503F19BF40723"
      "5ABF4D93F82520BDE6959196C5474C76605EC458040B9F0A0003BDBBF5",
      "001571CA0002199A496E6B339DA0E88736814AEDA24536EA8316782062B503F19BF40723"
      "DBED57E836884491564CFE17B81C8CFD605EC467040BB99D0002D290B2",
      "001571CB000250F984E0E3D5D264D72562174AEDA24536EA8316782062B503F19BF40723"
      "37863CF770C954B2681963A646E9B183605EC486040BD8BF0008025137",

  };

  AltChainParamsRegTest altparam;
  VbkChainParamsTest vbkparam;
  BtcChainParamsRegTest btcparam;
  adaptors::InmemStorageImpl storage{};
  adaptors::PayloadsStorageImpl payloadsProvider{storage};
  adaptors::BlockReaderImpl blockProvider{storage, altparam};
  PayloadsIndex payloadsIndex;
  ValidationState state;

  int32_t starting_height = 1405253;

  for (size_t i = 0; i < hex_blocks.size(); ++i) {
    VbkBlock blk;
    ASSERT_TRUE(DeserializeFromRawHex(hex_blocks[i], blk, state))
        << state.toString();

    ASSERT_EQ(blk.getHeight(), starting_height + i);
    blocks.push_back(blk);
  }

  auto bootstrap_chain = blocks;
  bootstrap_chain.resize(100);

  VbkBlockTree tree(
      vbkparam, btcparam, payloadsProvider, blockProvider, payloadsIndex);

  ASSERT_EQ(bootstrap_chain.size(), 100);

  ASSERT_TRUE(tree.bootstrapWithChain(starting_height, bootstrap_chain, state))
      << state.toString();

  for (size_t i = 100; i < blocks.size(); ++i) {
    ASSERT_TRUE(tree.acceptBlockHeader(blocks[i], state))
        << "block height: " << blocks[i].getHeight() << " " << state.toString();
  }
}

TEST(VbkBlocksTest, basic_test2) {
  std::vector<VbkBlock> blocks;

  std::vector<std::string> hex_blocks = {
      "0014129F00022B3406FE33500C8F4709F1229F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "4C9A2398E535321AB038571198917D0160353B3B040D1C9A00022326C4",
      "001412A000021EF2D5760B14220A9967168F9F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "4A11CC161C28F01B1B42E189ED89013A60353B57040D63A00004555356",
      "001412A10002A557C0C03C7C4A8EA0D554C59F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "C7D282E327AED530D85B67290340AA7C60353B61040D6818000078E75C",
      "001412A20002C25BC7786C1C71FC13E02B8A9F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "543F021E591A52E967CA55A754A371D260353B78040D9E8900029434D7",
      "001412A3000200809282E1056F6DF0FCE3C69F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "0C64300FDF4EFE7B6CEE600B223E0B2160353B7E040DB024000619EC1D",
      "001412A40002D59201BBC59025A77CF323D69F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "A70393C30F7CB92F2E613E6321A101A560353BC6040DF4C100027FBDBA",
      "001412A500020692B597E0C808B7D9D6FCD69F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "7520602ECE47EA20108017F8BADCE95860353BCD040D8129000DDD4EFC",
      "001412A60002CABD3A0B46676AE04A2C92DD9F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "3AA1BDB34EEFB47AC5DAE176AA8D49F260353C27040DC180000339B211",
      "001412A7000235B17FF54BF27461C2ED90839F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "37AA4995E619DDA603D2BC198F3FABAF60353C44040D1EAE000A0571FF",
      "001412A800024DFE4A94F36FA66295B957CF9F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "E6795D1F5106D59EBC6809037C0FB89960353C74040D234F000128195B",
      "001412A90002541334D530C64D74DABA90CE9F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "5A99F910AF14A55D7405F559F0FF680D60353C77040CF75E00002F45B6",
      "001412AA0002C6D0CDFF8FF5819A831143449F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "6D22DD7B48A2A29FDCA80B894FA84B8260353C8E040D3C950003EC5CB4",
      "001412AB0002DD57EB18BE9B05C8979DC39F9F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "26893A325AB3650D734ADCA31EF8BFC160353CCE040D4EF6000497BBA3",
      "001412AC0002311C1197ADFA53BBF264A49C9F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "DD41B38F029BA0B9A7206F6AA0C5101B60353D52040CFA730007CD46F5",
      "001412AD000261158C4F719CC7B3AC17FFB99F24C15AA45B4D7A2C7B3AC101641C39CEEC"
      "724B8804FB9501CF1FF37D7C1C29C5FF60353D64040C13300000A9896F",
      "001412AE0002F25D2F3C99A7937DD5BF122C4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "D9D87170DE8DE830D62A844E55F3DF6260353D6B040C2FE2000485B042",
      "001412AF0002456362E66C0A357095212D6D4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "73F0E039431F4A526942381228403A7760353D75040C63090002BFF1DF",
      "001412B0000247F18C26B2798CB48DA0B3EC4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "BBDF28929612DD8E073F45E0C5E1B08360353D91040C90CB000A5C6A9B",
      "001412B100025DB903012822094464E9E97B4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "2367FCC09EDBD898C2522B7736863CF960353DBE040C9542000BCE48E6",
      "001412B200020678E6ACC820BE1DE2A075744F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "2620BE14636846A92CF8E8DBF226443560353DEF040C741A00000BCF83",
      "001412B3000253A03246754244F9F27F67E34F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "F9DD8DDC4B4735B1C01EEED15DE6AC8260353DF0040C49560005B39D2C",
      "001412B4000257CAE82344B889EB7FE5FB744F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "7ECA168792BC94EB76129B63BD1326D360353E98040C8AF90009BB989D",
      "001412B50002298BF25057496E0CCC28B2C44F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "C674A3976197B54575D7F36BE599E4F860353EC2040B6B6F00001C63D5",
      "001412B6000284D0AAC5C3466DC705EAEA6F4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "C59E09F6E4F7E0F98E0738D3698B975C60353ED7040B57B20000D66453",
      "001412B700021639E7E1F96077733FE83B6A4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "200C5B786735CC3A747CAB868396FF2B60353EDA040B69510001C697F4",
      "001412B800029593D9F9DDABA33B15FC81474F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "66A3830183DA7E2CB1157559B0FE8C9E60353F15040B9D8E00001C1F0D",
      "001412B9000227D12DF50EA82849CAFEE04F4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "B83E1B2BFA3D7AD8D94F9619D28CC42160353F16040B65C600050616FD",
      "001412BA0002EB29B0D25F4FD75B696C21B94F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "08C22563EB0C7BFB05CF4D7517D09A1F60353F38040B9E350003238763",
      "001412BB0002112A96FA20BD838873EE78A84F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "693CCF97BE06C8340136A7F904D9CFAA60353F40040B95FF0005799C1A",
      "001412BC0002D735BBE0E7897E539837E0E94F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "F880D6997BF470A4C2B554AA4E0BB4F760353F61040BC19C00041B0A6E",
      "001412BD0002EB58DD54B731A189F2251ACA4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "76C1BE23F7D4B710D8E30741DA4158E860353FA1040BBC0A0006FA67A2",
      "001412BE00023F567E5A345FB8873CFAD1B24F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "DC633F0739C616E6A7E919C29139570E60353FC6040B78EA000B768DD6",
      "001412BF0002F15A07BBC0F12E679640EF0E4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "D70964B679E653D7529E7A37A6E8B2C060354016040B6BAA000385676B",
      "001412C000020D28E966381B54E686236AAC4F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "6C8FF759022B54DBDEDF1ACACAC7ACE46035401F040B103F0004456222",
      "001412C100026BA52111322D2B01FAD809324F719CC7B3AC17FFB99F24C15AA45B4D7A2C"
      "2D22950C392FE96D5C2CD7EFE6EDB2C86035403D040B37FA0006A3CFED",
      "001412C200026FA226DFF942000EF26D004211322D2B01FAD809324F719CC7B3AC17FFB9"
      "E1F4944387F15DCE1BCFB9FF1FAD5D486035404E040B37AA000669AEB5",
      "001412C3000234AAB94D13420A44B3D9879311322D2B01FAD809324F719CC7B3AC17FFB9"
      "8EE9338DE7BF92C2A38F7BC4DBD7B22A60354063040B4EEA0003B9D69B",
      "001412C40002DC0F229ED9FA938607BD954E11322D2B01FAD809324F719CC7B3AC17FFB9"
      "49AFD70B1ABF439B42D5F86EBFBBFD696035406C040B601C0009E50949",
      "001412C50002748AEF07AEEA9EEE2941C13A11322D2B01FAD809324F719CC7B3AC17FFB9"
      "3941BA691187CD438374502E25BC059A60354099040B88C300067C6043",
      "001412C60002DA5FE646924F58315DEC3B2011322D2B01FAD809324F719CC7B3AC17FFB9"
      "A25B4E8BB6586E2DBC4D5BA7E669F0E6603540A9040B6B4A000338BA26",
      "001412C70002134193AC25119779F057161911322D2B01FAD809324F719CC7B3AC17FFB9"
      "3B20FFDA36DA3AB942F7B8C86FF7F945603540B7040B86AD0004595F93",
      "001412C8000224AB7B4C32B37D9ABDB3404C11322D2B01FAD809324F719CC7B3AC17FFB9"
      "18D3D5358905CB6F0E8918D3568FC63A603540C9040BA6800001C079F1",
      "001412C900025AA33501AC20ED73D441A9EA11322D2B01FAD809324F719CC7B3AC17FFB9"
      "69B1AE7678FE4D619B0BEDE46ECE8A1660354125040BBEE000049BFC5E",
      "001412CA0002DCC8D3A58CD1D5960C64F51411322D2B01FAD809324F719CC7B3AC17FFB9"
      "509067B7CDA1F81C6946FEBE579D35E960354130040B47A500013B448D",
      "001412CB00020DDBE1FCDBC4941E01CF3B7E11322D2B01FAD809324F719CC7B3AC17FFB9"
      "FB1C571C046D84F626D22407CF4EB4AD60354148040B6CB3000B8797E0",
      "001412CC0002DB6D447C6E04B38BCCB85EB211322D2B01FAD809324F719CC7B3AC17FFB9"
      "2E96CF4731DA560127D0D3493310F30E6035419A040B785000013654B1",
      "001412CD00022271F5499AF7F06630C84BC811322D2B01FAD809324F719CC7B3AC17FFB9"
      "D1BB8961741CF48B3B917F1AE2EE5E946035419D040B17BA00031F5781",
      "001412CE0002E72AC73E4D2BE2BBA929E6ED11322D2B01FAD809324F719CC7B3AC17FFB9"
      "ACA87337D6072B06BC768DD032D88832603541A5040B49F00001375F81",
      "001412CF00028F098BD5B6C4A1F6BB903FE411322D2B01FAD809324F719CC7B3AC17FFB9"
      "5CC2ECC99DBEFDA90339C220FC58E05C603541B6040B73C00005BFB598",
      "001412D000023CC776CBFCB9363F4060550411322D2B01FAD809324F719CC7B3AC17FFB9"
      "51FF6B6AC6BD242F46684D339A72D013603541C7040B8C440004CC7BF0",
      "001412D1000223DF48F7B0D0DEA9CA7870EA11322D2B01FAD809324F719CC7B3AC17FFB9"
      "F62B249DB400C09A1ED77D5A6F91391A603541E9040BA6040007179256",
      "001412D200028F35E5229ABAE6BD8A92F51B11322D2B01FAD809324F719CC7B3AC17FFB9"
      "189919855FEBD8844E9B90AA1522B808603541FA040B9DB90001B55931",
      "001412D300026AA14DBA53861B4DE297B53611322D2B01FAD809324F719CC7B3AC17FFB9"
      "A582E3FE78F440A68E7308209540829B60354204040BB73700033850F6",
      "001412D40002F21AF6360B9C6785241DF2BC11322D2B01FAD809324F719CC7B3AC17FFB9"
      "B75507796912CD7C4C57888C47E42A1060354223040BDF3200035305A1",
      "001412D50002A761B9E0E50947AAC04892F811322D2B01FAD809324F719CC7B3AC17FFB9"
      "F8C1A5ACCA0A7746FE80439DA6469FF660354263040BDCC3000066A8A6",
      "001412D600026E6E49E82B0EB9F3805045B2E0E50947AAC04892F811322D2B01FAD80932"
      "47E0E2CC9B44A4A68FA0EE851CB63CE36035427B040B97400001978EA7",
      "001412D700024BF94486180814A376E5D215E0E50947AAC04892F811322D2B01FAD80932"
      "E2BC09A18F297CC76AE423DF3CD1149A6035427F040BA2850002787AF7",
      "001412D80002BE0B0887A19AE3EC0D56B6D0E0E50947AAC04892F811322D2B01FAD80932"
      "E8784D54D832F6069E526EAA07E88A4060354285040BD5C10001903FB9",
      "001412D90002C7F1EDEF07A11978F2D72EEDE0E50947AAC04892F811322D2B01FAD80932"
      "28D04D4625EE7D701C2A666085F5161260354289040C068F0002BC1F4F",
      "001412DA0002CBB4D2D4AA3F31B5978DDD03E0E50947AAC04892F811322D2B01FAD80932"
      "7DA97E1F7A83D28C9EEC2F967E1B5BE9603542C6040C3D5400016DEBEF",
      "001412DB0002EFA3A4A4343EFB03B59BD249E0E50947AAC04892F811322D2B01FAD80932"
      "644B52E937A4C49A7A6745939C785D01603542CA040BFB340000F1FD04",
      "001412DC000256F20E91A1A48CBE771838CDE0E50947AAC04892F811322D2B01FAD80932"
      "9A9492554E52762217B980C598E61ADB603542DE040C32A700010F7753",
      "001412DD0002B04DEE4C5E546437364553A3E0E50947AAC04892F811322D2B01FAD80932"
      "CD628BED872041E5B6483641BB4B082A603542F6040C47F40001D34723",
      "001412DE0002A227B721141C54348105217EE0E50947AAC04892F811322D2B01FAD80932"
      "65F7C0C36B9F132CDE2D2EE8744E77F5603542FB040C55040007255BE5",
      "001412DF00029FA48A4F7CE96010F0AAE2B0E0E50947AAC04892F811322D2B01FAD80932"
      "22E8BE1FA2B4CCAB4BEE1EF20A682D3A6035430C040C8A850002D2B01A",
      "001412E00002B0EE6B50BB11F697921CEA0AE0E50947AAC04892F811322D2B01FAD80932"
      "339153DBDC1E694FAAFC04030F66A86B60354316040CA78C00032DD856",
      "001412E10002513BA914C5D6B1D9FACF0CE4E0E50947AAC04892F811322D2B01FAD80932"
      "A8DA963B9D270BFAE2639A4E7A143F6A6035431E040CD5E10006C8B7E4",
      "001412E200024305841A31E75AEEB99EA416E0E50947AAC04892F811322D2B01FAD80932"
      "6148D51E0E5F3E1EC4640CD8A7EFBDD460354344040D09920000FC008D",
      "001412E30002C352183EB184BC947E38730FE0E50947AAC04892F811322D2B01FAD80932"
      "4A09B510BB1D8C84307AB38AFB68A8C560354346040CF4E500022314F8",
      "001412E4000272D2688E0DFF349667B603CBE0E50947AAC04892F811322D2B01FAD80932"
      "9543D8887426BEE3FAD0B873239AA70A6035434C040D398B00016F3C2A",
      "001412E50002BEC5B4CE0A2D3835A56D943AE0E50947AAC04892F811322D2B01FAD80932"
      "C97EC9FB8E122E66EE07CDDBEADA89106035435F040D759500049D6347",
      "001412E60002DA3334079FE270265F9BCE1CE0E50947AAC04892F811322D2B01FAD80932"
      "B7ECD661ED8AB0888638ABA1ABBD743D6035436C040D919200073437C1",
      "001412E70002A13882B800296615E09FB516E0E50947AAC04892F811322D2B01FAD80932"
      "B52EF052F7294E093EFDE14251BF3FFF60354394040DBD84000C7BF180",
      "001412E80002A1DE1341E8DA4787FCC7F363E0E50947AAC04892F811322D2B01FAD80932"
      "2C6FC61E85299A6C679A8F5A63033F8C6035442C040DA28C000ABAFAE0",
      "001412E900022E68159069DDF5E9DDCA7570E0E50947AAC04892F811322D2B01FAD80932"
      "0848A5A76409CAF54C738272DCBFF8EF6035445C040C7E2500055C4A66",
      "001412EA000233D5063CFA23C8C94434F5369069DDF5E9DDCA7570E0E50947AAC04892F8"
      "13D1222787D918F453D3F0901D10D338603544A2040C5A260003FFEB95",
      "001412EB00025E2E1D32BBBDAE5140832B0D9069DDF5E9DDCA7570E0E50947AAC04892F8"
      "B95F136F9A39DF027AA88CD2FED8941F603544C0040C0751000083D28A",
      "001412EC0002F3AA908E5498C22B7EB71C079069DDF5E9DDCA7570E0E50947AAC04892F8"
      "FFC08348B0CCFC3510DE8F5CEDCD4388603544C2040C08B50000F4C08B",
      "001412ED0002C98B1E945547DB51692DCC3E9069DDF5E9DDCA7570E0E50947AAC04892F8"
      "8BB9F0527DB7D7EFC11E3140D38AA7D7603544C5040C419F000CDA41BD",
      "001412EE0002E537E241F4FB487D15A3C4329069DDF5E9DDCA7570E0E50947AAC04892F8"
      "57534BD336DFB63FC8D19C816888D6616035451B040C7B88000D948872",
      "001412EF0002F754FA8F0FFF099C931EE2559069DDF5E9DDCA7570E0E50947AAC04892F8"
      "3885E724E2D20221B1DF9646FB270E5360354551040C05D30006EBD68A",
      "001412F00002A7A674A40163BD1EE9A1DE4F9069DDF5E9DDCA7570E0E50947AAC04892F8"
      "39DDD416299CFF52ABD275297C14830A60354561040BD76800033FE414",
      "001412F10002BEED4E16014FB353AC6BCBE89069DDF5E9DDCA7570E0E50947AAC04892F8"
      "1E9F2C92A4345546EC11693E604C25886035456F040BF4410003256744",
      "001412F20002B8287F1AB5E72D34A9AA2A379069DDF5E9DDCA7570E0E50947AAC04892F8"
      "424195EF64F720250A149CA1B140E9F06035457E040C14DA00038599C7",
      "001412F30002A9896B0149EC1E8532F1D1EF9069DDF5E9DDCA7570E0E50947AAC04892F8"
      "B4B950E11D635F8D030E40874F6142166035458E040C335300048EE4F1",
      "001412F40002EBD4EF38E415648255E70BC89069DDF5E9DDCA7570E0E50947AAC04892F8"
      "ADE2ACE8E088ED0871889FA69E1D2ECE603545BB040C50180005806D50",
      "001412F50002DF6DB7587A8840093453EA549069DDF5E9DDCA7570E0E50947AAC04892F8"
      "0BE0A4B9F77C90DFC5516F3FEF3E46EF603545C7040C31060001B5F164",
      "001412F60002EC0AD8E713037350B3156C1B9069DDF5E9DDCA7570E0E50947AAC04892F8"
      "BE610AED4FC8B36E0B2318801D4E878560354604040C57D90006DC5C28",
      "001412F7000215D58F386D455927862D5D4F9069DDF5E9DDCA7570E0E50947AAC04892F8"
      "B3823A6073E79860A53B2A0252FEADCC60354614040C17AF000233E8EA",
      "001412F8000266E525DEBFD04027C4F578439069DDF5E9DDCA7570E0E50947AAC04892F8"
      "1CED13BB8AD393DAED22873B22A1DC1F6035461E040C35A80002DD5206",
      "001412F90002B8DA24DC7433B1CEA22409AF9069DDF5E9DDCA7570E0E50947AAC04892F8"
      "C6DF744BED0156970C3D4A7116864AA66035465C040C5F7F000844261B",
      "001412FA00028F7D948182AA85310091DB169069DDF5E9DDCA7570E0E50947AAC04892F8"
      "D2AAA832CD3328C046CAC21D118965666035466F040C1C840000C8D6B4",
      "001412FB0002856648FFE9EE2E7310B40F639069DDF5E9DDCA7570E0E50947AAC04892F8"
      "3772228F4A01D3D2013F32F69590CBBE60354688040C34A6000402530B",
      "001412FC00028AF87B9DCF05B618F88E787A9069DDF5E9DDCA7570E0E50947AAC04892F8"
      "954B5361FB5B2D7E75DA06F931FCE5FB603546A8040C3E39000154D867",
      "001412FD0002219F56BE25EF62DC218D10C29069DDF5E9DDCA7570E0E50947AAC04892F8"
      "890C3AF5748FE3A51E8BFCBA64A97D95603546C1040C3AD0000184A3C3",
      "001412FE0002B66116ADF29F190F0DF5FAB9BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "4F47CF5ECFDFCCCDB598D498B511139F603546C5040C46280003D240AF",
      "001412FF0002029E1D79529AE687FFC1F95CBE25EF62DC218D10C29069DDF5E9DDCA7570"
      "0B63F7CB6DFD852A67DF9A1E40032275603546CF040C7E630002DAB97A",
      "0014130000025E8828B432589A7EA3CB7E05BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "630C69975D2BBB23FCDF54050BC9F905603546EC040CAAAB0005FA4192",
      "0014130100021F0F554A0C8CD36C2CCC9832BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "8AB68C5CC27DAC5407C7BA4FF1D2EE8560354712040CAD100001D644F8",
      "001413020002319D1AE84A9206C69612BC93BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "860B966D8126AAFF278EFBB4CBA58CE06035472D040C9BE600048080E5",
      "00141303000254962CD356AC8D33EC83E474BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "2ED33A9C0568263982AD595A886057526035474E040CA2D00001B6C729",
      "001413040002360584261FA19E6F710551D6BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "C771E5EF989F6F12EC3295190817A40060354757040C9CC7000436F9F2",
      "001413050002D280DFA95BEB572131709DC8BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "10C87E471A2D63E64E28414E3C56CEB960354785040CCC2F0002F02B8F",
      "0014130600027BF31B6433064C2EAFCDC867BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "D4AED88F491549964EBFA96C77BD21AF603547C8040CA7F3000917AAFE",
      "0014130700020507DE4C05E3EE86A0855C42BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "44C45D8778B10F272C967AE7FD798F4E603547DD040C57880006E9995A",
      "001413080002A91DBCFD9993727E255944DCBE25EF62DC218D10C29069DDF5E9DDCA7570"
      "F51573873F520C229CF8DF7DBE9BFC70603547ED040C6BF000000EC639",
      "00141309000204A8CF31D97AE58E090BEC25BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "4A762E7533EB0723A7F218F9C6AE7056603547F1040C88F1000E422087",
      "0014130A00020D8E19EAF0B1931C6E48B77DBE25EF62DC218D10C29069DDF5E9DDCA7570"
      "68F82A4FDBED509DA6904452801BD4316035488C040CC36100005F6C5D",
      "0014130B0002E8D9EE69FBF2E69058DC36FEBE25EF62DC218D10C29069DDF5E9DDCA7570"
      "556B8BDDC3B56D67920A21F62592FFDD6035489A040BBAA4000836A088",
      "0014130C0002629E0A77B62B34B4E691B996BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "6E12ED0B12D0A5046C9B24882FEB2380603548C1040BDC6F00009AEC04",
      "0014130D0002A6648A7437CA699E801778E2BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "D64EAB00399D6262C7449DD2E9E485A4603548C3040BC9FC0003EED4EE",
      "0014130E00025C023C4C1C52C426C35E9462BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "57EBE90CE5A5FE984D5A857E1EF2A659603548CC040C027C000054C937",
      "0014130F00029288EB84EBEF9EB134D1EFA3BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "F66A00B3D58E0ACB4DFBD56BFF4F209B603548D7040C2D3700081D9104",
      "0014131000022D65E1332CE0CBF462B3D656BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "CB68E01B117FCF10AA982FF799D24DD0603548FD040C542A0002668FF3",
      "001413110002BC165C71D62A2D9FBA4CDFB0BE25EF62DC218D10C29069DDF5E9DDCA7570"
      "EAC3A9694E94EC9E0A661EBFC93A381C60354919040C408E00069F0E20",
      "0014131200027D4813319DB44FD67BA6193571D62A2D9FBA4CDFB0BE25EF62DC218D10C2"
      "741CB53B2D65BE9E963E7573730218626035494E040C45720001EBD567",
  };

  AltChainParamsRegTest altparam;
  VbkChainParamsTest vbkparam;
  BtcChainParamsRegTest btcparam;
  adaptors::InmemStorageImpl storage{};
  adaptors::PayloadsStorageImpl payloadsProvider{storage};
  adaptors::BlockReaderImpl blockProvider{storage, altparam};
  PayloadsIndex payloadsIndex;
  ValidationState state;

  int32_t starting_height = 1315487;

  for (size_t i = 0; i < hex_blocks.size(); ++i) {
    VbkBlock blk;
    ASSERT_TRUE(DeserializeFromRawHex(hex_blocks[i], blk, state))
        << state.toString();

    ASSERT_EQ(blk.getHeight(), starting_height + i);
    blocks.push_back(blk);
  }

  auto bootstrap_chain = blocks;
  bootstrap_chain.resize(100);

  VbkBlockTree tree(
      vbkparam, btcparam, payloadsProvider, blockProvider, payloadsIndex);

  ASSERT_EQ(bootstrap_chain.size(), 100);

  ASSERT_TRUE(tree.bootstrapWithChain(starting_height, bootstrap_chain, state))
      << state.toString();

  for (size_t i = 100; i < blocks.size(); ++i) {
    ASSERT_TRUE(tree.acceptBlockHeader(blocks[i], state))
        << "block height: " << blocks[i].getHeight() << " " << state.toString();
  }
}

struct VbkTestCase {
  std::string headers;
  std::shared_ptr<VbkChainParams> params;
  uint32_t startHeight = 0;
  uint32_t offset = 0;

  std::vector<VbkBlock> getBlocks() const {
    std::vector<VbkBlock> ret;
    std::string data;
    std::istringstream file(headers);
    EXPECT_TRUE(!file.fail());
    while (file >> data) {
      auto v = ParseHex(data);
      if (v.empty()) {
        continue;
      }
      ret.push_back(AssertDeserializeFromRaw<VbkBlock>(v));
    }
    return ret;
  }
};

struct AcceptTest : public testing::TestWithParam<VbkTestCase>,
                    public BtcInvalidationTest {};

static std::vector<VbkTestCase> accept_test_cases = {
    /// mainnet
    {generated::vbk_blockheaders_mainnet_200001_230000,
     std::make_shared<VbkChainParamsMain>(),
     200001,
     0},
    {generated::vbk_blockheaders_mainnet_200001_230000,
     std::make_shared<VbkChainParamsMain>(),
     200001,
     3333},

    /// testnet
    {generated::vbk_blockheaders_testnet_0_10000,
     std::make_shared<VbkChainParamsTest>(),
     0,
     0},
    {generated::vbk_blockheaders_testnet_0_10000,
     std::make_shared<VbkChainParamsTest>(),
     0,
     3333},
};

// Read Vbk_blockheaders file.
// TODO(warchant): disabled because vbk_blockheader* contain pre-progpow data
TEST_P(AcceptTest, DISABLED_BootstrapWithChain) {
  auto value = GetParam();
  auto allblocks = value.getBlocks();

  // skip first `offset` blocks
  allblocks =
      std::vector<VbkBlock>{allblocks.begin() + value.offset, allblocks.end()};

  // make a bootstrap chain by taking first `numBlocksForBootstrap` x2 blocks
  // due to forked blocks we take twice the blocks and expect to collect
  // at least `numBlocksForBootstrap` blocks
  auto bootstrapChain = allblocks;
  bootstrapChain.resize(value.params->numBlocksForBootstrap() * 2);

  ASSERT_GE(allblocks.size(), value.params->numBlocksForBootstrap() * 2);
  // make accept chain - the one that is applied on top of current blocktree
  // state
  std::vector<VbkBlock> acceptChain{
      allblocks.begin() + value.params->numBlocksForBootstrap() * 2,
      allblocks.end()};

  VbkBlockTree tree(
      *value.params, btcparam, payloadsProvider, blockProvider, payloadsIndex);

  ASSERT_TRUE(tree.bootstrapWithChain(
      bootstrapChain[0].getHeight(), bootstrapChain, state))
      << state.GetPath();
  EXPECT_TRUE(state.IsValid());
  size_t totalBlocks = bootstrapChain.size();

  ASSERT_TRUE(tree.getBestChain().tip());
  EXPECT_EQ(tree.getBestChain().tip()->getHeader(),
            bootstrapChain[bootstrapChain.size() - 1]);
  EXPECT_EQ(tree.getBestChain().tip()->getHeight(),
            bootstrapChain[bootstrapChain.size() - 1].getHeight());

  for (const auto& block : acceptChain) {
    ASSERT_TRUE(tree.acceptBlockHeader(block, state))
        << "block #" << totalBlocks << "\n"
        << "stack trace: " << state.GetPath() << ", "
        << "message: " << state.GetDebugMessage();
    EXPECT_TRUE(state.IsValid());

    // we are not sure that block gets to the main chain. Make sure it at least
    // exists
    if (tree.getBestChain().tip()->getHeader() != block) {
      EXPECT_NE(tree.getBlockIndex(block.getHash()), nullptr);
    }

    EXPECT_EQ(tree.getBestChain().tip()->getHeight(), block.getHeight());
    ++totalBlocks;
  }
}

INSTANTIATE_TEST_SUITE_P(AcceptBlocksRegression,
                         AcceptTest,
                         testing::ValuesIn(accept_test_cases));
