// Copyright (c) 2019-2022 Xenios SEZC
// https://www.veriblock.org
// Distributed under the MIT software license, see the accompanying
// file LICENSE or http://www.opensource.org/licenses/mit-license.php.

#include <gtest/gtest.h>

#include <veriblock/pop/crypto/progpow.hpp>
#include <veriblock/pop/serde.hpp>
#include <veriblock/pop/uint.hpp>

using namespace altintegration;

struct TestCase {
  std::string header;
  int64_t seed;
  std::string digest;
  std::string result;
};

// clang-format off
static std::vector<TestCase> cases = {
      // header, seed, digest, resulting hash
     {"0000000000000000000000000000000000000000000000000000000000000000",0,"0000000000000000000000000000000000000000000000000000000000000000", "5af53fe6614cf3af9b44b6775a2647f5b09de97542ee8c0ae5250f0f21ca1bca"},
     {"ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",9223372036854775807,"ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff", "10a107c4dbfd32e6346e70784c64681c7a432b60800c8568940d2882dc8dee83"},

     // random cases
     {"d3c85a8416d0186a95837afdc114497e499b459fbc1af658e204f9dc969c1f51",-6126916588805550619,"a9c438fdb28abb77db8d86bf31e0fabc44cbd584a5ef78888206e854b8cbb129", "672ee60e3422a5219144b845b736ed155181827c302ef71d95ef90dc41007680"},
     {"d8c87b2b2f133d056b8e7d8908ed826d8151ea96fbff7710ba034f4775b80c67",-4536178499253017510,"ad2ebf0b83132569ce32f4d06b9b56434d63c9462bdfc7df5c484131fb09d716", "947e326df4ce4b48952c04796625aebf8a40cafafcbeda7a4ba961b73a8ebabd"},
     {"68c572fbee578d70b86e0932d2b858c4531f29a4867aed8573249051ecaef1b6",3242391464250492886,"fb447e7878c3325c08cd74bed77e3c1f8d91345c29908ad29cd9a84abc17b349", "9fc7437e7213ebd76a830d4010cc725d35c1b9ddfa34c486e30c808b35e1308a"},
     {"85a679f5aa88621ff993fe2e6931f5369ff2d0b9ae79a82d431c87ede12d774e",2339435421584887068,"b171c33bf17684f0cbb98acc3cccde14d896f2a579ff355178a5759783fd28b9", "db8d44f315080132f1b906c7974f976de4824069422e5beb9a39f970fb8e6efc"},
     {"bcd5fe38f984f889560a53a469f0bf4177a6b078c9a7c8b5556b945480743970",3359944615364809642,"edfaf80cc145bb6a53e771420b66f462a3ac620863b85a4d84ff22acc4edc09c", "c86a8b958d0fa31e3fb63e502e4f10d08099268b2dfce4efc2ef0e8773520b95"},
     {"6449929365b51e89c9b07f315e1fd393748469cc07e44f7ce1d4c2d824b316de",-4309971127550190856,"faceb6ad01de3255d358c87cf8d7dd6f157a45aa1932bfd8cdd4622c0a117f74", "8bad39f9e8e055a13342a0c1f2eb8e3f83aea657c84641cf3e5ac1d8e47b61eb"},
     {"4fba1bc31cd6b7f0d9a4fa7a5f771834d7623d915cd0b846abccc794092df258",4996182085645919665,"bc8e7fc5c90da196a6e6848c945b42fe706b55cff8a109851275f5d4bb9693c3", "f61c11bfb0e629229a2d3abb8375c76084c47cb21d78f898ffbaef0451112273"},
     {"8d26a3ce81a63f1e25f11e898013a3eb2605588f4ffedda2558428d058d4ad81",7532021596134790108,"b43ad8c6d0f743dec0ba575f93b17ce76113f28d28eb6d79125f4cee29ceb62d", "3b07dfa2b117b09db9e3bd83818d16c2e243bcc3e2d4f0243dce8ee0b0f6de9e"},
     {"710afeaa45a37a7c9f8624dd5576f1c7520de46cb96adf57556ecbe126b2b45d",-8172699984539320093,"9f7af8d9e4486e3e6b8d2a93b96770ff81ea81e25ba9edb8bc3cafe7f41d2437", "d755cf5df086f15605954ed8574e16a048eaee56dfdb586314fef17268195e0e"},
     {"213b736b30b32a516a8df7c42d036d6bb907c7e5533acd61262cbd9f4e9b9563",4950039597075672287,"48beb226e43391dc97b630f556f9d56a48c6685b79b968eeb070a7939f4a0680", "ebec4360f01385546760ec4994c202df9b283fa489696f7ab4acb710b2e167d1"},
     {"818ec86c5b4a3891818a15da64f14461078b0b4639ffcd1543761d692747958b",5653941867970225324,"83ddbef218fd5355a405c7f953068eac17c70f3fceeb446118927498e735b4eb", "81d6d5c834d0f7488b6801e5ac26144c36272cca7d31f26456e4d5f2d8dd9cfb"},
     {"666860bd274fd16ba2c25421ac5439ada5ff41c76c22b3991e6bc5d88a493a6f",359472576127199222,"3e0716dc0fbe6a7e270eab7851cedcc20c6528812e69fc3fec6847fc51044e70", "bd976d9be7b2c34220774f158c0016d480911e20feeb7bc81585f799fa5439fa"},
     {"cefb1f9c387ace00dab67dd2e6f37b9949de98c9c635d6fba09f5405aa2d03c5",5868322767864343707,"c5349c7215fd1b5e6690f7c3939d1a7b3c4b8af2fbf1d05c95adfde9a03c578a", "e1e2be1732bf4f7bf5597ebbdcc45044f36627e3e76885ae062d0decc80f96dc"},
     {"20604402b86057168f077deaf5e93b5b813352cd6e0979368e4495f03ad5e316",2477758930813806865,"f5ddd83c769bc84534f794a63b620e04c677c2ec699e54dd5d55389e6b9efad6", "970481c0eb83fc3321d673b1d6383fcb46193524dfd882dd877e959b24150f78"},
     {"799456df15faa9b80974c15f6212e5be5936d47010f661db11ed61590e392ad4",1681336440173776092,"ee5cf26a6efaf08cc5b9f65ffa056e997735a500a9acfc03a5fec78b13901e0c", "7e9fb37457bfd713c01b3ff06702aa7ee8af4ee69534c959fa1ce1c3eb0517b7"},
     {"2e1aa0825dd0790a2fdc3be74e40e6d02885070c68cb9d5f48e8526bb60ce90d",-3091084895265327068,"08eed1a023ad462d685c305f8b3a7d495f98d83592ae5ff7edf299d5c6f4afe6", "69ac9e0826d8093fe6f2a121f55c98355b69c29275363710e9eda9bd4c3fe3e4"},
     {"577b04418e3567ea441a12d557b0f7912eb8453b9ad0b6b7092957fe384c2789",5876873422760558931,"be371a60f675ad082e0953ea74967fa4a785dceeab54c38b6e7d803ace2d7b78", "2fba6a481798139e64121ebad02dccb66389874f32051e40bc59d3ab7c1bc02a"},
     {"1825fd14a5aebd066a6d949512135c742fdd3704a85d983f37a17c0774fad7b0",3342677059755920108,"8e5eeb4a9afbd752546b06b50baa92251c92e30aed28eff7bb514758cf94f4bc", "442f726c34af3f03ad09b17cca8a10f1bbdaeb84dcfac7c9c586039d608a0cda"},
     {"2c4c6f4dbd094f4239c14e8ddacb73ac8192fecf3187fe5bacb363d4708104bc",-1574567229065397445,"9ec5e70d3c1ddc7cb0d38c4f03b92ba9a4c8ca22dd8331a854379b204358218d", "915d94ab913060803b1247ead5de78e65bf926c647c3c22eaaa42dcfc6409219"},
     {"037e7dcc684de7b8e414e04dbb4fe0744084946b5a5456d8763f6a3e8ea69ecb",7326494332771359187,"cde16b4137d834fd7a4ae94d0a8dccde40bc8b8ecabef8edc8c87707fdd70b0b", "5e2e8c4d2951f1790e6dd4e7f07b999944cba09c9e76dae038ce802d4f8c96f6"},
     {"6ed7b1afd64de3f05f6efe1c81c827244ccc5e59c78a8ad4be091d843502b0c2",4231334339124196076,"67700ded9ea90d00f4ce1f5db2901900083fa43f3e685caa4b511231161efc83", "5561c30758778343df482a090040ea8fca824ff7a170e835015a796f1c1e9145"},
     {"cf08277fa0d5dba9fcce0d3b4755a6087bb3221b771e215c28b882dbe846576b",-7549404023707589594,"ef39fc855541a51007d1204b3165d25720a98be3ec5388c7299f3d421b2571a6", "f052d8c37811f7d9819eb1fcdda6426aa4205f458fa28eab0f6476f8d5c1da08"},
     {"98961d174a690a4b0435d64145d6a76b841cf1ed54c8637bbde89cc1ffde7a52",-585673418425147717,"e7889bdfc9ce14d355c84ebc0eb8e447f47980f39bb997c5922e91c5cb78d4d0", "fdb7c98e3795f3e5b4d12fdae8733ff803991afa2b1fd4572c395b3423e22c18"},
     {"f2075e2b840acccfba33f89a2b8b6a7c5727efc79e6f7f8d56aaef819efb922d",-1327134673702152359,"564f47f6a877bdd5f667b8e7e0c24bba8d643dc2d4d2fd77d189b3cd4340c38f", "41d913279dfd0c58f9f9dc99803933a9f4da07261f6118ff317837f6c8bff995"},
     {"9bdc4fbd20c9902ad0d21467f53cecc753726071b6d525b6e1b9b28683ddc861",3219242056551009962,"6a353287d89373ecf8e0ba69cc3c0cf6696b2cfdbd71d6eb428b917c5f9ca38f", "a7e2624d27e57f981762f8e087deb3f8a816178ecda456c8da569544b57502b6"},
     {"aa9053643a9492457231a9dcafec5bdd61dd020d1b8e7124864a5da5d23bba84",-3885063227821981978,"35ff5d3cf4bcd920a91a630f228c018997edb9ef598cb1d3b7ae38988aec200a", "26edaf98ceb4ebdc19515c2f004e20f553e45671f0585078f0d7e2784d6dc192"},
     {"190f49414f62be3f52d07351b0efe4899d40a48423ff015ad4acadcd20ddc643",-404913936791158541,"e01480d322096254e9cf8bfcb98a78fb197adb11e928ae094e91b7104fa5bc49", "d1240016a94aa23130a35815a435862b95b225756f5d9212bebad4e712aa72ed"},
     {"7e14ca9d37b17647c63ecb4d5041213d2e7355d733b9e18340b4e7123194e830",-2794631671978563827,"dc48e8791a13c4d33e625a59ed8856fb1170982468bb1d5950fc9dd8e4075973", "ca7755f80f2578320a2fd38eb9edcab840512a5c888931b2cbd02fc1a6a2b1d2"},
     {"bfe00e7007c13e8841a500093b4661d98e50a700f648cbfc67df83f55fc2c45b",1801311179698398296,"ca4b090098e81f4564fb4b5801fa3c1f511c1313b4beadbc90ff8959ae5e1840", "275ef726d678aee4b1cac29f70549d03707ce7c23e3419d94f21136d81b99f8b"},
     {"c2839de2a22200cb1f6857b34572e9447f2261592ac9779038ef493f30bcd0fb",-2926623476145386208,"1e9efc9911d965898f71fd569c4ab3cf9a9de93d4e3b6105a9f2ffb4f1669131", "117c3e5661ff2f1490ed2a7e3a2d7cdd7ca40e7a31134acb7462fdd8a8fb7ef4"},
     {"bfd2b73b0238d826b802792a182d80183f085e6599f74f2b00679000c53223a6",3076212241430148106,"59a58cf2212b7337bef4996d67add29f17cd6f8ba0853ae55c2acf7442d9018d", "4bae00578f1f684d2f9b8104da5b48186e8cd2847c27340cbf8186348c38c7af"},
     {"54699118655e75a6ca79edc50ebf2fba4038d1a6989a1548356b4e513ea87450",5733875543662024673,"9a989dc2a3fe2dcbaed97cd1deceec4fd2f14a4f7307b41155a78569fab3ce45", "458e77b83c5372106abc3e2308807e31b310c526b7a90bf6e5630fe7edf79d65"},
     {"1c361fe6dfcdcfd3e6e9bdbd8f421c456f00be8efabd5f4e6afad87ecda2d738",2675422231795683209,"f7194fe4387890fb1d6fc124b46ce3e3bb1778ffeec91b5ca9746973dd8890d7", "f2cb7a76950768ce0532c114b65c69227369a64cab12c39284d9cd6d5937cd1c"},
     {"4d72ade799e81194c9fb856c73cb8680a22509eee900068ad96802b702f36b89",1661645486857506027,"2b45edbba5442cf782ec03917c2b96ecccc57bf349ce0499dad402f58def3b4e", "a40dd96ebc9e8d6ad8a2f99e9fbee0960ff69300417da0b9b11de39ada525abf"},
     {"54f5784611308ea22e9da827c6ab576ce2f21c03416d1fc0735e6e483da617de",3869850698529106159,"b81fed4e1fe2c3993a6cfb08f335d5bc9a5fa0ced994971918fb75c817dd868c", "1b0bba542bb2a819ac22768e7f308c5be903350d7afb39f82ed9bc18d0dcc170"},
     {"24db055dec7e25b53841dfaf69656385ca3f534f8777e066648785c971819761",-4808489319075678650,"2becadc2e223fce2cc49b301d9db6de8ce861f825c394104af5791d1e0e98578", "9d0487e1811eb6b3602e63abfe5eb1b8e93797a1989f58d16661c15f982ba15f"},
     {"c955f3bd17083c0ac1ae481850fde290c38022f7ae4ce6a74b1dcdc4ac07710b",5122343667683920846,"921d9a4acca626137ff7ea2489e5f699462ac0999a2a0262810e497ca2f93063", "9eba265a464f764aeb9ea5029c07464f72783af226a270ee732ec0120e890faf"},
     {"97d3c8b4428174037d47b31b68ffa7317d6573f9acd81430be7a47b00fe8ed46",4841847324917508870,"e03851658c3cb7f913fbd44837153ee3dbc4d2002da8daa52250829405868a3c", "dded30c1921dfcafea53ab9ab8baaebee9d6b24e30af411d64518996e4860e86"},
     {"cbf97adda9a17cd7b559f893bd7a164353d506c92f9911bf942180fa8cbfd24b",8890870729843549510,"e74c633528aa8c3bc579d6ad2e67bbde91998c3bc3dd59aaf960392159e4bb17", "9fc549d18a8fd57bd3be92360fee8f4bd36eb52693f5d395bb37b05accb5683b"},
     {"789fc3c9a65fc770e3dd8ba58482148ee9055508ec5eacf7bba43bc6952d2daf",-7631119495856817950,"c3cb403d06920310b125e05d5d9ead23006ec4742be884d5a5c09d8b60a61548", "be93e4f10136a2cc763fc0650f92ec91982511dc8e008d4db590b7888d5e5789"},
     {"a14957cabaaa422c0694e14fcd0a152de9dddfc6262373fd2186d244f59e7eb0",-1911482456546658202,"4fe11c0df8afbbb2405a6d3ec6d409c0acc4fde3620ac9d87612260ceff1b454", "646cc2c3dfd48d5e6c3e6ab0c3d2c344e1ec9cd14786fa7a9aae358ae7e7a04b"},
     {"4834e9883ed707af1651141dc2bfeabc93fcc6878af36f9b5f524d3a3f2c7da5",7738286171185204531,"591d62815c678baf71c256ad9b1ab50c1d2cc98d3b6e70cfc54fe9366193ce1f", "7871ad56ad3d1e70c8eb24236457124830bbb250a8eeec0a3c9fd26e8b35aafe"},
     {"b231fe94f196a9f40cccca68e5e35be425560c689b931a64d2ca4ddc32d60694",6652732222382885526,"15e6da0e7b5a3828f10071367000554f099c89028d40833e106c99f68cb37d51", "8246c8899b9f41fa40e6a32daeccde11cabb28869fbf3a3ec5f989aa8620a5dc"},
     {"939984ced2275bef9f651ffa2d0e65223b5a6d74dc3fedc4ea318103b7d2c01b",8311962760340229501,"467d8cf47ac6af5a02e6491d02ec35c1cbbeb055b2789d32af778aa563048bbf", "d1b45f712c80da886c0ff93b0e98636f7bd418d8c8279c5917b02d0f2dd5557c"},
     {"2ff6dbcb16e78cc9baff8e448f1d96b39eb41fd9c4a4480a50d3d3e6977bf999",-6053566537606872388,"78664dc9e838a27e7f8ec4a955b833fc8e9b8652ed3af79a7957de5738cbd177", "0a3381a117d1664694eaf217bad31612231569d3ffb3c47a9732280e5cede908"},
     {"3d025be774dda547c52e8e3af561d3b1416bc248c84dd3da4f5c2ba6c51f3ae7",-4534775369432401925,"1f6ec0271d8d1b81cb96cdab318eee595bca880faf7e302ed248ac0039da1c48", "eb1cda74dc688265509e55fc20c443fc30572d1faaa7b63ba064236a3edc8025"},
     {"f6c74227e741a2bd13cb21ce848be201885d4cd959b397b8c41f84b64c582481",7873706177752934332,"f5d4c14a856ecc754a8d1341fc7047c4c4f0ce9326db6cd0acd78d5636b06dc9", "c83703d7d2c9b7b205d1c04e9c3cdb284eb21240ed48adcb7cf49f7247287f9b"},
     {"63f6b42f1215133a3bdaed277b2257fbf5318770c9874c5b2440f06abce8ac79",8603446577832841585,"1d681835d68d24cfacf58dda466ab601a1706197299723620a5d12b0dee9806f", "a6dee0b33dcacc183c6556bf099d564d6027cd32c74242bbc79e53ef206b740a"},
     {"2d63bd735dece00b4ea005772d65c5df9a8642256666eeb9a262549cf8dfae57",7172738708615680038,"536eb195d397e4642e3ca01603f3dd871c7c888e3e20061583a52eac7932810b", "7c7acf94c4c8709e9b504e885d7842d401dc603e443d073087211780d797e621"},
     {"e6395adad00a188021d6ef6e980be7d01c51ef8a25002d72497e188f88b829d5",2847542277649005357,"ac22799c9b92c6c0c8bb464ba94618a28ac0c3dba133f50b71d5130a9e332137", "9f360ccd618394002b66c4d8e49fa62c9dafa1ba77b07f593d9ba327ed7f1e10"},

};
// clang-format on

class KeccakF800ProgPowTest : public testing::TestWithParam<TestCase> {};

using namespace altintegration;
using namespace progpow;

template <typename F>
hash32_t h32(const std::string& hex, F&& read) {
  auto bytes = ParseHex(hex);
  auto rs = ReadStream(bytes);
  return read(rs);
};

TEST_P(KeccakF800ProgPowTest, Regression) {
  auto [strheader, seed, strdigest, strresult] = GetParam();

  uint256 header = uint256::fromHex(strheader);
  hash32_t digest = h32(strdigest, hash32_t::readBE);
  hash32_t expected = h32(strresult, hash32_t::readLE);

  auto actual = keccak_f800_progpow(header, seed, digest);

  ASSERT_EQ(actual, expected);
}

INSTANTIATE_TEST_SUITE_P(KeccakF800ProgPowRegression,
                         KeccakF800ProgPowTest,
                         testing::ValuesIn(cases));

TEST(Keccakf800, Clean) {
  std::array<uint32_t, 25> state;
  state.fill(0);

  progpow::keccak_f800(state);

  std::array<uint32_t, 25> expected = {
      3862951258, 2951957601, 2008433819, 4115080794, 1978244528,
      177008194,  252650981,  3390818849, 2139734057, 806190684,
      2209148374, 2703569168, 3917804035, 3765745170, 2483533422,
      2038318991, 4055630062, 2767721948, 3025020584, 1992936516,
      2077006690, 292028324,  4288187762, 1668100165, 2301094675};

  ASSERT_EQ(state, expected);
}
