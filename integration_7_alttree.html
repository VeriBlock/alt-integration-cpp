<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>veriblock-pop-cpp: AltTree management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="main.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">veriblock-pop-cpp
   </div>
   <div id="projectbrief">C++11 Libraries for leveraging VeriBlock Proof-Of-Proof blockchain technology.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('integration_7_alttree.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">AltTree management </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md63">Overview</a></li>
<li class="level1"><a href="#autotoc_md64">1. Implement AltTree related methods in the pop_service.hpp and pop_service.cpp source files.</a></li>
<li class="level1"><a href="#autotoc_md65">2. Update block processing in the ConnectBlock(), DisconnectBlock(), UpdateTip(), LoadGenesisBlock(), AcceptBlockHeader(), AcceptBlock(), TestBlockValidity().</a></li>
<li class="level1"><a href="#autotoc_md66">3. Show Pop related info when node starts.</a></li>
<li class="level1"><a href="#autotoc_md67">4. Update Pop logging support.</a></li>
<li class="level1"><a href="#autotoc_md68">5. Add unit tests to test the functionality we have added before.</a></li>
<li class="level1"><a href="#autotoc_md69">6. Add test case which tests the VeriBlock Pop behaviour: e2e_poptx_tests.cpp.</a></li>
<li class="level1"><a href="#autotoc_md70">7. Update makefile to enable new unit test.</a></li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_families_btc_integration_7_alttree"></a></p>
<h1><a class="anchor" id="autotoc_md63"></a>
Overview</h1>
<p >At this stage we should add functions for maintaining the VeriBlock AltTree: <code>setState()</code>, <code>acceptBlock()</code>, <code>addAllBlockPayloads()</code>. They provide API to change the state of the VeriBlock AltTree.</p>
<ul>
<li><code>acceptBlock()</code> - adds an ALT block into to the library.</li>
<li><code>addAllBlockPayloads()</code> - adds popData for the current ALT block into the library and should be invoked before <code>acceptBlock()</code> call.</li>
<li><code>setState()</code> - changes the state of the VeriBlock AltTree as if the provided ALT block was the current tip of the blockchain.</li>
</ul>
<h1><a class="anchor" id="autotoc_md64"></a>
1. Implement AltTree related methods in the pop_service.hpp and pop_service.cpp source files.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.hpp</a> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;vbk/adaptors/payloads_provider.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vbk/util.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line">+<span class="keyword">class </span>BlockValidationState;</div>
<div class="line">+<span class="keyword">class </span>CBlock;</div>
<div class="line"> <span class="keyword">class </span>CBlockTreeDB;</div>
<div class="line"> <span class="keyword">class </span>CDBIterator;</div>
<div class="line"> <span class="keyword">class </span>CDBWrapper;</div>
<div class="line">+<span class="keyword">class </span>CBlockIndex;</div>
<div class="line">+<span class="keyword">class </span>CChainParams;</div>
<div class="line">+</div>
<div class="line">+<span class="keyword">namespace </span>Consensus {</div>
<div class="line">+<span class="keyword">struct </span>Params;</div>
<div class="line">+}</div>
<div class="line">+</div>
<div class="line"> <span class="keyword">namespace </span>VeriBlock {</div>
<div class="line"> </div>
<div class="line">+<span class="keyword">using </span>BlockBytes = std::vector&lt;uint8_t&gt;;</div>
<div class="line">+<span class="keyword">using </span>PoPRewards = std::map&lt;CScript, CAmount&gt;;</div>
<div class="line">+</div>
<div class="line"> <span class="keywordtype">void</span> InitPopContext(CDBWrapper&amp; db);</div>
</div><!-- fragment --> <div class="fragment"><div class="line"> <span class="keywordtype">bool</span> loadTrees(CDBWrapper&amp; db);</div>
<div class="line"> </div>
<div class="line">+</div>
<div class="line">+<span class="keywordtype">bool</span> acceptBlock(<span class="keyword">const</span> CBlockIndex&amp; indexNew, BlockValidationState&amp; state);</div>
<div class="line">+<span class="keywordtype">bool</span> addAllBlockPayloads(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state);</div>
<div class="line">+<span class="keywordtype">bool</span> setState(<span class="keyword">const</span> uint256&amp; block, <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a>&amp; state);</div>
<div class="line">+</div>
<div class="line">+std::vector&lt;BlockBytes&gt; getLastKnownVBKBlocks(<span class="keywordtype">size_t</span> blocks);</div>
<div class="line">+std::vector&lt;BlockBytes&gt; getLastKnownBTCBlocks(<span class="keywordtype">size_t</span> blocks);</div>
<div class="line"> } <span class="comment">// namespace VeriBlock</span></div>
<div class="ttc" id="aclassaltintegration_1_1ValidationState_html"><div class="ttname"><a href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a></div><div class="ttdoc">Class that is used for storing validation state.</div><div class="ttdef"><b>Definition:</b> <a href="validation__state_8hpp_source.html#l00028">validation_state.hpp:28</a></div></div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.cpp</a> </p><div class="fragment"><div class="line">+<span class="keywordtype">bool</span> acceptBlock(<span class="keyword">const</span> CBlockIndex&amp; indexNew, BlockValidationState&amp; state)</div>
<div class="line">+{</div>
<div class="line">+    AssertLockHeld(cs_main);</div>
<div class="line">+    <span class="keyword">auto</span> containing = VeriBlock::blockToAltBlock(indexNew);</div>
<div class="line">+    <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a> instate;</div>
<div class="line">+    <span class="keywordflow">if</span> (!GetPop().getAltBlockTree().acceptBlockHeader(containing, instate)) {</div>
<div class="line">+        LogPrintf(<span class="stringliteral">&quot;ERROR: alt tree cannot accept block %s\n&quot;</span>, instate.toString());</div>
<div class="line">+        <span class="keywordflow">return</span> state.Invalid(BlockValidationResult::BLOCK_CACHED_INVALID, instate.GetPath());</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">+}</div>
<div class="line">+</div>
<div class="line">+<span class="keywordtype">bool</span> addAllBlockPayloads(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div>
<div class="line">+{</div>
<div class="line">+    AssertLockHeld(cs_main);</div>
<div class="line">+    <span class="keyword">auto</span> bootstrapBlockHeight = GetPop().getConfig().getAltParams().getBootstrapBlock().height;</div>
<div class="line">+    <span class="keyword">auto</span> hash = block.GetHash();</div>
<div class="line">+    <span class="keyword">auto</span>* index = LookupBlockIndex(hash);</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">if</span> (index-&gt;nHeight == bootstrapBlockHeight) {</div>
<div class="line">+        <span class="comment">// skip bootstrap block block</span></div>
<div class="line">+        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a> instate;</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">if</span> (!GetPop().check(block.popData, instate)) {</div>
<div class="line">+        <span class="keywordflow">return</span> error(<span class="stringliteral">&quot;[%s] block %s is not accepted because popData is invalid: %s&quot;</span>, __func__, block.GetHash().ToString(),</div>
<div class="line">+            instate.toString());</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    GetPop().getAltBlockTree().acceptBlock(block.GetHash().asVector(), block.popData);</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">+}</div>
<div class="line">+</div>
<div class="line">+<span class="keywordtype">bool</span> setState(<span class="keyword">const</span> uint256&amp; block, <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a>&amp; state) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div>
<div class="line">+{</div>
<div class="line">+    AssertLockHeld(cs_main);</div>
<div class="line">+    <span class="keywordflow">return</span> GetPop().getAltBlockTree().setState(block.asVector(), state);</div>
<div class="line">+}</div>
<div class="line">+</div>
<div class="line">+std::vector&lt;BlockBytes&gt; getLastKnownVBKBlocks(<span class="keywordtype">size_t</span> blocks)</div>
<div class="line">+{</div>
<div class="line">+    LOCK(cs_main);</div>
<div class="line">+    <span class="keywordflow">return</span> <a class="code hl_function" href="namespacealtintegration.html#a7eb238ddcf054d27a95aee94d9b362bb">altintegration::getLastKnownBlocks</a>(GetPop().getVbkBlockTree(), blocks);</div>
<div class="line">+}</div>
<div class="line">+</div>
<div class="line">+std::vector&lt;BlockBytes&gt; getLastKnownBTCBlocks(<span class="keywordtype">size_t</span> blocks)</div>
<div class="line">+{</div>
<div class="line">+    LOCK(cs_main);</div>
<div class="line">+    <span class="keywordflow">return</span> <a class="code hl_function" href="namespacealtintegration.html#a7eb238ddcf054d27a95aee94d9b362bb">altintegration::getLastKnownBlocks</a>(GetPop().getBtcBlockTree(), blocks);</div>
<div class="line">+}</div>
<div class="ttc" id="anamespacealtintegration_html_a7eb238ddcf054d27a95aee94d9b362bb"><div class="ttname"><a href="namespacealtintegration.html#a7eb238ddcf054d27a95aee94d9b362bb">altintegration::getLastKnownBlocks</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; uint8_t &gt; &gt; getLastKnownBlocks(const BlockTree &amp;tree, size_t size)</div><div class="ttdoc">helper to get last N known block hashes</div><div class="ttdef"><b>Definition:</b> <a href="alt-util_8hpp_source.html#l00042">alt-util.hpp:42</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md65"></a>
2. Update block processing in the ConnectBlock(), DisconnectBlock(), UpdateTip(), LoadGenesisBlock(), AcceptBlockHeader(), AcceptBlock(), TestBlockValidity().</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L1661">method CChainState::DisconnectBlock</a> </p><div class="fragment"><div class="line">+    <span class="keyword">auto</span> prevHash = pindex-&gt;pprev-&gt;GetBlockHash();</div>
<div class="line">+    <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a> state;</div>
<div class="line">+    VeriBlock::setState(prevHash, state);</div>
<div class="line">+</div>
<div class="line">     <span class="comment">// move best block pointer to prevout block</span></div>
<div class="line">-    view.SetBestBlock(pindex-&gt;pprev-&gt;GetBlockHash());</div>
<div class="line">+    view.SetBestBlock(prevHash);</div>
<div class="line"> </div>
<div class="line">     <span class="keywordflow">return</span> fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L1879">method CChainState::ConnectBlock</a> </p><div class="fragment"><div class="line">+    <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a> _state;</div>
<div class="line">+    <span class="keywordflow">if</span> (!VeriBlock::setState(pindex-&gt;GetBlockHash(), _state)) {</div>
<div class="line">+        <span class="keywordflow">return</span> state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, <span class="stringliteral">&quot;bad-block-pop&quot;</span>, strprintf(<span class="stringliteral">&quot;Block %s is POP invalid: %s&quot;</span>, pindex-&gt;GetBlockHash().ToString(), _state.toString()));</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="keywordflow">if</span> (!control.Wait()) {</div>
<div class="line">         LogPrintf(<span class="stringliteral">&quot;ERROR: %s: CheckQueue failed\n&quot;</span>, __func__);</div>
<div class="line">         <span class="keywordflow">return</span> state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, <span class="stringliteral">&quot;block-validation-failed&quot;</span>);</div>
<div class="line">     }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L2360">method UpdateTip</a> </p><div class="fragment"><div class="line">         g_best_block_cv.notify_all();</div>
<div class="line">     }</div>
<div class="line">+    <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a> state;</div>
<div class="line">+    <span class="keywordtype">bool</span> ret = VeriBlock::setState(pindexNew-&gt;GetBlockHash(), state);</div>
<div class="line">+    assert(ret &amp;&amp; <span class="stringliteral">&quot;block has been checked previously and should be valid&quot;</span>);</div>
<div class="line"> </div>
<div class="line">     std::string warningMessages;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L2360">method UpdateTip</a> </p><div class="fragment"><div class="line">-    LogPrintf(<span class="stringliteral">&quot;%s: new best=%s height=%d version=0x%08x log2_work=%.8g tx=%lu date=&#39;%s&#39; progress=%f cache=%.1fMiB(%utxo)%s\n&quot;</span>, __func__,</div>
<div class="line">-      pindexNew-&gt;GetBlockHash().ToString(), pindexNew-&gt;nHeight, pindexNew-&gt;nVersion,</div>
<div class="line">-      log(pindexNew-&gt;nChainWork.getdouble())/log(2.0), (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)pindexNew-&gt;nChainTx,</div>
<div class="line">-      FormatISO8601DateTime(pindexNew-&gt;GetBlockTime()),</div>
<div class="line">-      GuessVerificationProgress(chainParams.TxData(), pindexNew), ::ChainstateActive().CoinsTip().DynamicMemoryUsage() * (1.0 / (1&lt;&lt;20)), ::ChainstateActive().CoinsTip().GetCacheSize(),</div>
<div class="line">-      !warningMessages.empty() ? strprintf(<span class="stringliteral">&quot; warning=&#39;%s&#39;&quot;</span>, warningMessages) : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"> </div>
<div class="line">+    <span class="keyword">auto</span>&amp; pop = VeriBlock::GetPop();</div>
<div class="line">+    <span class="keyword">auto</span>* vbktip = pop.getVbkBlockTree().getBestChain().tip();</div>
<div class="line">+    <span class="keyword">auto</span>* btctip = pop.getBtcBlockTree().getBestChain().tip();</div>
<div class="line">+    LogPrintf(<span class="stringliteral">&quot;%s: new best=ALT:%d:%s %s %s version=0x%08x log2_work=%.8g tx=%lu date=&#39;%s&#39; progress=%f cache=%.1fMiB(%utxo)%s\n&quot;</span>, __func__,</div>
<div class="line">+        pindexNew-&gt;nHeight,</div>
<div class="line">+        pindexNew-&gt;GetBlockHash().GetHex(),</div>
<div class="line">+        (vbktip ? vbktip-&gt;toShortPrettyString() : <span class="stringliteral">&quot;VBK:nullptr&quot;</span>),</div>
<div class="line">+        (btctip ? btctip-&gt;toShortPrettyString() : <span class="stringliteral">&quot;BTC:nullptr&quot;</span>),</div>
<div class="line">+        pindexNew-&gt;nVersion,</div>
<div class="line">+        log(pindexNew-&gt;nChainWork.getdouble()) / log(2.0), (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)pindexNew-&gt;nChainTx,</div>
<div class="line">+        FormatISO8601DateTime(pindexNew-&gt;GetBlockTime()),</div>
<div class="line">+        GuessVerificationProgress(chainParams.TxData(), pindexNew), ::ChainstateActive().CoinsTip().DynamicMemoryUsage() * (1.0 / (1 &lt;&lt; 20)), ::ChainstateActive().CoinsTip().GetCacheSize(),</div>
<div class="line">+        !warningMessages.empty() ? strprintf(<span class="stringliteral">&quot; warning=&#39;%s&#39;&quot;</span>, warningMessages) : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"> }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3659">method BlockManager::AcceptBlockHeader</a> </p><div class="fragment"><div class="line">     <span class="keywordflow">if</span> (ppindex)</div>
<div class="line">         *ppindex = pindex;</div>
<div class="line"> </div>
<div class="line">+    <span class="keywordflow">if</span> (!VeriBlock::acceptBlock(*pindex, state)) {</div>
<div class="line">+        <span class="keywordflow">return</span> error(<span class="stringliteral">&quot;%s: ALT tree could not accept block ALT:%d:%s, reason: %s&quot;</span>, __func__, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString(), state.ToString());</div>
<div class="line">+    }</div>
<div class="line">     <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3796">method CChainState::AcceptBlock</a> </p><div class="fragment"><div class="line">         <span class="keywordflow">return</span> error(<span class="stringliteral">&quot;%s: %s&quot;</span>, __func__, FormatStateMessage(state));</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">+    {</div>
<div class="line">+        <span class="keywordflow">if</span> (!VeriBlock::addAllBlockPayloads(block, state)) {</div>
<div class="line">+            <span class="keywordflow">return</span> state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, <span class="stringliteral">&quot;bad-block-pop-payloads&quot;</span>,</div>
<div class="line">+                strprintf(<span class="stringliteral">&quot;Can not add POP payloads to block height: %d , hash: %s: %s&quot;</span>,</div>
<div class="line">+                    pindex-&gt;nHeight, block.GetHash().ToString(),</div>
<div class="line">+                    FormatStateMessage(state)));</div>
<div class="line">+        }</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">     <span class="comment">// Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3919">method TestBlockValidity</a> </p><div class="fragment"><div class="line">+    <span class="comment">// VeriBlock: Block that have been passed to TestBlockValidity may not exist in alt tree, because technically it was not created (&quot;mined&quot;).</span></div>
<div class="line">+    <span class="comment">// in this case, add it and then remove</span></div>
<div class="line">+    <span class="keyword">auto</span>&amp; tree = VeriBlock::GetPop().getAltBlockTree();</div>
<div class="line">+    <span class="keyword">auto</span> _hash = block_hash.asVector();</div>
<div class="line">+    <span class="keywordtype">bool</span> shouldRemove = <span class="keyword">false</span>;</div>
<div class="line">+    <span class="keywordflow">if</span> (!tree.getBlockIndex(_hash)) {</div>
<div class="line">+        shouldRemove = <span class="keyword">true</span>;</div>
<div class="line">+        <span class="keyword">auto</span> containing = VeriBlock::blockToAltBlock(indexDummy);</div>
<div class="line">+        <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a> _state;</div>
<div class="line">+        <span class="keywordtype">bool</span> ret = tree.acceptBlockHeader(containing, _state);</div>
<div class="line">+        assert(ret &amp;&amp; <span class="stringliteral">&quot;alt tree can not accept alt block&quot;</span>);</div>
<div class="line">+</div>
<div class="line">+        tree.acceptBlock(_hash, block.popData);</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">auto</span> _f = <a class="code hl_struct" href="structaltintegration_1_1Finalizer.html">altintegration::Finalizer</a>([shouldRemove, _hash, &amp;tree]() {</div>
<div class="line">+        <span class="keywordflow">if</span> (shouldRemove) {</div>
<div class="line">+            tree.removeSubtree(_hash);</div>
<div class="line">+        }</div>
<div class="line">+    });</div>
<div class="line">+</div>
<div class="line">     <span class="keywordflow">if</span> (!::ChainstateActive().ConnectBlock(block, state, &amp;indexDummy, viewNew, chainparams, <span class="keyword">true</span>))</div>
<div class="line">         <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="ttc" id="astructaltintegration_1_1Finalizer_html"><div class="ttname"><a href="structaltintegration_1_1Finalizer.html">altintegration::Finalizer</a></div><div class="ttdoc">Finalizer holds a function that is executed on Finalizer destruction.</div><div class="ttdef"><b>Definition:</b> <a href="finalizer_8hpp_source.html#l00018">finalizer.hpp:18</a></div></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L4177">method BlockManager::LoadBlockIndex</a> </p><div class="fragment"><div class="line">-        <span class="keywordflow">if</span> (pindex-&gt;IsValid(BLOCK_VALID_TREE) &amp;&amp; (pindexBestHeader == <span class="keyword">nullptr</span> || CBlockIndexWorkComparator()(pindexBestHeader, pindex)))</div>
<div class="line">-            pindexBestHeader = pindex;</div>
<div class="line">+        <span class="comment">// do not set best chain here</span></div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">// get best chain from ALT tree and update vBTC&#39;s best chain</span></div>
<div class="line">     {</div>
<div class="line">         AssertLockHeld(cs_main);</div>
<div class="line"> </div>
<div class="line">         <span class="comment">// load blocks</span></div>
<div class="line">         <span class="keywordflow">if</span>(!VeriBlock::loadTrees(blocktree)) {</div>
<div class="line">             <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">         }</div>
<div class="line">+</div>
<div class="line">+        <span class="comment">// ALT tree tip should be set - this is our last best tip</span></div>
<div class="line">+        <span class="keyword">auto</span>* tip = VeriBlock::GetPop().altTree-&gt;getBestChain().tip();</div>
<div class="line">+        assert(tip &amp;&amp; <span class="stringliteral">&quot;we could not load tip of alt block&quot;</span>);</div>
<div class="line">+        uint256 hash(tip-&gt;getHash());</div>
<div class="line">+</div>
<div class="line">+        CBlockIndex* index = LookupBlockIndex(hash);</div>
<div class="line">+        assert(index);</div>
<div class="line">+        <span class="keywordflow">if</span> (index-&gt;IsValid(BLOCK_VALID_TREE)) {</div>
<div class="line">+            pindexBestHeader = index;</div>
<div class="line">+        } <span class="keywordflow">else</span> {</div>
<div class="line">+            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">+        }</div>
<div class="line">     }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L4751">method CChainState::LoadGenesisBlock</a> </p><div class="fragment"><div class="line">         <span class="keywordflow">if</span> (blockPos.IsNull())</div>
<div class="line">             <span class="keywordflow">return</span> error(<span class="stringliteral">&quot;%s: writing genesis block to disk failed&quot;</span>, __func__);</div>
<div class="line">-        CBlockIndex *pindex = m_blockman.AddToBlockIndex(block);</div>
<div class="line">+        CBlockIndex* pindex = m_blockman.AddToBlockIndex(block);</div>
<div class="line">+        BlockValidationState state;</div>
<div class="line">+        <span class="keywordflow">if</span> (!VeriBlock::acceptBlock(*pindex, state)) {</div>
<div class="line">+            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">+        }</div>
<div class="line">         ReceivedBlockTransactions(block, pindex, blockPos, chainparams.GetConsensus());</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md66"></a>
3. Show Pop related info when node starts.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/init.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/init.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/init.cpp#L1209">method AppInitMain</a> </p><div class="fragment"><div class="line">+    {</div>
<div class="line">+        <span class="keyword">auto</span>&amp; pop = VeriBlock::GetPop();</div>
<div class="line">+        <span class="keyword">auto</span>* tip = ChainActive().Tip();</div>
<div class="line">+        <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a> state;</div>
<div class="line">+        LOCK(cs_main);</div>
<div class="line">+        <span class="keywordtype">bool</span> ret = VeriBlock::setState(tip-&gt;GetBlockHash(), state);</div>
<div class="line">+        <span class="keyword">auto</span>* alttip = pop.getAltBlockTree().getBestChain().tip();</div>
<div class="line">+        assert(ret &amp;&amp; <span class="stringliteral">&quot;bad state&quot;</span>);</div>
<div class="line">+        assert(tip-&gt;nHeight == alttip-&gt;getHeight());</div>
<div class="line">+</div>
<div class="line">+        LogPrintf(<span class="stringliteral">&quot;ALT tree best height = %d\n&quot;</span>, pop.getAltBlockTree().getBestChain().tip()-&gt;getHeight());</div>
<div class="line">+        LogPrintf(<span class="stringliteral">&quot;VBK tree best height = %d\n&quot;</span>, pop.getVbkBlockTree().getBestChain().tip()-&gt;getHeight());</div>
<div class="line">+        LogPrintf(<span class="stringliteral">&quot;BTC tree best height = %d\n&quot;</span>, pop.getBtcBlockTree().getBestChain().tip()-&gt;getHeight());</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">     <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md67"></a>
4. Update Pop logging support.</h1>
<p >Pop logger: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/log.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/log.hpp</a>. Copy this file to your project.</p>
<dl class="section note"><dt>Note</dt><dd>Pop logger inherits from <a class="el" href="structaltintegration_1_1Logger.html" title="An interface for logger.">altintegration::Logger</a>. It should write to ALT log in the overriden virtual method <code>log()</code>.</dd></dl>
<p>Add additional flag for the logger.</p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/logging.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/logging.h</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/logging.h#L35">namespace BCLog</a> </p><div class="fragment"><div class="line">         QT          = (1 &lt;&lt; 19),</div>
<div class="line">         LEVELDB     = (1 &lt;&lt; 20),</div>
<div class="line">+        POP         = (1 &lt;&lt; 21),</div>
<div class="line">         ALL         = ~(uint32_t)0,</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/logging.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/logging.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/logging.cpp#L142">field LogCategories</a> </p><div class="fragment"><div class="line">     {BCLog::LEVELDB, <span class="stringliteral">&quot;leveldb&quot;</span>},</div>
<div class="line">+    {BCLog::POP, <span class="stringliteral">&quot;pop&quot;</span>},</div>
<div class="line">     {BCLog::ALL, <span class="stringliteral">&quot;1&quot;</span>},</div>
</div><!-- fragment --><p >Attach veriblock-pop-cpp library to the native logger.</p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/init.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/init.cpp</a> </p><div class="fragment"><div class="line">+#include &lt;vbk/log.hpp&gt;</div>
<div class="line"><span class="preprocessor"> #include &lt;vbk/pop_service.hpp&gt;</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/init.cpp#L843">method InitLogging</a> </p><div class="fragment"><div class="line">     LogInstance().m_log_threadnames = gArgs.GetBoolArg(<span class="stringliteral">&quot;-logthreadnames&quot;</span>, DEFAULT_LOGTHREADNAMES);</div>
<div class="line">+    LogInstance().EnableCategory(BCLog::POP);</div>
<div class="line">+</div>
<div class="line">+    std::string poplogverbosity = gArgs.GetArg(<span class="stringliteral">&quot;-poplogverbosity&quot;</span>, <span class="stringliteral">&quot;warn&quot;</span>);</div>
<div class="line">+    altintegration::SetLogger&lt;VeriBlock::VBTCLogger&gt;();</div>
<div class="line">+    <a class="code hl_function" href="namespacealtintegration.html#afe5c32d3950205f309344c0082d1d94d">altintegration::GetLogger</a>().level = <a class="code hl_function" href="namespacealtintegration.html#a74d1310d21c147f0b18eaaf2d70e4bc9">altintegration::StringToLevel</a>(poplogverbosity);</div>
<div class="line"> </div>
<div class="line">     fLogIPs = gArgs.GetBoolArg(<span class="stringliteral">&quot;-logips&quot;</span>, DEFAULT_LOGIPS);</div>
<div class="ttc" id="anamespacealtintegration_html_a74d1310d21c147f0b18eaaf2d70e4bc9"><div class="ttname"><a href="namespacealtintegration.html#a74d1310d21c147f0b18eaaf2d70e4bc9">altintegration::StringToLevel</a></div><div class="ttdeci">LogLevel StringToLevel(const std::string &amp;)</div><div class="ttdoc">convert string to loglevel</div></div>
<div class="ttc" id="anamespacealtintegration_html_afe5c32d3950205f309344c0082d1d94d"><div class="ttname"><a href="namespacealtintegration.html#afe5c32d3950205f309344c0082d1d94d">altintegration::GetLogger</a></div><div class="ttdeci">Logger &amp; GetLogger()</div><div class="ttdoc">getter for global logger instance</div></div>
</div><!-- fragment --><p >Add <code>poplogverbosity</code> to the application arguments. It allows to choose the verbosity level for the library logger.</p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/init.cpp#L347">method SetupServerArgs</a> </p><div class="fragment"><div class="line">         <span class="stringliteral">&quot;-choosedatadir&quot;</span>, <span class="stringliteral">&quot;-lang=&lt;lang&gt;&quot;</span>, <span class="stringliteral">&quot;-min&quot;</span>, <span class="stringliteral">&quot;-resetguisettings&quot;</span>, <span class="stringliteral">&quot;-splash&quot;</span>, <span class="stringliteral">&quot;-uiplatform&quot;</span>};</div>
<div class="line">+    <span class="comment">// VBK</span></div>
<div class="line">+    gArgs.AddArg(<span class="stringliteral">&quot;-poplogverbosity&quot;</span>, <span class="stringliteral">&quot;Verbosity for alt-cpp lib: debug/info/(warn)/error/off&quot;</span>, ArgsManager::ALLOW_STRING, OptionsCategory::OPTIONS);</div>
<div class="line">+    <span class="comment">// VBK</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md68"></a>
5. Add unit tests to test the functionality we have added before.</h1>
<p >VeriBlock precalculated data for the tests: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/util/consts.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/util/consts.hpp</a>. Copy this file to your project.</p>
<p >Unit testing setup and helper methods: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/util/e2e_fixture.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/util/e2e_fixture.hpp</a>. Copy this file to your project.</p>
<p >Update test setup to check if Pop AltTree was initialized properly.</p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp#L162">method TestChain100Setup::TestChain100Setup</a> </p><div class="fragment"><div class="line">     assert(ChainActive().Tip()-&gt;nHeight == 100);</div>
<div class="line">     assert(BlockIndex().size() == 101);</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">auto</span>&amp; tree = *VeriBlock::GetPop().altTree;</div>
<div class="line">+    assert(tree.getBestChain().tip()-&gt;getHeight() == ChainActive().Tip()-&gt;nHeight);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md69"></a>
6. Add test case which tests the VeriBlock Pop behaviour: e2e_poptx_tests.cpp.</h1>
<p >E2E Pop basic functionality test: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/unit/e2e_poptx_tests.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/unit/e2e_poptx_tests.cpp</a>. Copy this file to your project.</p>
<h1><a class="anchor" id="autotoc_md70"></a>
7. Update makefile to enable new unit test.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.test.include">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.test.include</a> </p><div class="fragment"><div class="line">+### VeriBlock section start</div>
<div class="line">+# path is relative to src</div>
<div class="line">+VBK_TESTS = \</div>
<div class="line">+    vbk/test/unit/e2e_poptx_tests.cpp</div>
<div class="line">+### VeriBlock section end</div>
<div class="line">+</div>
<div class="line"><span class="preprocessor"> # test_bitcoin binary #</span></div>
<div class="line"> BITCOIN_TESTS =\</div>
<div class="line">+  $(VBK_TESTS) \</div>
<div class="line">   test/arith_uint256_tests.cpp \</div>
<div class="line">   test/scriptnum10.h \</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<script>
    $(document).ready(function(){
        $('.line').each(function(){
            var t = $(this).html()
            if(t.startsWith("+")) {
                $(this).addClass('diff-plus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>+</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            } else if (t.startsWith("-")) {
                $(this).addClass('diff-minus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>-</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            }
        })
    });
</script>