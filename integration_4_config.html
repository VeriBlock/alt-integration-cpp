<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>veriblock-pop-cpp: Adding configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="main.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">veriblock-pop-cpp
   </div>
   <div id="projectbrief">C++11 Libraries for leveraging VeriBlock Proof-Of-Proof blockchain technology.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('integration_4_config.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Adding configuration </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md45">Overview</a></li>
<li class="level1"><a href="#autotoc_md46">1. Create two new source files: pop_common.hpp, pop_common.cpp.</a></li>
<li class="level1"><a href="#autotoc_md47">2. Add bootstraps blocks.</a></li>
<li class="level1"><a href="#autotoc_md48">3. Create AltChainParamsBTC class with VeriBlock configuration of the ALT blockchain.</a></li>
<li class="level1"><a href="#autotoc_md49">4. Update the initialization of the bitcoind, bitcoin-wallet, etc to setup VeriBlock config.</a></li>
<li class="level1"><a href="#autotoc_md50">5. Update test chain setup to allow adding block to specific previous block.</a></li>
<li class="level1"><a href="#autotoc_md51">6. Update makefiles. Add new source files.</a></li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_families_btc_integration_4_config"></a></p>
<h1><a class="anchor" id="autotoc_md45"></a>
Overview</h1>
<p >Before using structures of the VeriBlock library, we should define some VeriBlock specific parameters. We have to add new Config class which inherits from the <a class="el" href="structaltintegration_1_1AltChainParams.html" title="Base class for all Altchain-related configs.">altintegration::AltChainParams</a>. But first we will add functions that contain API for the library interactions.</p>
<h1><a class="anchor" id="autotoc_md46"></a>
1. Create two new source files: pop_common.hpp, pop_common.cpp.</h1>
<p >POP configuration header: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_common.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_common.hpp</a>. Copy this file to your project.</p>
<p >POP configuration source: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_common.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_common.cpp</a>. Copy this file to your project.</p>
<h1><a class="anchor" id="autotoc_md47"></a>
2. Add bootstraps blocks.</h1>
<dl class="section note"><dt>Note</dt><dd>veriblock-pop-cpp library maintains all blocks of Bitcoin and VeriBlock starting at certain set of blocks - "bootstrap blocks".</dd></dl>
<p>Bootstrap blocks header: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/bootstraps.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/bootstraps.h</a>. Copy this file to your project.</p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/bootstraps.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/bootstraps.cpp</a> </p><div class="fragment"><div class="line"><span class="comment">// Copyright (c) 2019-2022 Xenios SEZC</span></div>
<div class="line"><span class="comment">// https://www.veriblock.org</span></div>
<div class="line"><span class="comment">// Distributed under the MIT software license, see the accompanying</span></div>
<div class="line"><span class="comment">// file COPYING or http://www.opensource.org/licenses/mit-license.php.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;vbk/bootstraps.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>VeriBlock {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> testnetVBKstartHeight=860529;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> testnetBTCstartHeight=1832624;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> std::vector&lt;std::string&gt; testnetBTCblocks = {};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> std::vector&lt;std::string&gt; testnetVBKblocks = {};</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace VeriBlock</span></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Bootstrap blocks, both BTC and VBK, should contain as recent data as possible. APM will have to maintain connectivity of blocks. Therefore it will have to mine all missing blocks starting from bootstrap.</dd>
<dd>
We will fill bootstraps.cpp at the end of the integration document.</dd></dl>
<h1><a class="anchor" id="autotoc_md48"></a>
3. Create AltChainParamsBTC class with VeriBlock configuration of the ALT blockchain.</h1>
<p >POP configuration loader header: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/params.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/params.hpp</a>. Copy this file to your project.</p>
<dl class="section note"><dt>Note</dt><dd>Make sure to change <code>altchainId</code> to uniquely identify ALT blockchain data.</dd></dl>
<p><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/params.hpp#L33">struct AltChainParamsBTC</a> </p><div class="fragment"><div class="line">int64_t getIdentifier() const noexcept<span class="keyword"> override</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    return &lt;altchainId&gt;;</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><code>altchainId</code> is 8-byte ID, sent with every endorsement of ALT block in VBK. Used by VeriBlock to group potentially relevant endorsements. It is not critical if <code>altchainId</code> is reused by multiple Altchains, but this is not preferable.</dd></dl>
<p>POP configuration loader source: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/params.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/params.cpp</a>. Copy this file to your project.</p>
<dl class="section note"><dt>Note</dt><dd>Modify <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/params.cpp#L20">checkBlockHeader</a> to validate ALT block proof-of-work.</dd></dl>
<p>Util file with some useful functions for the VeriBlock integration: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/util.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/util.hpp</a>. Copy this file to your project.</p>
<h1><a class="anchor" id="autotoc_md49"></a>
4. Update the initialization of the bitcoind, bitcoin-wallet, etc to setup VeriBlock config.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoind.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoind.cpp</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;functional&gt;</span></div>
<div class="line">+#include &lt;vbk/params.hpp&gt;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoind.cpp#L44">method AppInit</a> </p><div class="fragment"><div class="line">         <span class="keywordflow">try</span> {</div>
<div class="line">+            <span class="keywordflow">if</span>(gArgs.GetChainName() == CBaseChainParams::MAIN) {</div>
<div class="line">+                <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Mainnet is disabled. Use testnet.&quot;</span>);</div>
<div class="line">+            }</div>
<div class="line">             SelectParams(gArgs.GetChainName());</div>
<div class="line">+            VeriBlock::selectPopConfig(gArgs, gArgs.GetChainName(), gArgs.GetChainName());</div>
<div class="line">         } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoin-tx.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoin-tx.cpp</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;stdio.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"> #include &lt;boost/algorithm/string.hpp&gt;</span></div>
<div class="line">+#include &lt;vbk/params.hpp&gt;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoin-tx.cpp#L81">method AppInitRawTx</a> </p><div class="fragment"><div class="line">     <span class="keywordflow">try</span> {</div>
<div class="line">         SelectParams(gArgs.GetChainName());</div>
<div class="line">+        VeriBlock::selectPopConfig(gArgs, gArgs.GetChainName(), gArgs.GetChainName());</div>
<div class="line">     } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e) {</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/interfaces/node.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/interfaces/node.cpp</a> </p><div class="fragment"><div class="line">+#include &lt;vbk/params.hpp&gt;</div>
<div class="line"><span class="preprocessor"> #include &lt;univalue.h&gt;</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/interfaces/node.cpp#L56">class NodeImpl</a> </p><div class="fragment"><div class="line">     <span class="keywordtype">bool</span> softSetBoolArg(<span class="keyword">const</span> std::string&amp; arg, <span class="keywordtype">bool</span> value)<span class="keyword"> override </span>{ <span class="keywordflow">return</span> gArgs.SoftSetBoolArg(arg, value); }</div>
<div class="line">-    <span class="keywordtype">void</span> selectParams(<span class="keyword">const</span> std::string&amp; network)<span class="keyword"> override </span>{ SelectParams(network); }</div>
<div class="line">+    <span class="keywordtype">void</span> selectParams(<span class="keyword">const</span> std::string&amp; network)<span class="keyword"> override </span>{ SelectParams(network); VeriBlock::selectPopConfig(gArgs);}</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoin-wallet.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoin-wallet.cpp</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;wallet/wallettool.h&gt;</span></div>
<div class="line">+#include &lt;vbk/params.hpp&gt;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bitcoin-wallet.cpp#L37">method WalletAppInit</a> </p><div class="fragment"><div class="line">     <span class="comment">// Check for -testnet or -regtest parameter (Params() calls are only valid after this clause)</span></div>
<div class="line">     SelectParams(gArgs.GetChainName());</div>
<div class="line">+    VeriBlock::selectPopConfig(gArgs, gArgs.GetChainName(), gArgs.GetChainName());</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;validationinterface.h&gt;</span></div>
<div class="line"> </div>
<div class="line">+#include &lt;vbk/params.hpp&gt;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp#L69">method BasicTestingSetup::BasicTestingSetup</a> </p><div class="fragment"><div class="line">     ClearDatadirCache();</div>
<div class="line">     SelectParams(chainName);</div>
<div class="line">+    VeriBlock::selectPopConfig(<span class="stringliteral">&quot;regtest&quot;</span>, <span class="stringliteral">&quot;regtest&quot;</span>, <span class="keyword">true</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md50"></a>
5. Update test chain setup to allow adding block to specific previous block.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.h</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;txmempool.h&gt;</span></div>
<div class="line"> </div>
<div class="line">+#include &lt;vbk/pop_service.hpp&gt;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.h#L107">struct TestChain100Setup</a> </p><div class="fragment"><div class="line">     CBlock CreateAndProcessBlock(<span class="keyword">const</span> std::vector&lt;CMutableTransaction&gt;&amp; txns,</div>
<div class="line">-                                 <span class="keyword">const</span> CScript&amp; scriptPubKey);</div>
<div class="line">+                                 <span class="keyword">const</span> CScript&amp; scriptPubKey, <span class="keywordtype">bool</span>* isBlockValid = <span class="keyword">nullptr</span>);</div>
<div class="line">+</div>
<div class="line">+    CBlock CreateAndProcessBlock(<span class="keyword">const</span> std::vector&lt;CMutableTransaction&gt;&amp; txns, uint256 prevBlock,</div>
<div class="line">+                                 <span class="keyword">const</span> CScript&amp; scriptPubKey, <span class="keywordtype">bool</span>* isBlockValid = <span class="keyword">nullptr</span>);</div>
<div class="line">+</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp</a> </p><div class="fragment"><div class="line">-<span class="comment">// Create a new block with just given transactions, coinbase paying to</span></div>
<div class="line">-<span class="comment">// scriptPubKey, and try to add it to the current chain.</span></div>
<div class="line">-CBlock TestChain100Setup::CreateAndProcessBlock(<span class="keyword">const</span> std::vector&lt;CMutableTransaction&gt;&amp; txns, <span class="keyword">const</span> CScript&amp; scriptPubKey)</div>
<div class="line">-{</div>
<div class="line">+CBlock TestChain100Setup::CreateAndProcessBlock(<span class="keyword">const</span> std::vector&lt;CMutableTransaction&gt;&amp; txns, uint256 prevBlock,</div>
<div class="line">+                             <span class="keyword">const</span> CScript&amp; scriptPubKey, <span class="keywordtype">bool</span>* isBlockValid) {</div>
<div class="line">+</div>
<div class="line">+    CBlockIndex* pPrev = <span class="keyword">nullptr</span>;</div>
<div class="line">+    {</div>
<div class="line">+        LOCK(cs_main);</div>
<div class="line">+        pPrev = LookupBlockIndex(prevBlock);</div>
<div class="line">+        assert(pPrev &amp;&amp; <span class="stringliteral">&quot;CreateAndProcessBlock called with unknown prev block&quot;</span>);</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">     <span class="keyword">const</span> CChainParams&amp; chainparams = Params();</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp#L188">method TestChain100Setup::CreateAndProcessBlock</a> </p><div class="fragment"><div class="line">         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> extraNonce = 0;</div>
<div class="line">-        IncrementExtraNonce(&amp;block, ::ChainActive().Tip(), extraNonce);</div>
<div class="line">+        IncrementExtraNonce(&amp;block, pPrev, extraNonce);</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/setup_common.cpp#L188">method TestChain100Setup::CreateAndProcessBlock</a> </p><div class="fragment"><div class="line">     std::shared_ptr&lt;const CBlock&gt; shared_pblock = std::make_shared&lt;const CBlock&gt;(block);</div>
<div class="line">-    ProcessNewBlock(chainparams, shared_pblock, <span class="keyword">true</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordtype">bool</span> isValid = ProcessNewBlock(chainparams, shared_pblock, <span class="keyword">true</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">+    <span class="keywordflow">if</span>(isBlockValid != <span class="keyword">nullptr</span>) {</div>
<div class="line">+        *isBlockValid = isValid;</div>
<div class="line">+    }</div>
</div><!-- fragment --> <div class="fragment"><div class="line">+<span class="comment">// Create a new block with just given transactions, coinbase paying to</span></div>
<div class="line">+<span class="comment">// scriptPubKey, and try to add it to the current chain.</span></div>
<div class="line">+CBlock TestChain100Setup::CreateAndProcessBlock(<span class="keyword">const</span> std::vector&lt;CMutableTransaction&gt;&amp; txns, <span class="keyword">const</span> CScript&amp; scriptPubKey, <span class="keywordtype">bool</span>* isBlockValid)</div>
<div class="line">+{</div>
<div class="line">+    <span class="keywordflow">return</span> CreateAndProcessBlock(txns, ChainActive().Tip()-&gt;GetBlockHash(), scriptPubKey, isBlockValid);</div>
<div class="line">+}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md51"></a>
6. Update makefiles. Add new source files.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.am">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.am</a> </p><div class="fragment"><div class="line"> libbitcoin_common_a_SOURCES = \</div>
<div class="line">+  vbk/pop_common.hpp \</div>
<div class="line">+  vbk/pop_common.cpp \</div>
<div class="line">+  vbk/params.cpp \</div>
<div class="line">+  vbk/bootstraps.cpp \</div>
</div><!-- fragment --><p ><a class="el" href="integration_5_persistence.html#md_docs_families_btc_integration_5_persistence">Next Section</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<script>
    $(document).ready(function(){
        $('.line').each(function(){
            var t = $(this).html()
            if(t.startsWith("+")) {
                $(this).addClass('diff-plus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>+</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            } else if (t.startsWith("-")) {
                $(this).addClass('diff-minus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>-</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            }
        })
    });
</script>