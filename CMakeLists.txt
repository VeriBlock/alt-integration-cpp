cmake_minimum_required(VERSION 3.5)

find_program(CCACHE_FOUND ccache)
if(CCACHE_FOUND)
    set_property(GLOBAL PROPERTY RULE_LAUNCH_COMPILE ccache)
    set_property(GLOBAL PROPERTY RULE_LAUNCH_LINK ccache)
endif(CCACHE_FOUND)



set(LIB_NAME altintegration)
set(MAJOR_VERSION 1 CACHE STRING "Major version")
set(MINOR_VERSION 0 CACHE STRING "Minor version")
set(PATCH_VERSION 0 CACHE STRING "Patch version")
set(VERSION "${MAJOR_VERSION}.${MINOR_VERSION}.${PATCH_VERSION}" CACHE STRING "Version")
project(${LIB_NAME} VERSION ${VERSION} LANGUAGES C CXX)

include(GNUInstallDirs)
include(CheckCCompilerFlag)
include(CheckCXXCompilerFlag)
include(cmake/functions.cmake)

set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)
set(CMAKE_VERBOSE_MAKEFILE OFF)
set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)
set(CMAKE_INSTALL_RPATH_USE_LINK_PATH ON)


option(CLANG_TIDY   "Enable clang-tidy checks during compilation" OFF)
option(ASAN         "Enable Address Sanitizer" OFF)
option(TSAN         "Enable Thread Sanitizer" OFF)
option(UBSAN        "Enable Undefined Behavior Sanitizer" OFF)
option(COVERAGE     "Enable coverage" OFF)
option(WERROR       "Treat warnings as errors" ON)
option(TESTING      "Build tests" ON)
option(WITH_ROCKSDB "Enable RocksDB storage" ON)
option(SHARED       "Build shared lib" ON)

if (WIN32)
  set(FIND_ROCKSDB_DEFAULT TRUE)
else()
  set(FIND_ROCKSDB_DEFAULT FALSE)
endif()

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

option(FIND_ROCKSDB "Use \"ON\" to search for RocksDB in installed packages" ${FIND_ROCKSDB_DEFAULT})

include(cmake/dependencies.cmake)

## setup compilation flags
if ("${CMAKE_CXX_COMPILER_ID}" MATCHES "^(AppleClang|Clang|GNU)$")
    if(WERROR)
        add_compile_options(-Werror)
    endif()
    # enable those flags
    add_cxx_flag(-Woverloaded-virtual) # warn if you overload (not override) a virtual function
    add_cxx_flag(-Wnon-virtual-dtor) # warn the user if a class with virtual functions has a non-virtual destructor. This helps catch hard to track down memory errors
    add_cxx_flag(-Wreorder)          # field '$1' will be initialized after field '$2'
    add_flag(-Wall)
    add_flag(-Wextra)
    add_flag(-Wformat=2)               # warn on security issues around functions that format output (ie printf)
    add_flag(-Wmisleading-indentation) # (only in GCC >= 6.0) warn if indentation implies blocks where blocks do not exist
    add_flag(-Wduplicated-cond)        # (only in GCC >= 6.0) warn if if / else chain has duplicated conditions
    add_flag(-Wduplicated-branches)    # (only in GCC >= 7.0) warn if if / else branches have duplicated code
    add_flag(-Wnull-dereference)       # (only in GCC >= 6.0) warn if a null dereference is detected
    add_flag(-Wdouble-promotion)       # (GCC >= 4.6, Clang >= 3.8) warn if float is implicit promoted to double
    add_flag(-Wsign-compare)
    add_flag(-Wtype-limits)            # size_t - size_t >= 0 -> always true
    add_flag(-Wnused-lambda-capture)  # error if lambda capture is unused
    add_flag(-Wreturn-type)      # warning: control reaches end of non-void function [-Wreturn-type]
    add_flag(-Wsign-compare)     # warn the user if they compare a signed and unsigned numbers

    # disable errors
    add_flag(-Wno-unused-function)
    add_flag(-Wno-nonnull-compare)
    add_flag(-Wno-unknown-pragmas)
    add_flag(-Wno-error=null-dereference)
    add_cxx_flag(-Wno-literal-suffix)
elseif ("${CMAKE_CXX_COMPILER_ID}" STREQUAL "MSVC")
    if(WERROR)
        add_compile_options(/WX)                      # treats all compiler warnings as errors.
    endif()

    # using Visual Studio C++
    add_flag(/W4)                      # displays level 1, level 2, and level 3 warnings, and all level 4 (informational) warnings that are not turned off by default.
    add_flag(/permissive-)             # enforces standards conformance
    add_flag(/w14242)                  # 'identfier': conversion from 'type1' to 'type1', possible loss of data
    add_flag(/w14263)                  # 'function': member function does not override any base class virtual member function
    add_flag(/w14265)                  # 'classname': class has virtual functions, but destructor is not virtual instances of this class may not be destructed correctly
    add_flag(/w14296)                  # 'operator': expression is always 'boolean_value'
    add_flag(/w14826)                  # Conversion from 'type1' to 'type_2' is sign-extended. This may cause unexpected runtime behavior.
    add_flag(/w14640)                  # Enable warning on thread un-safe static member initialization

    # disable these warnings:
    add_flag(/wd4389)                  # disable warning: 'operator' : signed/unsigned mismatch
    add_flag(/wd4455)                  # disable warning: 'operator ""s': literal suffix identifiers that do not start with an underscore are reserved
    add_flag(/wd4127)                  # disable warning: conditional expression is constant
endif()

include_directories(include)
add_subdirectory(src)

if(CLANG_TIDY)
    include(cmake/clang-tidy.cmake)
endif()

if(ASAN)
    include(cmake/asan.cmake)
elseif(TSAN)
    include(cmake/tsan.cmake)
elseif(UBSAN)
    include(cmake/ubsan.cmake)
elseif(COVERAGE)
    include(cmake/coverage.cmake)
endif()

add_subdirectory(tools EXCLUDE_FROM_ALL)

if(TESTING)
    enable_testing()
    add_subdirectory(test)
endif()

message(STATUS "CLANG_TIDY=${CLANG_TIDY}")
message(STATUS "ASAN=${ASAN}")
message(STATUS "TSAN=${TSAN}")
message(STATUS "UBSAN=${UBSAN}")
message(STATUS "COVERAGE=${COVERAGE}")
message(STATUS "WERROR=${WERROR}")
message(STATUS "CMAKE_C_FLAGS=${CMAKE_C_FLAGS}")
message(STATUS "CMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}")