<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>veriblock-pop-cpp: Pop fork resolution</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="main.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">veriblock-pop-cpp
   </div>
   <div id="projectbrief">C++11 Libraries for leveraging VeriBlock Proof-Of-Proof blockchain technology.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('integration_10_fr.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Pop fork resolution </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md4">Overview</a></li>
<li class="level1"><a href="#autotoc_md5">1. Add fork resoultion functions to the pop_service.cpp and pop_service.hpp.</a></li>
<li class="level1"><a href="#autotoc_md6">2. Update validation.cpp to support Pop fork resolution.</a></li>
<li class="level1"><a href="#autotoc_md7">3. Add Pop fork resolution unit test.</a></li>
<li class="level1"><a href="#autotoc_md8">4. Update makefile to run tests.</a></li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_families_btc_integration_10_fr"></a></p>
<h1><a class="anchor" id="autotoc_md4"></a>
Overview</h1>
<p >Pop fork resolution uses Pop score to determine the winning chain. One block with highest Pop score can rollback a consideraby lengthy chain. There is no cumulative chain work like in Bitcoin. Therefore work comparator should be replaced with Pop aware comparator and candidate chain tips should be stored disregard their cumulative difficulty.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
1. Add fork resoultion functions to the pop_service.cpp and pop_service.hpp.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.hpp</a> </p><div class="fragment"><div class="line">+CBlockIndex* compareTipToBlock(CBlockIndex* candidate);</div>
<div class="line">+<span class="keywordtype">int</span> compareForks(<span class="keyword">const</span> CBlockIndex&amp; left, <span class="keyword">const</span> CBlockIndex&amp; right);</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.cpp</a> </p><div class="fragment"><div class="line">+CBlockIndex* compareTipToBlock(CBlockIndex* candidate)</div>
<div class="line">+{</div>
<div class="line">+    AssertLockHeld(cs_main);</div>
<div class="line">+    assert(candidate != <span class="keyword">nullptr</span> &amp;&amp; <span class="stringliteral">&quot;block has no according header in block tree&quot;</span>);</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">auto</span> blockHash = candidate-&gt;GetBlockHash();</div>
<div class="line">+    <span class="keyword">auto</span>* tip = ChainActive().Tip();</div>
<div class="line">+    <span class="keywordflow">if</span> (!tip) {</div>
<div class="line">+        <span class="comment">// if tip is not set, candidate wins</span></div>
<div class="line">+        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">auto</span> tipHash = tip-&gt;GetBlockHash();</div>
<div class="line">+    <span class="keywordflow">if</span> (tipHash == blockHash) {</div>
<div class="line">+        <span class="comment">// we compare tip with itself</span></div>
<div class="line">+        <span class="keywordflow">return</span> tip;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordtype">int</span> result = 0;</div>
<div class="line">+    <span class="keywordflow">if</span> (Params().isPopActive(tip-&gt;nHeight)) {</div>
<div class="line">+        result = compareForks(*tip, *candidate);</div>
<div class="line">+    } <span class="keywordflow">else</span> {</div>
<div class="line">+        result = CBlockIndexWorkComparator()(tip, candidate) ? -1 : 1;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">if</span> (result &lt; 0) {</div>
<div class="line">+        <span class="comment">// candidate has higher POP score</span></div>
<div class="line">+        <span class="keywordflow">return</span> candidate;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">if</span> (result == 0 &amp;&amp; tip-&gt;nChainWork &lt; candidate-&gt;nChainWork) {</div>
<div class="line">+        <span class="comment">// candidate is POP equal to current tip;</span></div>
<div class="line">+        <span class="comment">// candidate has higher chainwork</span></div>
<div class="line">+        <span class="keywordflow">return</span> candidate;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="comment">// otherwise, current chain wins</span></div>
<div class="line">+    <span class="keywordflow">return</span> tip;</div>
<div class="line">+}</div>
<div class="line">+</div>
<div class="line">+<span class="keywordtype">int</span> compareForks(<span class="keyword">const</span> CBlockIndex&amp; leftForkTip, <span class="keyword">const</span> CBlockIndex&amp; rightForkTip) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div>
<div class="line">+{</div>
<div class="line">+    <span class="keyword">auto</span>&amp; pop = GetPop();</div>
<div class="line">+    AssertLockHeld(cs_main);</div>
<div class="line">+    <span class="keywordflow">if</span> (&amp;leftForkTip == &amp;rightForkTip) {</div>
<div class="line">+        <span class="keywordflow">return</span> 0;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">auto</span> left = blockToAltBlock(leftForkTip);</div>
<div class="line">+    <span class="keyword">auto</span> right = blockToAltBlock(rightForkTip);</div>
<div class="line">+    <span class="keyword">auto</span> state = <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a>();</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">if</span> (!pop.getAltBlockTree().setState(left.hash, state)) {</div>
<div class="line">          assert(<span class="keyword">false</span> &amp;&amp; <span class="stringliteral">&quot;current tip is invalid&quot;</span>);</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">return</span> pop.getAltBlockTree().comparePopScore(left.hash, right.hash);</div>
<div class="line">+}</div>
<div class="ttc" id="aclassaltintegration_1_1ValidationState_html"><div class="ttname"><a href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a></div><div class="ttdoc">Class that is used for storing validation state.</div><div class="ttdef"><b>Definition:</b> <a href="validation__state_8hpp_source.html#l00028">validation_state.hpp:28</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
2. Update validation.cpp to support Pop fork resolution.</h1>
<p >Add additional failure codes.</p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/chain.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/chain.h</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/chain.h#L94">enum BlockStatus</a> </p><div class="fragment"><div class="line">     <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa5cb9d4324c455d44fedc98d9916cdd47">BLOCK_FAILED_CHILD</a>       =   64, </div>
<div class="line">-    <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aaa23dda4bbc14b35a4a0a7f1e7ddc184c">BLOCK_FAILED_MASK</a>        =   BLOCK_FAILED_VALID | <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa5cb9d4324c455d44fedc98d9916cdd47">BLOCK_FAILED_CHILD</a>,</div>
<div class="line"> </div>
<div class="line">     BLOCK_OPT_WITNESS       =   128, </div>
<div class="line">+</div>
<div class="line">+    <span class="comment">// VeriBlock: block status</span></div>
<div class="line">+    VERIBLOCK_BLOCK_FAILED_POP = 256,</div>
<div class="line">+    VERIBLOCK_BLOCK_FAILED_CHILD = 512,</div>
<div class="line">+</div>
<div class="line">+    <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aaa23dda4bbc14b35a4a0a7f1e7ddc184c">BLOCK_FAILED_MASK</a> = BLOCK_FAILED_VALID | <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa5cb9d4324c455d44fedc98d9916cdd47">BLOCK_FAILED_CHILD</a> | VERIBLOCK_BLOCK_FAILED_POP | VERIBLOCK_BLOCK_FAILED_CHILD,</div>
<div class="line"> };</div>
<div class="ttc" id="anamespacealtintegration_html_a798d9fc435a987ae04ecc3ef4f5e736aa5cb9d4324c455d44fedc98d9916cdd47"><div class="ttname"><a href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa5cb9d4324c455d44fedc98d9916cdd47">altintegration::BLOCK_FAILED_CHILD</a></div><div class="ttdeci">@ BLOCK_FAILED_CHILD</div><div class="ttdoc">block is state{lessly,fully} valid and the altchain did not report it as invalid, but some of the anc...</div><div class="ttdef"><b>Definition:</b> <a href="block__status_8hpp_source.html#l00054">block_status.hpp:54</a></div></div>
<div class="ttc" id="anamespacealtintegration_html_a798d9fc435a987ae04ecc3ef4f5e736aaa23dda4bbc14b35a4a0a7f1e7ddc184c"><div class="ttname"><a href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aaa23dda4bbc14b35a4a0a7f1e7ddc184c">altintegration::BLOCK_FAILED_MASK</a></div><div class="ttdeci">@ BLOCK_FAILED_MASK</div><div class="ttdoc">all invalidity flags</div><div class="ttdef"><b>Definition:</b> <a href="block__status_8hpp_source.html#l00057">block_status.hpp:56</a></div></div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.h</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.h#L552">class CChainState</a> </p><div class="fragment"><div class="line">     <span class="keywordtype">void</span> InvalidBlockFound(CBlockIndex *pindex, <span class="keyword">const</span> BlockValidationState &amp;state) EXCLUSIVE_LOCKS_REQUIRED(cs_main);</div>
<div class="line">-    CBlockIndex* FindMostWorkChain() EXCLUSIVE_LOCKS_REQUIRED(cs_main);</div>
<div class="line">+    CBlockIndex* FindBestChain() EXCLUSIVE_LOCKS_REQUIRED(cs_main);</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.h#L552">class CChainState</a> </p><div class="fragment"><div class="line"> </div>
<div class="line">     <span class="keywordtype">void</span> EraseBlockData(CBlockIndex* index) EXCLUSIVE_LOCKS_REQUIRED(cs_main);</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordtype">bool</span> TestBlockIndex(CBlockIndex* inhdex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L1390">method CChainState::InvalidBlockFound</a> </p><div class="fragment"><div class="line">     <span class="keywordflow">if</span> (state.GetResult() != BlockValidationResult::BLOCK_MUTATED) {</div>
<div class="line">         pindex-&gt;nStatus |= BLOCK_FAILED_VALID;</div>
<div class="line">+</div>
<div class="line">+        VeriBlock::GetPop()</div>
<div class="line">+            .getAltBlockTree()</div>
<div class="line">+            .invalidateSubtree(pindex-&gt;GetBlockHash().asVector(), <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa12343296a7f3939747d6728499a4efee">altintegration::BLOCK_FAILED_BLOCK</a>);</div>
<div class="line">+</div>
<div class="line">         m_blockman.m_failed_blocks.insert(pindex);</div>
<div class="ttc" id="anamespacealtintegration_html_a798d9fc435a987ae04ecc3ef4f5e736aa12343296a7f3939747d6728499a4efee"><div class="ttname"><a href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa12343296a7f3939747d6728499a4efee">altintegration::BLOCK_FAILED_BLOCK</a></div><div class="ttdeci">@ BLOCK_FAILED_BLOCK</div><div class="ttdoc">block is statelessly valid, but the altchain marked it as failed</div><div class="ttdef"><b>Definition:</b> <a href="block__status_8hpp_source.html#l00049">block_status.hpp:49</a></div></div>
</div><!-- fragment --> <div class="fragment"><div class="line">-CBlockIndex* CChainState::FindMostWorkChain() {</div>
<div class="line">-    <span class="keywordflow">do</span> {</div>
<div class="line">-        CBlockIndex *pindexNew = <span class="keyword">nullptr</span>;</div>
<div class="line">+CBlockIndex* CChainState::FindBestChain()</div>
<div class="line">+{</div>
<div class="line">+    AssertLockHeld(cs_main);</div>
<div class="line">+    CBlockIndex* bestCandidate = m_chain.Tip();</div>
<div class="line"> </div>
<div class="line">-        <span class="comment">// Find the best candidate header.</span></div>
<div class="line">-        {</div>
<div class="line">-            std::set&lt;CBlockIndex*, CBlockIndexWorkComparator&gt;::reverse_iterator it = setBlockIndexCandidates.rbegin();</div>
<div class="line">-            <span class="keywordflow">if</span> (it == setBlockIndexCandidates.rend())</div>
<div class="line">-                <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line">-            pindexNew = *it;</div>
<div class="line">-        }</div>
<div class="line">-</div>
<div class="line">-        <span class="comment">// Check whether all blocks on the path between the currently active chain and the candidate are valid.</span></div>
<div class="line">-        <span class="comment">// Just going until the active chain is an optimization, as we know all blocks in it are valid already.</span></div>
<div class="line">-        CBlockIndex *pindexTest = pindexNew;</div>
<div class="line">-        <span class="keywordtype">bool</span> fInvalidAncestor = <span class="keyword">false</span>;</div>
<div class="line">-        <span class="keywordflow">while</span> (pindexTest &amp;&amp; !m_chain.Contains(pindexTest)) {</div>
<div class="line">-            assert(pindexTest-&gt;HaveTxsDownloaded() || pindexTest-&gt;nHeight == 0);</div>
<div class="line">-</div>
<div class="line">-            <span class="comment">// Pruned nodes may have entries in setBlockIndexCandidates for</span></div>
<div class="line">-            <span class="comment">// which block files have been deleted.  Remove those as candidates</span></div>
<div class="line">-            <span class="comment">// for the most work chain if we come across them; we can&#39;t switch</span></div>
<div class="line">-            <span class="comment">// to a chain unless we have all the non-active-chain parent blocks.</span></div>
<div class="line">-            <span class="keywordtype">bool</span> fFailedChain = pindexTest-&gt;nStatus &amp; <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aaa23dda4bbc14b35a4a0a7f1e7ddc184c">BLOCK_FAILED_MASK</a>;</div>
<div class="line">-            <span class="keywordtype">bool</span> fMissingData = !(pindexTest-&gt;nStatus &amp; BLOCK_HAVE_DATA);</div>
<div class="line">-            <span class="keywordflow">if</span> (fFailedChain || fMissingData) {</div>
<div class="line">-                <span class="comment">// Candidate chain is not usable (either invalid or missing data)</span></div>
<div class="line">-                <span class="keywordflow">if</span> (fFailedChain &amp;&amp; (pindexBestInvalid == <span class="keyword">nullptr</span> || pindexNew-&gt;nChainWork &gt; pindexBestInvalid-&gt;nChainWork))</div>
<div class="line">-                    pindexBestInvalid = pindexNew;</div>
<div class="line">-                CBlockIndex *pindexFailed = pindexNew;</div>
<div class="line">-                <span class="comment">// Remove the entire chain from the set.</span></div>
<div class="line">-                <span class="keywordflow">while</span> (pindexTest != pindexFailed) {</div>
<div class="line">-                    <span class="keywordflow">if</span> (fFailedChain) {</div>
<div class="line">-                        pindexFailed-&gt;nStatus |= <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa5cb9d4324c455d44fedc98d9916cdd47">BLOCK_FAILED_CHILD</a>;</div>
<div class="line">-                    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fMissingData) {</div>
<div class="line">-                        <span class="comment">// If we&#39;re missing data, then add back to m_blocks_unlinked,</span></div>
<div class="line">-                        <span class="comment">// so that if the block arrives in the future we can try adding</span></div>
<div class="line">-                        <span class="comment">// to setBlockIndexCandidates again.</span></div>
<div class="line">-                        m_blockman.m_blocks_unlinked.insert(</div>
<div class="line">-                            std::make_pair(pindexFailed-&gt;pprev, pindexFailed));</div>
<div class="line">-                    }</div>
<div class="line">-                    setBlockIndexCandidates.erase(pindexFailed);</div>
<div class="line">-                    pindexFailed = pindexFailed-&gt;pprev;</div>
<div class="line">+    <span class="comment">// return early</span></div>
<div class="line">+    <span class="keywordflow">if</span> (setBlockIndexCandidates.empty()) {</div>
<div class="line">+        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">auto</span> temp_set = setBlockIndexCandidates;</div>
<div class="line">+    <span class="keywordflow">for</span> (<span class="keyword">auto</span>* pindexNew : temp_set) {</div>
<div class="line">+        <span class="keywordflow">if</span> (pindexNew == bestCandidate || !TestBlockIndex(pindexNew)) {</div>
<div class="line">+            <span class="keywordflow">continue</span>;</div>
<div class="line">+        }</div>
<div class="line">+</div>
<div class="line">+        <span class="keywordflow">if</span> (bestCandidate == <span class="keyword">nullptr</span>) {</div>
<div class="line">+            bestCandidate = pindexNew;</div>
<div class="line">+            <span class="keywordflow">continue</span>;</div>
<div class="line">+        }</div>
<div class="line">+</div>
<div class="line">+        <span class="keywordtype">int</span> popComparisonResult = 0;</div>
<div class="line">+</div>
<div class="line">+        <span class="keywordflow">if</span> (Params().isPopActive(bestCandidate-&gt;nHeight)) {</div>
<div class="line">+            popComparisonResult = VeriBlock::compareForks(*bestCandidate, *pindexNew);</div>
<div class="line">+        } <span class="keywordflow">else</span> {</div>
<div class="line">+            popComparisonResult = CBlockIndexWorkComparator()(bestCandidate, pindexNew) ? -1 : 1;</div>
<div class="line">+        }</div>
<div class="line">+</div>
<div class="line">+        <span class="comment">// even if next candidate is pop equal to current pindexNew, it is likely to have higher work</span></div>
<div class="line">+        <span class="keywordflow">if</span> (popComparisonResult &lt;= 0) {</div>
<div class="line">+            <span class="comment">// candidate is either has POP or WORK better</span></div>
<div class="line">+            bestCandidate = pindexNew;</div>
<div class="line">+        }</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">return</span> bestCandidate;</div>
<div class="line">+}</div>
<div class="line">+</div>
<div class="line">+<span class="keywordtype">bool</span> CChainState::TestBlockIndex(CBlockIndex* pindexTest)</div>
<div class="line">+{</div>
<div class="line">+    CBlockIndex* testWalkBlock = pindexTest;</div>
<div class="line">+    <span class="keywordtype">bool</span> fInvalidAncestor = <span class="keyword">false</span>;</div>
<div class="line">+    <span class="keywordflow">while</span> (testWalkBlock &amp;&amp; !m_chain.Contains(testWalkBlock)) {</div>
<div class="line">+        assert(testWalkBlock-&gt;HaveTxsDownloaded() || testWalkBlock-&gt;nHeight == 0);</div>
<div class="line">+</div>
<div class="line">+        <span class="comment">// Pruned nodes may have entries in setBlockIndexCandidates for</span></div>
<div class="line">+        <span class="comment">// which block files have been deleted.  Remove those as candidates</span></div>
<div class="line">+        <span class="comment">// for the most work chain if we come across them; we can&#39;t switch</span></div>
<div class="line">+        <span class="comment">// to a chain unless we have all the non-active-chain parent blocks.</span></div>
<div class="line">+        <span class="keywordtype">bool</span> fFailedChain = testWalkBlock-&gt;nStatus &amp; <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aaa23dda4bbc14b35a4a0a7f1e7ddc184c">BLOCK_FAILED_MASK</a>;</div>
<div class="line">+        <span class="keywordtype">bool</span> fMissingData = !(testWalkBlock-&gt;nStatus &amp; BLOCK_HAVE_DATA);</div>
<div class="line">+        <span class="keywordflow">if</span> (fFailedChain || fMissingData) {</div>
<div class="line">+            <span class="comment">// Candidate chain is not usable (either invalid or missing data)</span></div>
<div class="line">+            <span class="keywordflow">if</span> (fFailedChain &amp;&amp; (pindexBestInvalid == <span class="keyword">nullptr</span> || pindexTest-&gt;nChainWork &gt; pindexBestInvalid-&gt;nChainWork))</div>
<div class="line">+                pindexBestInvalid = pindexTest;</div>
<div class="line">+            CBlockIndex* pindexFailed = pindexTest;</div>
<div class="line">+            <span class="comment">// Remove the entire chain from the set.</span></div>
<div class="line">+            <span class="keywordflow">while</span> (testWalkBlock != pindexFailed) {</div>
<div class="line">+                <span class="keywordflow">if</span> (fFailedChain) {</div>
<div class="line">+                    pindexFailed-&gt;nStatus |= <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa5cb9d4324c455d44fedc98d9916cdd47">BLOCK_FAILED_CHILD</a>;</div>
<div class="line">+                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fMissingData) {</div>
<div class="line">+                    <span class="comment">// If we&#39;re missing data, then add back to m_blocks_unlinked,</span></div>
<div class="line">+                    <span class="comment">// so that if the block arrives in the future we can try adding</span></div>
<div class="line">+                    <span class="comment">// to setBlockIndexCandidates again.</span></div>
<div class="line">+                    m_blockman.m_blocks_unlinked.insert(</div>
<div class="line">+                        std::make_pair(pindexFailed-&gt;pprev, pindexFailed));</div>
<div class="line">+                }</div>
<div class="line">+                setBlockIndexCandidates.erase(pindexFailed);</div>
<div class="line">+                pindexFailed = pindexFailed-&gt;pprev;</div>
<div class="line">+            }</div>
<div class="line">+            setBlockIndexCandidates.erase(testWalkBlock);</div>
<div class="line">+            fInvalidAncestor = <span class="keyword">true</span>;</div>
<div class="line">+            <span class="keywordflow">break</span>;</div>
<div class="line">+        }</div>
<div class="line">+        testWalkBlock = testWalkBlock-&gt;pprev;</div>
<div class="line">+    }</div>
<div class="line">+    <span class="keywordflow">return</span> !fInvalidAncestor;</div>
<div class="line">+}</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L2709">method CChainState::PruneBlockIndexCandidates</a> </p><div class="fragment"><div class="line">     <span class="comment">// Note that we can&#39;t delete the current block itself, as we may need to return to it later in case a</span></div>
<div class="line">     <span class="comment">// reorganization to a better block fails.</span></div>
<div class="line">-    std::set&lt;CBlockIndex*, CBlockIndexWorkComparator&gt;::iterator it = setBlockIndexCandidates.begin();</div>
<div class="line">-    <span class="keywordflow">while</span> (it != setBlockIndexCandidates.end() &amp;&amp; setBlockIndexCandidates.value_comp()(*it, m_chain.Tip())) {</div>
<div class="line">-        setBlockIndexCandidates.erase(it++);</div>
<div class="line">-    }</div>
<div class="line">+    <span class="comment">//std::set&lt;CBlockIndex*, CBlockIndexWorkComparator&gt;::iterator it = setBlockIndexCandidates.begin();</span></div>
<div class="line">+    <span class="comment">//while (it != setBlockIndexCandidates.end() &amp;&amp; setBlockIndexCandidates.value_comp()(*it, m_chain.Tip())) {</span></div>
<div class="line">+    <span class="comment">//    setBlockIndexCandidates.erase(it++);</span></div>
<div class="line">+    <span class="comment">//}</span></div>
<div class="line">+</div>
<div class="line">+    <span class="comment">// VeriBlock</span></div>
<div class="line">+    <span class="keyword">auto</span> temp_set = setBlockIndexCandidates;</div>
<div class="line">+    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; el : temp_set) {</div>
<div class="line">+        <span class="keywordflow">if</span> (el-&gt;pprev != <span class="keyword">nullptr</span>) {</div>
<div class="line">+            setBlockIndexCandidates.erase(el-&gt;pprev);</div>
<div class="line">+        }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L2856">method CChainState::ActivateBestChain</a> </p><div class="fragment"><div class="line">-    CBlockIndex *pindexMostWork = <span class="keyword">nullptr</span>;</div>
<div class="line">+    CBlockIndex* pindexBestChain = <span class="keyword">nullptr</span>;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L2856">method CChainState::ActivateBestChain</a> </p><div class="fragment"><div class="line">                 ConnectTrace connectTrace(mempool); <span class="comment">// Destructed before cs_main is unlocked</span></div>
<div class="line"> </div>
<div class="line">-                <span class="keywordflow">if</span> (pindexMostWork == <span class="keyword">nullptr</span>) {</div>
<div class="line">-                    pindexMostWork = FindMostWorkChain();</div>
<div class="line">+                <span class="keywordflow">if</span> (pblock &amp;&amp; pindexBestChain == <span class="keyword">nullptr</span>) {</div>
<div class="line">+                    <span class="keyword">auto</span>* blockindex = LookupBlockIndex(pblock-&gt;GetHash());</div>
<div class="line">+                    assert(blockindex);</div>
<div class="line">+</div>
<div class="line">+                    <span class="keyword">auto</span> tmp_set = setBlockIndexCandidates;</div>
<div class="line">+                    <span class="keywordflow">for</span> (<span class="keyword">auto</span>* candidate : tmp_set) {</div>
<div class="line">+                        <span class="comment">// if candidate has txs downloaded &amp; currently arrived block is ancestor of `candidate`</span></div>
<div class="line">+                        <span class="keywordflow">if</span> (candidate-&gt;HaveTxsDownloaded() &amp;&amp; TestBlockIndex(candidate) &amp;&amp; candidate-&gt;GetAncestor(blockindex-&gt;nHeight) == blockindex) {</div>
<div class="line">+                            <span class="comment">// then do pop fr with candidate, instead of blockindex</span></div>
<div class="line">+                            pindexBestChain = VeriBlock::compareTipToBlock(candidate);</div>
<div class="line">+                        }</div>
<div class="line">+                    }</div>
<div class="line">+                }</div>
<div class="line">+</div>
<div class="line">+                <span class="keywordflow">if</span> (pindexBestChain == <span class="keyword">nullptr</span>) {</div>
<div class="line">+                    pindexBestChain = FindBestChain();</div>
<div class="line">                 }</div>
<div class="line"> </div>
<div class="line">                 <span class="comment">// Whether we have anything to do at all.</span></div>
<div class="line">-                <span class="keywordflow">if</span> (pindexMostWork == <span class="keyword">nullptr</span> || pindexMostWork == m_chain.Tip()) {</div>
<div class="line">+                <span class="keywordflow">if</span> (pindexBestChain == <span class="keyword">nullptr</span> || pindexBestChain == m_chain.Tip()) {</div>
<div class="line">                     <span class="keywordflow">break</span>;</div>
<div class="line">                 }</div>
<div class="line"> </div>
<div class="line">+                assert(pindexBestChain);</div>
<div class="line">+                <span class="comment">// if pindexBestHeader is a direct successor of pindexBestChain, pindexBestHeader is still best.</span></div>
<div class="line">+                <span class="comment">// otherwise pindexBestChain is new best pindexBestHeader</span></div>
<div class="line">+                <span class="keywordflow">if</span> (pindexBestHeader == <span class="keyword">nullptr</span> || pindexBestHeader-&gt;GetAncestor(pindexBestChain-&gt;nHeight) != pindexBestChain) {</div>
<div class="line">+                    pindexBestHeader = pindexBestChain;</div>
<div class="line">+                }</div>
<div class="line">+</div>
<div class="line">                 <span class="keywordtype">bool</span> fInvalidFound = <span class="keyword">false</span>;</div>
<div class="line">                 std::shared_ptr&lt;const CBlock&gt; nullBlockPtr;</div>
<div class="line">-                <span class="keywordflow">if</span> (!ActivateBestChainStep(state, chainparams, pindexMostWork, pblock &amp;&amp; pblock-&gt;GetHash() == pindexMostWork-&gt;GetBlockHash() ? pblock : nullBlockPtr, fInvalidFound, connectTrace)) {</div>
<div class="line">+                <span class="keywordflow">if</span> (!ActivateBestChainStep(state, chainparams, pindexBestChain, pblock &amp;&amp; pblock-&gt;GetHash() == pindexBestChain-&gt;GetBlockHash() ? pblock : nullBlockPtr, fInvalidFound, connectTrace)) {</div>
<div class="line">                     <span class="comment">// A system error occurred</span></div>
<div class="line">                     <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">                 }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L2856">method CChainState::ActivateBestChain</a> </p><div class="fragment"><div class="line">                 <span class="keywordflow">if</span> (fInvalidFound) {</div>
<div class="line">                     <span class="comment">// Wipe cache, we may need another branch now.</span></div>
<div class="line">-                    pindexMostWork = <span class="keyword">nullptr</span>;</div>
<div class="line">+                    pindexBestChain = <span class="keyword">nullptr</span>;</div>
<div class="line">                 }</div>
<div class="line">                 pindexNewTip = m_chain.Tip();</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L2856">method CChainState::ActivateBestChain</a> </p><div class="fragment"><div class="line">         <span class="keywordflow">if</span> (ShutdownRequested())</div>
<div class="line">             <span class="keywordflow">break</span>;</div>
<div class="line">-    } <span class="keywordflow">while</span> (pindexNewTip != pindexMostWork);</div>
<div class="line">+    } <span class="keywordflow">while</span> (pindexNewTip != pindexBestChain);</div>
<div class="line">+</div>
<div class="line">     CheckBlockIndex(chainparams.GetConsensus());</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3017">method CChainState::InvalidateBlock</a> </p><div class="fragment"><div class="line">         <span class="keywordflow">while</span> (it != m_blockman.m_block_index.end()) {</div>
<div class="line">-            <span class="keywordflow">if</span> (it-&gt;second-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; it-&gt;second-&gt;HaveTxsDownloaded() &amp;&amp; !setBlockIndexCandidates.value_comp()(it-&gt;second, m_chain.Tip())) {</div>
<div class="line">+            <span class="keywordflow">if</span> (it-&gt;second-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; it-&gt;second-&gt;HaveTxsDownloaded()</div>
<div class="line">+                <span class="comment">// VeriBlock: setBlockIndexCandidates now stores all tips</span></div>
<div class="line">+                <span class="comment">/*&amp;&amp; !setBlockIndexCandidates.value_comp()(it-&gt;second, m_chain.Tip())*/</span></div>
<div class="line">+            ) {</div>
<div class="line">                 setBlockIndexCandidates.insert(it-&gt;second);</div>
<div class="line">             }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3017">method CChainState::InvalidateBlock</a> </p><div class="fragment"><div class="line">         InvalidChainFound(to_mark_failed);</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">+    PruneBlockIndexCandidates();</div>
<div class="line">+</div>
<div class="line">     <span class="comment">// Only notify about a new block tip if the active chain was modified.</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3162">method CChainState::ResetBlockFailureFlags</a> </p><div class="fragment"><div class="line">     <span class="keywordtype">int</span> nHeight = pindex-&gt;nHeight;</div>
<div class="line">+    <span class="keyword">auto</span> blockHash = pindex-&gt;GetBlockHash().asVector();</div>
<div class="line">+    VeriBlock::GetPop().getAltBlockTree().revalidateSubtree(blockHash, <a class="code hl_enumvalue" href="namespacealtintegration.html#a798d9fc435a987ae04ecc3ef4f5e736aa12343296a7f3939747d6728499a4efee">altintegration::BLOCK_FAILED_BLOCK</a>, <span class="keyword">false</span>);</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3162">method CChainState::ResetBlockFailureFlags</a> </p><div class="fragment"><div class="line">             setDirtyBlockIndex.insert(it-&gt;second);</div>
<div class="line">-            <span class="keywordflow">if</span> (it-&gt;second-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; it-&gt;second-&gt;HaveTxsDownloaded() &amp;&amp; setBlockIndexCandidates.value_comp()(m_chain.Tip(), it-&gt;second)) {</div>
<div class="line">+            <span class="keywordflow">if</span> (it-&gt;second-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; it-&gt;second-&gt;HaveTxsDownloaded()</div>
<div class="line">+                <span class="comment">// VeriBlock: setBlockIndexCandidates now stores all tips</span></div>
<div class="line">+                <span class="comment">/*&amp;&amp; setBlockIndexCandidates.value_comp()(m_chain.Tip(), it-&gt;second)*/</span></div>
<div class="line">+            ) {</div>
<div class="line">                 setBlockIndexCandidates.insert(it-&gt;second);</div>
<div class="line">             }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3162">method CChainState::ResetBlockFailureFlags</a> </p><div class="fragment"><div class="line">     }</div>
<div class="line"> </div>
<div class="line">+    PruneBlockIndexCandidates();</div>
<div class="line">+</div>
<div class="line">     <span class="comment">// Remove the invalidity flag from all ancestors too.</span></div>
<div class="line">     <span class="keywordflow">while</span> (pindex != <span class="keyword">nullptr</span>) {</div>
<div class="line">         <span class="keywordflow">if</span> (pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK) {</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3209">method BlockManager::AddToBlockIndex</a> </p><div class="fragment"><div class="line">     pindexNew-&gt;RaiseValidity(BLOCK_VALID_TREE);</div>
<div class="line">-    <span class="keywordflow">if</span> (pindexBestHeader == <span class="keyword">nullptr</span> || pindexBestHeader-&gt;nChainWork &lt; pindexNew-&gt;nChainWork)</div>
<div class="line">+    <span class="comment">// VeriBlock: if pindexNew is a successor of pindexBestHeader, and pindexNew has higher chainwork, then update pindexBestHeader</span></div>
<div class="line">+    <span class="keywordflow">if</span> (pindexBestHeader == <span class="keyword">nullptr</span> || ((pindexBestHeader-&gt;nChainWork &lt; pindexNew-&gt;nChainWork) &amp;&amp;</div>
<div class="line">+                                           (pindexNew-&gt;GetAncestor(pindexBestHeader-&gt;nHeight) == pindexBestHeader)))</div>
<div class="line">         pindexBestHeader = pindexNew;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3247">method CChainState::ReceivedBlockTransactions</a> </p><div class="fragment"><div class="line">-            <span class="keywordflow">if</span> (m_chain.Tip() == <span class="keyword">nullptr</span> || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {</div>
<div class="line">+            <span class="comment">/*if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {</span></div>
<div class="line"><span class="comment">                 setBlockIndexCandidates.insert(pindex);</span></div>
<div class="line"><span class="comment">-            }</span></div>
<div class="line"><span class="comment">+            }*/</span></div>
<div class="line">+            setBlockIndexCandidates.insert(pindex);</div>
<div class="line">             std::pair&lt;std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator, std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator&gt; range = m_blockman.m_blocks_unlinked.equal_range(pindex);</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3247">method CChainState::ReceivedBlockTransactions</a> </p><div class="fragment"><div class="line">     }</div>
<div class="line">+</div>
<div class="line">+    PruneBlockIndexCandidates();</div>
<div class="line"> }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3796">method CChainState::AcceptBlock</a> </p><div class="fragment"><div class="line">     <span class="keywordflow">if</span> (fAlreadyHave) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">-    <span class="keywordflow">if</span> (!fRequested) {  <span class="comment">// If we didn&#39;t ask for it:</span></div>
<div class="line">-        <span class="keywordflow">if</span> (pindex-&gt;nTx != 0) <span class="keywordflow">return</span> <span class="keyword">true</span>;    <span class="comment">// This is a previously-processed block that was pruned</span></div>
<div class="line">-        <span class="keywordflow">if</span> (!fHasMoreOrSameWork) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Don&#39;t process less-work chains</span></div>
<div class="line">-        <span class="keywordflow">if</span> (fTooFarAhead) <span class="keywordflow">return</span> <span class="keyword">true</span>;        <span class="comment">// Block height is too high</span></div>
<div class="line">+    <span class="keywordflow">if</span> (!fRequested) {                     <span class="comment">// If we didn&#39;t ask for it:</span></div>
<div class="line">+        <span class="keywordflow">if</span> (pindex-&gt;nTx != 0) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// This is a previously-processed block that was pruned</span></div>
<div class="line">+        <span class="keywordflow">if</span> (fTooFarAhead) <span class="keywordflow">return</span> <span class="keyword">true</span>;     <span class="comment">// Block height is too high</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L4905">method CChainState::CheckBlockIndex</a> </p><div class="fragment"><div class="line">-        <span class="keywordflow">if</span> (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) &amp;&amp; pindexFirstNeverProcessed == <span class="keyword">nullptr</span>) {</div>
<div class="line">-            <span class="keywordflow">if</span> (pindexFirstInvalid == <span class="keyword">nullptr</span>) {</div>
<div class="line">-                <span class="comment">// If this block sorts at least as good as the current tip and</span></div>
<div class="line">-                <span class="comment">// is valid and we have all data for its parents, it must be in</span></div>
<div class="line">-                <span class="comment">// setBlockIndexCandidates.  m_chain.Tip() must also be there</span></div>
<div class="line">-                <span class="comment">// even if some data has been pruned.</span></div>
<div class="line">-                <span class="keywordflow">if</span> (pindexFirstMissing == <span class="keyword">nullptr</span> || pindex == m_chain.Tip()) {</div>
<div class="line">-                    assert(setBlockIndexCandidates.count(pindex));</div>
<div class="line">-                }</div>
<div class="line">-                <span class="comment">// If some parent is missing, then it could be that this block was in</span></div>
<div class="line">-                <span class="comment">// setBlockIndexCandidates but had to be removed because of the missing data.</span></div>
<div class="line">-                <span class="comment">// In this case it must be in m_blocks_unlinked -- see test below.</span></div>
<div class="line">-            }</div>
<div class="line">-        } <span class="keywordflow">else</span> { <span class="comment">// If this block sorts worse than the current tip or some ancestor&#39;s block has never been seen, it cannot be in setBlockIndexCandidates.</span></div>
<div class="line">-            assert(setBlockIndexCandidates.count(pindex-&gt;pprev) == 0);</div>
<div class="line">-        }</div>
<div class="line">+        <span class="comment">//VeriBlock</span></div>
<div class="line">+        <span class="comment">//if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) &amp;&amp; pindexFirstNeverProcessed == nullptr) {</span></div>
<div class="line">+        <span class="comment">//    if (pindexFirstInvalid == nullptr) {</span></div>
<div class="line">+        <span class="comment">//        // If this block sorts at least as good as the current tip and</span></div>
<div class="line">+        <span class="comment">//        // is valid and we have all data for its parents, it must be in</span></div>
<div class="line">+        <span class="comment">//        // setBlockIndexCandidates.  m_chain.Tip() must also be there</span></div>
<div class="line">+        <span class="comment">//        // even if some data has been pruned.</span></div>
<div class="line">+        <span class="comment">//        if (pindexFirstMissing == nullptr || pindex == m_chain.Tip()) {</span></div>
<div class="line">+        <span class="comment">//            assert(setBlockIndexCandidates.count(pindex));</span></div>
<div class="line">+        <span class="comment">//        }</span></div>
<div class="line">+        <span class="comment">//        // If some parent is missing, then it could be that this block was in</span></div>
<div class="line">+        <span class="comment">//        // setBlockIndexCandidates but had to be removed because of the missing data.</span></div>
<div class="line">+        <span class="comment">//        // In this case it must be in m_blocks_unlinked -- see test below.</span></div>
<div class="line">+        <span class="comment">//    }</span></div>
<div class="line">+        <span class="comment">//} else { // If this block sorts worse than the current tip or some ancestor&#39;s block has never been seen, it cannot be in setBlockIndexCandidates.</span></div>
<div class="line">+        <span class="comment">//    assert(setBlockIndexCandidates.count(pindex-&gt;pprev) == 0);</span></div>
<div class="line">+        <span class="comment">//}</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md7"></a>
3. Add Pop fork resolution unit test.</h1>
<p >Pop fork resolution test: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/unit/forkresolution_tests.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/unit/forkresolution_tests.cpp</a>. Copy this file to your project.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
4. Update makefile to run tests.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.test.include">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.test.include</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> ### VeriBlock section start</span></div>
<div class="line"><span class="preprocessor"> # path is relative to src</span></div>
<div class="line"> VBK_TESTS = \</div>
<div class="line">   vbk/test/unit/e2e_poptx_tests.cpp \</div>
<div class="line">   vbk/test/unit/block_validation_tests.cpp \</div>
<div class="line">   vbk/test/unit/vbk_merkle_tests.cpp \</div>
<div class="line">-  vbk/test/unit/pop_reward_tests.cpp</div>
<div class="line">+  vbk/test/unit/pop_reward_tests.cpp \</div>
<div class="line">+  vbk/test/unit/forkresolution_tests.cpp</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<script>
    $(document).ready(function(){
        $('.line').each(function(){
            var t = $(this).html()
            if(t.startsWith("+")) {
                $(this).addClass('diff-plus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>+</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            } else if (t.startsWith("-")) {
                $(this).addClass('diff-minus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>-</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            }
        })
    });
</script>