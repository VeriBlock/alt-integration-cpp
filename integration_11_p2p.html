<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>veriblock-pop-cpp: Update P2P protocol</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="main.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">veriblock-pop-cpp
   </div>
   <div id="projectbrief">C++11 Libraries for leveraging VeriBlock Proof-Of-Proof blockchain technology.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('integration_11_p2p.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Update P2P protocol </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md9">Overview</a></li>
<li class="level1"><a href="#autotoc_md10">1. Add P2P service files: p2p_sync.hpp, p2p_sync.cpp.</a></li>
<li class="level1"><a href="#autotoc_md11">2. Introduce new protocol version.</a></li>
<li class="level1"><a href="#autotoc_md12">3. Allow node to download chain with less chainWork.</a></li>
<li class="level1"><a href="#autotoc_md13">4. Update Ping and Pong calls to provide best block hash.</a></li>
<li class="level1"><a href="#autotoc_md14">5. Offer and process Pop data.</a></li>
<li class="level1"><a href="#autotoc_md15">6. Subscribe the library to the mempool events.</a></li>
<li class="level1"><a href="#autotoc_md16">7. Add P2P service to the makefile.</a></li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_families_btc_integration_11_p2p"></a></p>
<h1><a class="anchor" id="autotoc_md9"></a>
Overview</h1>
<p >Original Bitcoin P2P sync protocol does not download blocks if advertized cumulative difficulty is lower than ours. It is no longer valid for Pop aware chains. P2P protocol should be modified to offer and accept all blocks and also should properly process ATV and VTB data.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
1. Add P2P service files: p2p_sync.hpp, p2p_sync.cpp.</h1>
<p >VeriBlock P2P service files contain interactions with Pop mempool, data filtering, misbehaving nodes protection.</p>
<p >P2P header: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/p2p_sync.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/p2p_sync.hpp</a>. Copy this file to your project.</p>
<p >P2P source: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/p2p_sync.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/p2p_sync.cpp</a>. Copy this file to your project.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
2. Introduce new protocol version.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/version.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/version.h</a> </p><div class="fragment"><div class="line">-<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> PROTOCOL_VERSION = 70015;</div>
<div class="line">+<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> PROTOCOL_VERSION = 80000;</div>
</div><!-- fragment --> <div class="fragment"><div class="line"> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> INVALID_CB_NO_BAN_VERSION = 70015;</div>
<div class="line"> </div>
<div class="line">+</div>
<div class="line">+<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> PING_BESTCHAIN_VERSION = 80000;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md12"></a>
3. Allow node to download chain with less chainWork.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.h</a> </p><div class="fragment"><div class="line"> <span class="keywordtype">bool</span> GetNodeStateStats(NodeId nodeid, CNodeStateStats &amp;stats);</div>
<div class="line"> </div>
<div class="line">+</div>
<div class="line">+<span class="keywordtype">void</span> Misbehaving(NodeId nodeid, <span class="keywordtype">int</span> howmuch, <span class="keyword">const</span> std::string&amp; message=<span class="stringliteral">&quot;&quot;</span>) EXCLUSIVE_LOCKS_REQUIRED(cs_main);</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;util/validation.h&gt;</span></div>
<div class="line">+#include &lt;vbk/p2p_sync.hpp&gt;</div>
</div><!-- fragment --> <div class="fragment"><div class="line"> <span class="keywordtype">void</span> EraseOrphansFor(NodeId peer);</div>
<div class="line"> </div>
<div class="line">-</div>
<div class="line">-<span class="keywordtype">void</span> Misbehaving(NodeId nodeid, <span class="keywordtype">int</span> howmuch, <span class="keyword">const</span> std::string&amp; message=<span class="stringliteral">&quot;&quot;</span>) EXCLUSIVE_LOCKS_REQUIRED(cs_main);</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L203">struct CNodeState</a> </p><div class="fragment"><div class="line"> </div>
<div class="line">-    <span class="keyword">const</span> CBlockIndex *pindexBestKnownBlock;</div>
<div class="line">+    <span class="keyword">const</span> CBlockIndex *pindexBestKnownBlock = <span class="keyword">nullptr</span>;</div>
<div class="line">+    </div>
<div class="line">+    <span class="keyword">const</span> CBlockIndex *pindexLastAnnouncedBlock = <span class="keyword">nullptr</span>;</div>
<div class="line">     <a class="code hl_typedef" href="namespacealtintegration.html#ab81c8673ad312417b7517390cb0915f6">uint256</a> hashLastUnknownBlock;</div>
<div class="line">-    <span class="keyword">const</span> CBlockIndex *pindexLastCommonBlock;</div>
<div class="line">+    <span class="keyword">const</span> CBlockIndex *pindexLastCommonBlock = <span class="keyword">nullptr</span>;</div>
<div class="line">+    </div>
<div class="line">+    <span class="keyword">const</span> CBlockIndex *pindexLastCommonAnnouncedBlock = <span class="keyword">nullptr</span>;</div>
<div class="ttc" id="anamespacealtintegration_html_ab81c8673ad312417b7517390cb0915f6"><div class="ttname"><a href="namespacealtintegration.html#ab81c8673ad312417b7517390cb0915f6">altintegration::uint256</a></div><div class="ttdeci">Blob&lt; SHA256_HASH_SIZE &gt; uint256</div><div class="ttdoc">This is an overloaded member function, provided for convenience. It differs from the above function o...</div><div class="ttdef"><b>Definition:</b> <a href="uint_8hpp_source.html#l00023">uint.hpp:23</a></div></div>
</div><!-- fragment --> <div class="fragment"><div class="line">+</div>
<div class="line">+<span class="keyword">static</span> <span class="keywordtype">void</span> UpdateBestChainTip(NodeId nodeid, <span class="keyword">const</span> uint256 &amp;tip) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {</div>
<div class="line">+    CNodeState *state = State(nodeid);</div>
<div class="line">+    assert(state != <span class="keyword">nullptr</span>);</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">const</span> CBlockIndex* pindex = LookupBlockIndex(tip);</div>
<div class="line">+    <span class="keywordflow">if</span> (pindex &amp;&amp; pindex-&gt;nChainWork &gt; 0) {</div>
<div class="line">+        state-&gt;pindexLastAnnouncedBlock = pindex;</div>
<div class="line">+        LogPrint(BCLog::NET, <span class="stringliteral">&quot;peer=%s: announced best chain %s\n&quot;</span>, nodeid, tip.GetHex());</div>
<div class="line">+</div>
<div class="line">+        <span class="comment">// announced block is better by chainwork. update pindexBestKnownBlock</span></div>
<div class="line">+        <span class="keywordflow">if</span>(state-&gt;pindexBestKnownBlock == <span class="keyword">nullptr</span> || pindex-&gt;nChainWork &gt;= state-&gt;pindexBestKnownBlock-&gt;nChainWork) {</div>
<div class="line">+            state-&gt;pindexBestKnownBlock = pindex;</div>
<div class="line">+        }</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    ProcessBlockAvailability(nodeid);</div>
<div class="line">+}</div>
</div><!-- fragment --> <div class="fragment"><div class="line">-<span class="keyword">static</span> <span class="keywordtype">void</span> FindNextBlocksToDownload(NodeId nodeid, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count, std::vector&lt;const CBlockIndex*&gt;&amp; vBlocks, NodeId&amp; nodeStaller, <span class="keyword">const</span> Consensus::Params&amp; consensusParams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div>
<div class="line">+<span class="keyword">static</span> <span class="keywordtype">void</span> FindNextBlocksToDownload(NodeId nodeid, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count, std::vector&lt;const CBlockIndex*&gt;&amp; vBlocks, NodeId&amp; nodeStaller, <span class="keyword">const</span> Consensus::Params&amp; consensusParams,</div>
<div class="line">+    <span class="comment">// either pindexBestBlock or pindexLastAnouncedBlock</span></div>
<div class="line">+    <span class="keyword">const</span> CBlockIndex* bestBlock,</div>
<div class="line">+    <span class="comment">// out parameter: sets last common block</span></div>
<div class="line">+    <span class="keyword">const</span> CBlockIndex** lastCommonBlockOut</div>
<div class="line">+    ) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div>
<div class="line"> {</div>
<div class="line">     <span class="keywordflow">if</span> (count == 0)</div>
<div class="line">         <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">     vBlocks.reserve(vBlocks.size() + count);</div>
<div class="line">-    CNodeState *state = State(nodeid);</div>
<div class="line">-    assert(state != <span class="keyword">nullptr</span>);</div>
<div class="line">-</div>
<div class="line">-    <span class="comment">// Make sure pindexBestKnownBlock is up to date, we&#39;ll need it.</span></div>
<div class="line">-    ProcessBlockAvailability(nodeid);</div>
<div class="line"> </div>
<div class="line">-    <span class="keywordflow">if</span> (state-&gt;pindexBestKnownBlock == <span class="keyword">nullptr</span> || state-&gt;pindexBestKnownBlock-&gt;nChainWork &lt; ::ChainActive().Tip()-&gt;nChainWork || state-&gt;pindexBestKnownBlock-&gt;nChainWork &lt; nMinimumChainWork) {</div>
<div class="line">+    <span class="keywordflow">if</span> (bestBlock == <span class="keyword">nullptr</span> || bestBlock-&gt;nChainWork &lt; nMinimumChainWork) {</div>
<div class="line">         <span class="comment">// This peer has nothing interesting.</span></div>
<div class="line">         <span class="keywordflow">return</span>;</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">-    <span class="keywordflow">if</span> (state-&gt;pindexLastCommonBlock == <span class="keyword">nullptr</span>) {</div>
<div class="line">+    assert(lastCommonBlockOut);</div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">if</span> (*lastCommonBlockOut == <span class="keyword">nullptr</span>) {</div>
<div class="line">         <span class="comment">// Bootstrap quickly by guessing a parent of our best tip is the forking point.</span></div>
<div class="line">         <span class="comment">// Guessing wrong in either direction is not a problem.</span></div>
<div class="line">-        state-&gt;pindexLastCommonBlock = ::ChainActive()[std::min(state-&gt;pindexBestKnownBlock-&gt;nHeight, ::ChainActive().Height())];</div>
<div class="line">+        *lastCommonBlockOut = ::ChainActive()[std::min(bestBlock-&gt;nHeight, ::ChainActive().Height())];</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">// If the peer reorganized, our previous pindexLastCommonBlock may not be an ancestor</span></div>
<div class="line">     <span class="comment">// of its current tip anymore. Go back enough to fix that.</span></div>
<div class="line">-    state-&gt;pindexLastCommonBlock = LastCommonAncestor(state-&gt;pindexLastCommonBlock, state-&gt;pindexBestKnownBlock);</div>
<div class="line">-    <span class="keywordflow">if</span> (state-&gt;pindexLastCommonBlock == state-&gt;pindexBestKnownBlock)</div>
<div class="line">+    *lastCommonBlockOut = LastCommonAncestor(*lastCommonBlockOut, bestBlock);</div>
<div class="line">+    <span class="keywordflow">if</span> (*lastCommonBlockOut == bestBlock)</div>
<div class="line">         <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">     std::vector&lt;const CBlockIndex*&gt; vToFetch;</div>
<div class="line">-    <span class="keyword">const</span> CBlockIndex *pindexWalk = state-&gt;pindexLastCommonBlock;</div>
<div class="line">+    <span class="keyword">const</span> CBlockIndex *pindexWalk = *lastCommonBlockOut;</div>
<div class="line">     <span class="comment">// Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond the last</span></div>
<div class="line">     <span class="comment">// linked block we have in common with this peer. The +1 is so we can detect stalling, namely if we would be able to</span></div>
<div class="line">     <span class="comment">// download that next block if the window were 1 larger.</span></div>
<div class="line">-    <span class="keywordtype">int</span> nWindowEnd = state-&gt;pindexLastCommonBlock-&gt;nHeight + BLOCK_DOWNLOAD_WINDOW;</div>
<div class="line">-    <span class="keywordtype">int</span> nMaxHeight = std::min&lt;int&gt;(state-&gt;pindexBestKnownBlock-&gt;nHeight, nWindowEnd + 1);</div>
<div class="line">+    <span class="keywordtype">int</span> nWindowEnd = (*lastCommonBlockOut)-&gt;nHeight + BLOCK_DOWNLOAD_WINDOW;</div>
<div class="line">+    <span class="keywordtype">int</span> nMaxHeight = std::min&lt;int&gt;(bestBlock-&gt;nHeight, nWindowEnd + 1);</div>
<div class="line">     NodeId waitingfor = -1;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L618">method FindNextBlocksToDownload</a> </p><div class="fragment"><div class="line">         <span class="keywordtype">int</span> nToFetch = std::min(nMaxHeight - pindexWalk-&gt;nHeight, std::max&lt;int&gt;(count - vBlocks.size(), 128));</div>
<div class="line">         vToFetch.resize(nToFetch);</div>
<div class="line">-        pindexWalk = state-&gt;pindexBestKnownBlock-&gt;GetAncestor(pindexWalk-&gt;nHeight + nToFetch);</div>
<div class="line">+        pindexWalk = bestBlock-&gt;GetAncestor(pindexWalk-&gt;nHeight + nToFetch);</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L618">method FindNextBlocksToDownload</a> </p><div class="fragment"><div class="line">             <span class="keywordflow">if</span> (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA || ::ChainActive().Contains(pindex)) {</div>
<div class="line">                 <span class="keywordflow">if</span> (pindex-&gt;HaveTxsDownloaded())</div>
<div class="line">-                    state-&gt;pindexLastCommonBlock = pindex;</div>
<div class="line">+                    *lastCommonBlockOut = pindex;</div>
<div class="line">             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mapBlocksInFlight.count(pindex-&gt;GetBlockHash()) == 0) {</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L1675">method ProcessHeadersMessage</a> </p><div class="fragment"><div class="line">-        <span class="keywordflow">if</span> (fCanDirectFetch &amp;&amp; pindexLast-&gt;IsValid(BLOCK_VALID_TREE) &amp;&amp; ::ChainActive().Tip()-&gt;nChainWork &lt;= pindexLast-&gt;nChainWork) {</div>
<div class="line">+        <span class="keywordflow">if</span> (fCanDirectFetch &amp;&amp; pindexLast-&gt;IsValid(BLOCK_VALID_TREE)</div>
<div class="line">+            <span class="comment">// VeriBlock: download the chain suggested by the peer</span></div>
<div class="line">+            <span class="comment">/* &amp;&amp; ::ChainActive().Tip()-&gt;nChainWork &lt;= pindexLast-&gt;nChainWork */</span>) {</div>
<div class="line">             std::vector&lt;const CBlockIndex*&gt; vToFetch;</div>
<div class="line">             <span class="keyword">const</span> CBlockIndex *pindexWalk = pindexLast;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L3596">method PeerLogicValidation::SendMessages</a> </p><div class="fragment"><div class="line">         <span class="keywordflow">if</span> (!pto-&gt;fClient &amp;&amp; ((fFetch &amp;&amp; !pto-&gt;m_limited_node) || !::ChainstateActive().IsInitialBlockDownload()) &amp;&amp; state.nBlocksInFlight &lt; MAX_BLOCKS_IN_TRANSIT_PER_PEER) {</div>
<div class="line">             std::vector&lt;const CBlockIndex*&gt; vToDownload;</div>
<div class="line">             NodeId staller = -1;</div>
<div class="line">-            FindNextBlocksToDownload(pto-&gt;GetId(), MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller, consensusParams);</div>
<div class="line">+            <span class="comment">// VeriBlock: find &quot;blocks to download&quot; in 2 chains: one that has &quot;best chainwork&quot;, and second that is reported by peer as best.</span></div>
<div class="line">+            ProcessBlockAvailability(pto-&gt;GetId());</div>
<div class="line">+            <span class="comment">// always download chain with higher chainwork</span></div>
<div class="line">+            <span class="keywordflow">if</span>(state.pindexBestKnownBlock) {</div>
<div class="line">+                FindNextBlocksToDownload(pto-&gt;GetId(), MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller, consensusParams, state.pindexBestKnownBlock, &amp;state.pindexLastCommonBlock);</div>
<div class="line">+            }</div>
<div class="line">+            <span class="comment">// should we fetch announced chain?</span></div>
<div class="line">+            <span class="keywordflow">if</span>(state.pindexLastAnnouncedBlock &amp;&amp; state.pindexBestKnownBlock) {</div>
<div class="line">+                <span class="comment">// last announced block is by definition always &lt;= chainwork than best known block by chainwork</span></div>
<div class="line">+                assert(state.pindexLastAnnouncedBlock-&gt;nChainWork &lt;= state.pindexBestKnownBlock-&gt;nChainWork);</div>
<div class="line">+</div>
<div class="line">+                <span class="comment">// are they in the same chain?</span></div>
<div class="line">+                <span class="keywordflow">if</span> (state.pindexBestKnownBlock-&gt;GetAncestor(state.pindexLastAnnouncedBlock-&gt;nHeight) != state.pindexLastAnnouncedBlock) {</div>
<div class="line">+                    <span class="comment">// no, additionally sync &#39;announced&#39; chain</span></div>
<div class="line">+                    LogPrint(BCLog::NET, <span class="stringliteral">&quot;Requesting announced best chain %d:%s from peer=%d\n&quot;</span>, state.pindexLastAnnouncedBlock-&gt;GetBlockHash().ToString(),</div>
<div class="line">+                        state.pindexLastAnnouncedBlock-&gt;nHeight, pto-&gt;GetId());</div>
<div class="line">+                    FindNextBlocksToDownload(pto-&gt;GetId(), MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller, consensusParams, state.pindexLastAnnouncedBlock, &amp;state.pindexLastCommonAnnouncedBlock);</div>
<div class="line">+                }</div>
<div class="line">+            }</div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keyword">const</span> CBlockIndex *pindex : vToDownload) {</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md13"></a>
4. Update Ping and Pong calls to provide best block hash.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L1919">method ProcessMessage</a> </p><div class="fragment"><div class="line">             uint64_t nonce = 0;</div>
<div class="line">             vRecv &gt;&gt; nonce;</div>
<div class="line">+</div>
<div class="line">+            <span class="keywordflow">if</span>(pfrom-&gt;nVersion &gt; PING_BESTCHAIN_VERSION) {</div>
<div class="line">+                <span class="comment">// VeriBlock: immediately after nonce, receive best block hash</span></div>
<div class="line">+                LOCK(cs_main);</div>
<div class="line">+                <a class="code hl_typedef" href="namespacealtintegration.html#ab81c8673ad312417b7517390cb0915f6">uint256</a> bestHash;</div>
<div class="line">+                vRecv &gt;&gt; bestHash;</div>
<div class="line">+                UpdateBestChainTip(pfrom-&gt;GetId(), bestHash);</div>
<div class="line">+</div>
<div class="line">+                connman-&gt;PushMessage(pfrom, msgMaker.Make(NetMsgType::PONG, nonce, ::ChainActive().Tip()-&gt;GetBlockHash()));</div>
<div class="line">+                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">+            }</div>
<div class="line">+</div>
<div class="line">             <span class="comment">// Echo the message back with the nonce. This allows for two useful features:</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L1919">method ProcessMessage</a> </p><div class="fragment"><div class="line">                         sProblem = <span class="stringliteral">&quot;Nonce zero&quot;</span>;</div>
<div class="line">                     }</div>
<div class="line">                 }</div>
<div class="line">+</div>
<div class="line">+                <span class="keywordflow">if</span>(pfrom-&gt;nVersion &gt; PING_BESTCHAIN_VERSION) {</div>
<div class="line">+                    LOCK(cs_main);</div>
<div class="line">+                    <a class="code hl_typedef" href="namespacealtintegration.html#ab81c8673ad312417b7517390cb0915f6">uint256</a> bestHash;</div>
<div class="line">+                    vRecv &gt;&gt; bestHash;</div>
<div class="line">+                    UpdateBestChainTip(pfrom-&gt;GetId(), bestHash);</div>
<div class="line">+                }</div>
<div class="line">             } <span class="keywordflow">else</span> {</div>
<div class="line">                 sProblem = <span class="stringliteral">&quot;Unsolicited pong without ping&quot;</span>;</div>
<div class="line">             }</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L3596">method PeerLogicValidation::SendMessages</a> </p><div class="fragment"><div class="line">             <span class="keywordflow">if</span> (pto-&gt;nVersion &gt; BIP0031_VERSION) {</div>
<div class="line">                 pto-&gt;nPingNonceSent = nonce;</div>
<div class="line">-                connman-&gt;PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));</div>
<div class="line">+                <span class="keywordflow">if</span>(pto-&gt;nVersion &gt; PING_BESTCHAIN_VERSION) {</div>
<div class="line">+                    connman-&gt;PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce, ::ChainActive().Tip()-&gt;GetBlockHash()));</div>
<div class="line">+                } <span class="keywordflow">else</span> {</div>
<div class="line">+                    connman-&gt;PushMessage(pto, msgMaker.Make(NetMsgType::PING, nonce));</div>
<div class="line">+                }</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md14"></a>
5. Offer and process Pop data.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L799">method PeerLogicValidation::FinalizeNode</a> </p><div class="fragment"><div class="line">     assert(g_outbound_peers_with_protect_from_disconnect &gt;= 0);</div>
<div class="line"> </div>
<div class="line">     mapNodeState.erase(nodeid);</div>
<div class="line">+    <span class="comment">// VeriBlock</span></div>
<div class="line">+    VeriBlock::p2p::erasePopDataNodeState(nodeid);</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L1919">method ProcessMessage</a> </p><div class="fragment"><div class="line">     }</div>
<div class="line"> </div>
<div class="line">+    <span class="comment">// VeriBlock: if POP is not enabled, ignore POP-related P2P calls</span></div>
<div class="line">+    <span class="keywordtype">int</span> tipHeight = ChainActive().Height();</div>
<div class="line">+    <span class="keywordflow">if</span> (Params().isPopActive(tipHeight)) {</div>
<div class="line">+        <span class="keywordtype">int</span> pop_res = VeriBlock::p2p::processPopData(pfrom, strCommand, vRecv, connman);</div>
<div class="line">+        <span class="keywordflow">if</span> (pop_res &gt;= 0) {</div>
<div class="line">+            <span class="keywordflow">return</span> pop_res;</div>
<div class="line">+        }</div>
<div class="line">+    }</div>
<div class="line"> </div>
<div class="line">     <span class="keywordflow">if</span> (!(pfrom-&gt;GetLocalServices() &amp; NODE_BLOOM) &amp;&amp;</div>
<div class="line">               (strCommand == NetMsgType::FILTERLOAD ||</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/net_processing.cpp#L3596">method PeerLogicValidation::SendMessages</a> </p><div class="fragment"><div class="line">         <span class="keywordflow">if</span> (!vInv.empty())</div>
<div class="line">             connman-&gt;PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));</div>
<div class="line"> </div>
<div class="line">+        <span class="comment">// VeriBlock offer Pop Data</span></div>
<div class="line">+        {</div>
<div class="line">+            VeriBlock::p2p::offerPopData&lt;altintegration::ATV&gt;(pto, connman, msgMaker);</div>
<div class="line">+            VeriBlock::p2p::offerPopData&lt;altintegration::VTB&gt;(pto, connman, msgMaker);</div>
<div class="line">+            VeriBlock::p2p::offerPopData&lt;altintegration::VbkBlock&gt;(pto, connman, msgMaker);</div>
<div class="line">+        }</div>
<div class="line">+</div>
<div class="line">         <span class="comment">// Detect whether we&#39;re stalling</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md15"></a>
6. Subscribe the library to the mempool events.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.cpp</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;vbk/adaptors/block_provider.hpp&gt;</span></div>
<div class="line">+#include &lt;vbk/p2p_sync.hpp&gt;</div>
<div class="line"><span class="preprocessor"> #include &lt;vbk/pop_common.hpp&gt;</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/pop_service.cpp#L30">method InitPopContext</a> </p><div class="fragment"><div class="line">     SetPop(payloads_provider);</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">auto</span>&amp; app = GetPop();</div>
<div class="line">+    app.getMemPool().onAccepted&lt;<a class="code hl_class" href="structaltintegration_1_1ATV.html">altintegration::ATV</a>&gt;(VeriBlock::p2p::offerPopDataToAllNodes&lt;altintegration::ATV&gt;);</div>
<div class="line">+    app.getMemPool().onAccepted&lt;<a class="code hl_struct" href="structaltintegration_1_1VTB.html">altintegration::VTB</a>&gt;(VeriBlock::p2p::offerPopDataToAllNodes&lt;altintegration::VTB&gt;);</div>
<div class="line">+    app.getMemPool().onAccepted&lt;<a class="code hl_struct" href="structaltintegration_1_1VbkBlock.html">altintegration::VbkBlock</a>&gt;(VeriBlock::p2p::offerPopDataToAllNodes&lt;altintegration::VbkBlock&gt;);</div>
<div class="ttc" id="astructaltintegration_1_1ATV_html"><div class="ttname"><a href="structaltintegration_1_1ATV.html">altintegration::ATV</a></div><div class="ttdoc">Atlchain endorsement.</div><div class="ttdef"><b>Definition:</b> <a href="atv_8hpp_source.html#l00028">atv.hpp:28</a></div></div>
<div class="ttc" id="astructaltintegration_1_1VTB_html"><div class="ttname"><a href="structaltintegration_1_1VTB.html">altintegration::VTB</a></div><div class="ttdoc">Veriblock to Bitcoin publication, committed to Veriblock blockchain in containingBlock.</div><div class="ttdef"><b>Definition:</b> <a href="vtb_8hpp_source.html#l00028">vtb.hpp:28</a></div></div>
<div class="ttc" id="astructaltintegration_1_1VbkBlock_html"><div class="ttname"><a href="structaltintegration_1_1VbkBlock.html">altintegration::VbkBlock</a></div><div class="ttdoc">Veriblock block.</div><div class="ttdef"><b>Definition:</b> <a href="vbkblock_8hpp_source.html#l00032">vbkblock.hpp:32</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md16"></a>
7. Add P2P service to the makefile.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.am">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.am</a> </p><div class="fragment"><div class="line">libbitcoin_server_a_SOURCES = \</div>
<div class="line">   policy/settings.cpp \</div>
<div class="line">   pow.cpp \</div>
<div class="line">   rest.cpp \</div>
<div class="line">+  vbk/p2p_sync.hpp \</div>
<div class="line">+  vbk/p2p_sync.cpp \</div>
<div class="line">   rpc/blockchain.cpp \</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<script>
    $(document).ready(function(){
        $('.line').each(function(){
            var t = $(this).html()
            if(t.startsWith("+")) {
                $(this).addClass('diff-plus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>+</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            } else if (t.startsWith("-")) {
                $(this).addClass('diff-minus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>-</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            }
        })
    });
</script>