<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>veriblock-pop-cpp: Pop Merkle trees</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="main.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">veriblock-pop-cpp
   </div>
   <div id="projectbrief">C++11 Libraries for leveraging VeriBlock Proof-Of-Proof blockchain technology.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('integration_8_merkle.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Pop Merkle trees </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md71">Overview</a></li>
<li class="level1"><a href="#autotoc_md72">1. VeriBlock Merkle root related functions are implemented in the merkle.hpp and merkle.cpp.</a></li>
<li class="level1"><a href="#autotoc_md73">2. Use extended block weight calculation method that appends Pop data size.</a></li>
<li class="level1"><a href="#autotoc_md74">3. Extend ValidationState class for better veriblock-pop-cpp error processing.</a></li>
<li class="level1"><a href="#autotoc_md75">4. Update the mining process with Pop Merkle root calculation.</a></li>
<li class="level1"><a href="#autotoc_md76">5. Since Pop Merkle root algorithm depends on the blockchain, we should move Merkle root validation from the CheckBlock() to the ContextualCheckBlock().</a></li>
<li class="level1"><a href="#autotoc_md77">6. Add helper genesis_common.cpp file that allows Genesis block generation.</a></li>
<li class="level1"><a href="#autotoc_md78">7. Add new tests: block_validation_tests.cpp, vbk_merkle_tests.cpp.</a></li>
<li class="level1"><a href="#autotoc_md79">8. Add Pop Merkle trees code to the makefile.</a></li>
<li class="level1"><a href="#autotoc_md80">9. Update makefile to run tests.</a></li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_families_btc_integration_8_merkle"></a></p>
<h1><a class="anchor" id="autotoc_md71"></a>
Overview</h1>
<p >Altchain developers must ensure PopData is cryptographically authenticated in Block Header.</p>
<p >Regular transactions are typically cryptographically authenticated by inserting Merkle Root into Block Header, we will call it Original Merkle Root.</p>
<p >Merkle Root which is inserted into Block Header is now called <b>Top Level Merkle Root</b>.</p>
<div class="image">
<img src="toplevelmroot.png" alt=""/>
</div>
    <p ><b>Algorithm to calculate Top Level Merkle Root</b>:</p><ol type="1">
<li>Build Merkle Tree from individual items of PopData (those are VBK blocks, marked as VBK1 on the picture, VTBs and ATVs), resulting Merkle Root is called <b>Pop Root</b>.</li>
<li>Insert PopRoot into vector of leaves and calculate <b>Tx Merkle Root</b></li>
<li><p class="startli">Calculate <code>ContextHash = HASH(BlockHeightBE || PreviousKeystoneHash || SecondPreviousKeystoneHash)</code></p>
<p class="startli">where</p><ul>
<li><code>BlockHeightBE</code> is 4 bytes of block height, serialized in Big-Endian</li>
<li><code>PreviousKeystoneHash</code> is a hash of a Previous Keystone Block. Its height can be calculated with altintegration::getPreviousKeystone(int, int)</li>
</ul>
</li>
<li>Calculate <code>TopLevelMerkleRoot = HASH(TxMerkleRoot || ContextHash)</code></li>
</ol>
<h1><a class="anchor" id="autotoc_md72"></a>
1. VeriBlock Merkle root related functions are implemented in the merkle.hpp and merkle.cpp.</h1>
<p >Pop Merkle trees header: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/merkle.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/merkle.hpp</a>. Copy this file to your project.</p>
<p >Pop Merkle trees source: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/merkle.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/merkle.cpp</a>. Copy this file to your project.</p>
<dl class="section note"><dt>Note</dt><dd>Merkle Root calculation should fall back to the original Merkle Root if Pop protocol is not activated.</dd></dl>
<h1><a class="anchor" id="autotoc_md73"></a>
2. Use extended block weight calculation method that appends Pop data size.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/consensus/validation.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/consensus/validation.h</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;primitives/block.h&gt;</span></div>
<div class="line"> </div>
<div class="line">+#include &lt;vbk/util.hpp&gt;</div>
<div class="line">+#include &lt;veriblock/pop.hpp&gt;</div>
</div><!-- fragment --> <div class="fragment"><div class="line"> <span class="keyword">static</span> <span class="keyword">inline</span> int64_t GetBlockWeight(<span class="keyword">const</span> CBlock&amp; block)</div>
<div class="line"> {</div>
<div class="line">-    return ::GetSerializeSize(block, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) * (WITNESS_SCALE_FACTOR - 1) + ::GetSerializeSize(block, PROTOCOL_VERSION);</div>
<div class="line">+    int64_t popDataSize = 0;</div>
<div class="line">+    popDataSize += VeriBlock::GetPopDataWeight(block.popData);</div>
<div class="line">+</div>
<div class="line">+    return ::GetSerializeSize(block, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) * (WITNESS_SCALE_FACTOR - 1) + ::GetSerializeSize(block, PROTOCOL_VERSION) - popDataSize;</div>
<div class="line"> }</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md74"></a>
3. Extend ValidationState class for better veriblock-pop-cpp error processing.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/consensus/validation.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/consensus/validation.h</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/consensus/validation.h#L83">class ValidationState</a> </p><div class="fragment"><div class="line">     std::string GetDebugMessage()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_debug_message; }</div>
<div class="line">+    std::string ToString()<span class="keyword"> const </span>{<span class="keywordflow">return</span> m_reject_reason + <span class="stringliteral">&quot;: &quot;</span> + m_debug_message; }</div>
<div class="line">+</div>
<div class="line">+    <span class="keyword">operator</span> <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a>() {</div>
<div class="line">+        <a class="code hl_class" href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a> v;</div>
<div class="line">+        <span class="keywordflow">if</span>(IsInvalid()) {</div>
<div class="line">+            v.Invalid(m_reject_reason, m_debug_message);</div>
<div class="line">+            <span class="keywordflow">return</span> v;</div>
<div class="line">+        }</div>
<div class="line">+</div>
<div class="line">+        <span class="keywordflow">if</span>(IsError()) {</div>
<div class="line">+            v.Invalid(m_reject_reason);</div>
<div class="line">+            <span class="keywordflow">return</span> v;</div>
<div class="line">+        }</div>
<div class="line">+</div>
<div class="line">+        <span class="keywordflow">return</span> v;</div>
<div class="line">+    }</div>
<div class="ttc" id="aclassaltintegration_1_1ValidationState_html"><div class="ttname"><a href="classaltintegration_1_1ValidationState.html">altintegration::ValidationState</a></div><div class="ttdoc">Class that is used for storing validation state.</div><div class="ttdef"><b>Definition:</b> <a href="validation__state_8hpp_source.html#l00028">validation_state.hpp:28</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md75"></a>
4. Update the mining process with Pop Merkle root calculation.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/miner.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/miner.cpp</a> </p><div class="fragment"><div class="line">+#include &lt;vbk/merkle.hpp&gt;</div>
<div class="line"><span class="preprocessor"> #include &lt;vbk/pop_service.hpp&gt;</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/miner.cpp#L446">method IncrementExtraNonce</a> </p><div class="fragment"><div class="line">     pblock-&gt;vtx[0] = MakeTransactionRef(std::move(txCoinbase));</div>
<div class="line">-    pblock-&gt;hashMerkleRoot = BlockMerkleRoot(*pblock);</div>
<div class="line">+</div>
<div class="line">+    pblock-&gt;hashMerkleRoot = VeriBlock::TopLevelMerkleRoot(pindexPrev, *pblock);</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/mining.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/mining.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/test/util/mining.cpp#L41">method PrepareBlock</a> </p><div class="fragment"><div class="line">     block-&gt;nTime = ::ChainActive().Tip()-&gt;GetMedianTimePast() + 1;</div>
<div class="line">-    block-&gt;hashMerkleRoot = BlockMerkleRoot(*block);</div>
<div class="line">+</div>
<div class="line">+    CBlockIndex* tip = ::ChainActive().Tip();</div>
<div class="line">+    assert(tip != <span class="keyword">nullptr</span>);</div>
<div class="line">+    block-&gt;hashMerkleRoot = VeriBlock::TopLevelMerkleRoot(tip, *block);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md76"></a>
5. Since Pop Merkle root algorithm depends on the blockchain, we should move Merkle root validation from the CheckBlock() to the ContextualCheckBlock().</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.h">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.h</a> </p><div class="fragment"><div class="line"> </div>
<div class="line">-<span class="keywordtype">bool</span> CheckBlock(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state, <span class="keyword">const</span> Consensus::Params&amp; consensusParams, <span class="keywordtype">bool</span> fCheckPOW = <span class="keyword">true</span>, <span class="keywordtype">bool</span> fCheckMerkleRoot = <span class="keyword">true</span>);</div>
<div class="line">+<span class="keywordtype">bool</span> CheckBlock(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state, <span class="keyword">const</span> Consensus::Params&amp; consensusParams, <span class="keywordtype">bool</span> fCheckPOW = <span class="keyword">true</span>);</div>
<div class="line">+</div>
<div class="line">+</div>
<div class="line">+<span class="keywordtype">bool</span> ContextualCheckBlock(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state, <span class="keyword">const</span> Consensus::Params&amp; consensusParams, <span class="keyword">const</span> CBlockIndex* pindexPrev, <span class="keywordtype">bool</span> fCheckMerkleRoot = <span class="keyword">true</span>);</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L1879">method CChainState::ConnectBlock</a> </p><div class="fragment"><div class="line">     <span class="comment">// is enforced in ContextualCheckBlockHeader(); we wouldn&#39;t want to</span></div>
<div class="line">     <span class="comment">// re-enforce that rule here (at least until we make it impossible for</span></div>
<div class="line">     <span class="comment">// GetAdjustedTime() to go backward).</span></div>
<div class="line">-    <span class="keywordflow">if</span> (!CheckBlock(block, state, chainparams.GetConsensus(), !fJustCheck, !fJustCheck)) {</div>
<div class="line">+</div>
<div class="line">+    <span class="comment">//VeriBlock : added ContextualCheckBlock() here becuse merkleRoot calculation  moved from the CheckBlock() to the ContextualCheckBlock()</span></div>
<div class="line">+</div>
<div class="line">+    <span class="keywordflow">if</span> (!CheckBlock(block, state, chainparams.GetConsensus(), !fJustCheck) &amp;&amp; !ContextualCheckBlock(block, state, chainparams.GetConsensus(), pindex-&gt;pprev, <span class="keyword">true</span>)) {</div>
</div><!-- fragment --> <div class="fragment"><div class="line">-<span class="keywordtype">bool</span> CheckBlock(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state, <span class="keyword">const</span> Consensus::Params&amp; consensusParams, <span class="keywordtype">bool</span> fCheckPOW, <span class="keywordtype">bool</span> fCheckMerkleRoot)</div>
<div class="line">+<span class="keywordtype">bool</span> CheckBlock(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state, <span class="keyword">const</span> Consensus::Params&amp; consensusParams, <span class="keywordtype">bool</span> fCheckPOW)</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3376">method CheckBlock</a> </p><div class="fragment"><div class="line">     <span class="keywordflow">if</span> (!CheckBlockHeader(block, state, consensusParams, fCheckPOW))</div>
<div class="line">         <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">-    <span class="comment">// Check the merkle root.</span></div>
<div class="line">-    <span class="keywordflow">if</span> (fCheckMerkleRoot) {</div>
<div class="line">-        <span class="keywordtype">bool</span> mutated;</div>
<div class="line">-        uint256 hashMerkleRoot2 = BlockMerkleRoot(block, &amp;mutated);</div>
<div class="line">-        <span class="keywordflow">if</span> (block.hashMerkleRoot != hashMerkleRoot2)</div>
<div class="line">-            <span class="keywordflow">return</span> state.Invalid(BlockValidationResult::BLOCK_MUTATED, <span class="stringliteral">&quot;bad-txnmrklroot&quot;</span>, <span class="stringliteral">&quot;hashMerkleRoot mismatch&quot;</span>);</div>
<div class="line">-</div>
<div class="line">-        <span class="comment">// Check for merkle tree malleability (CVE-2012-2459): repeating sequences</span></div>
<div class="line">-        <span class="comment">// of transactions in a block without affecting the merkle root of a block,</span></div>
<div class="line">-        <span class="comment">// while still invalidating it.</span></div>
<div class="line">-        <span class="keywordflow">if</span> (mutated)</div>
<div class="line">-            <span class="keywordflow">return</span> state.Invalid(BlockValidationResult::BLOCK_MUTATED, <span class="stringliteral">&quot;bad-txns-duplicate&quot;</span>, <span class="stringliteral">&quot;duplicate transaction&quot;</span>);</div>
<div class="line">+    <span class="comment">// VeriBlock: merkle root verification currently depends on a context, so it has been moved to ContextualCheckBlock</span></div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3376">method CheckBlock</a> </p><div class="fragment"><div class="line">     <span class="keywordflow">if</span> (nSigOps * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_SIGOPS_COST)</div>
<div class="line">         <span class="keywordflow">return</span> state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, <span class="stringliteral">&quot;bad-blk-sigops&quot;</span>, <span class="stringliteral">&quot;out-of-bounds SigOpCount&quot;</span>);</div>
<div class="line"> </div>
<div class="line">-    <span class="keywordflow">if</span> (fCheckPOW &amp;&amp; fCheckMerkleRoot)</div>
<div class="line">+    <span class="keywordflow">if</span> (fCheckPOW)</div>
<div class="line">         block.fChecked = <span class="keyword">true</span>;</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3376">method CheckBlock</a> </p><div class="fragment"><div class="line">     <span class="comment">// Size limits</span></div>
<div class="line">-    <span class="keywordflow">if</span> (block.vtx.empty() || block.vtx.size() * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_WEIGHT || ::GetSerializeSize(block, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS) * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_WEIGHT)</div>
<div class="line">+    <span class="keywordflow">if</span> (block.vtx.empty() || block.vtx.size() * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_WEIGHT || GetBlockWeight(block) &gt; MAX_BLOCK_WEIGHT)</div>
</div><!-- fragment --> <div class="fragment"><div class="line">-</div>
<div class="line">-<span class="keyword">static</span> <span class="keywordtype">bool</span> ContextualCheckBlock(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state, <span class="keyword">const</span> Consensus::Params&amp; consensusParams, <span class="keyword">const</span> CBlockIndex* pindexPrev)</div>
<div class="line">+<span class="keywordtype">bool</span> ContextualCheckBlock(<span class="keyword">const</span> CBlock&amp; block, BlockValidationState&amp; state, <span class="keyword">const</span> Consensus::Params&amp; consensusParams, <span class="keyword">const</span> CBlockIndex* pindexPrev, <span class="keywordtype">bool</span> fCheckMerkleRoot)</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3574">method ContextualCheckBlock</a> </p><div class="fragment"><div class="line">-    int64_t nLockTimeCutoff = (nLockTimeFlags &amp; LOCKTIME_MEDIAN_TIME_PAST)</div>
<div class="line">-                              ? pindexPrev-&gt;GetMedianTimePast()</div>
<div class="line">-                              : block.GetBlockTime();</div>
<div class="line">+    <span class="comment">// VeriBlock: merkle tree verification is moved from CheckBlock here, because it requires correct CBlockIndex</span></div>
<div class="line">+    <span class="keywordflow">if</span> (fCheckMerkleRoot &amp;&amp; !VeriBlock::VerifyTopLevelMerkleRoot(block, pindexPrev, state)) {</div>
<div class="line">+        <span class="comment">// state is already set with error message</span></div>
<div class="line">+        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">+    }</div>
<div class="line">+</div>
<div class="line">+    int64_t nLockTimeCutoff = (nLockTimeFlags &amp; LOCKTIME_MEDIAN_TIME_PAST) ? pindexPrev-&gt;GetMedianTimePast() : block.GetBlockTime();</div>
</div><!-- fragment --><p> <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/validation.cpp#L3919">method TestBlockValidity</a> </p><div class="fragment"><div class="line">     <span class="keywordflow">if</span> (!ContextualCheckBlockHeader(block, state, chainparams, pindexPrev, GetAdjustedTime()))</div>
<div class="line">         <span class="keywordflow">return</span> error(<span class="stringliteral">&quot;%s: Consensus::ContextualCheckBlockHeader: %s&quot;</span>, __func__, FormatStateMessage(state));</div>
<div class="line">-    <span class="keywordflow">if</span> (!CheckBlock(block, state, chainparams.GetConsensus(), fCheckPOW, fCheckMerkleRoot))</div>
<div class="line">+    <span class="keywordflow">if</span> (!CheckBlock(block, state, chainparams.GetConsensus(), fCheckPOW))</div>
<div class="line">         <span class="keywordflow">return</span> error(<span class="stringliteral">&quot;%s: Consensus::CheckBlock: %s&quot;</span>, __func__, FormatStateMessage(state));</div>
<div class="line">-    <span class="keywordflow">if</span> (!ContextualCheckBlock(block, state, chainparams.GetConsensus(), pindexPrev))</div>
<div class="line">-        <span class="keywordflow">return</span> error(<span class="stringliteral">&quot;%s: Consensus::ContextualCheckBlock: %s&quot;</span>, __func__, FormatStateMessage(state));</div>
<div class="line">+    <span class="keywordflow">if</span> (!ContextualCheckBlock(block, state, chainparams.GetConsensus(), pindexPrev, fCheckMerkleRoot))</div>
<div class="line">+        <span class="keywordflow">return</span> error(<span class="stringliteral">&quot;%s: Consensus::ContextualCheckBlock: %s&quot;</span>, __func__, state.GetRejectReason());</div>
</div><!-- fragment --><p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bench/duplicate_inputs.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bench/duplicate_inputs.cpp</a></p>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/bench/duplicate_inputs.cpp#L17">method DuplicateInputs</a> </p><div class="fragment"><div class="line">         BlockValidationState cvstate{};</div>
<div class="line">-        assert(!CheckBlock(block, cvstate, chainparams.GetConsensus(), <span class="keyword">false</span>, <span class="keyword">false</span>));</div>
<div class="line">+        assert(!CheckBlock(block, cvstate, chainparams.GetConsensus(), <span class="keyword">false</span>));</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md77"></a>
6. Add helper genesis_common.cpp file that allows Genesis block generation.</h1>
<p >Genesis block generation header: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/genesis_common.hpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/genesis_common.hpp</a>. Copy this file to your project.</p>
<p >Genesis block generation source: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/genesis_common.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/genesis_common.cpp</a>. Copy this file to your project.</p>
<h1><a class="anchor" id="autotoc_md78"></a>
7. Add new tests: block_validation_tests.cpp, vbk_merkle_tests.cpp.</h1>
<p >Block validation test: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/unit/block_validation_tests.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/unit/block_validation_tests.cpp</a>. Copy this file to your project.</p>
<p >Pop Merkle Root validation test: <a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/unit/vbk_merkle_tests.cpp">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/vbk/test/unit/vbk_merkle_tests.cpp</a>. Copy this file to your project.</p>
<h1><a class="anchor" id="autotoc_md79"></a>
8. Add Pop Merkle trees code to the makefile.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.am">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.am</a> </p><div class="fragment"><div class="line">libbitcoin_common_a_SOURCES = \</div>
<div class="line">   script/sign.cpp \</div>
<div class="line">   script/signingprovider.cpp \</div>
<div class="line">   script/standard.cpp \</div>
<div class="line">+  vbk/genesis_common.hpp \</div>
<div class="line">+  vbk/genesis_common.cpp \</div>
<div class="line">+  vbk/merkle.hpp \</div>
<div class="line">+  vbk/merkle.cpp \</div>
<div class="line">   versionbitsinfo.cpp \</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md80"></a>
9. Update makefile to run tests.</h1>
<p ><a href="https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.test.include">https://github.com/VeriBlock/vbk-ri-btc/blob/master/src/Makefile.test.include</a> </p><div class="fragment"><div class="line"><span class="preprocessor"> ### VeriBlock section start</span></div>
<div class="line"><span class="preprocessor"> # path is relative to src</span></div>
<div class="line"> VBK_TESTS = \</div>
<div class="line">   vbk/test/unit/e2e_poptx_tests.cpp \</div>
<div class="line">+  vbk/test/unit/block_validation_tests.cpp \</div>
<div class="line">+  vbk/test/unit/vbk_merkle_tests.cpp</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<script>
    $(document).ready(function(){
        $('.line').each(function(){
            var t = $(this).html()
            if(t.startsWith("+")) {
                $(this).addClass('diff-plus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>+</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            } else if (t.startsWith("-")) {
                $(this).addClass('diff-minus')
                $(this).html(t.slice(1))
                $(this).prepend(
                    $('<div>-</div>')
                        .addClass('noselect')
                        .addClass('sign')
                )
            }
        })
    });
</script>
